# 安装与部署

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [Dockerfile.backend](file://Dockerfile.backend)
- [docker-compose.yml](file://docker-compose.yml)
- [scripts/setup-docker.py](file://scripts/setup-docker.py)
- [scripts/docker-init.sh](file://scripts/docker-init.sh)
- [nginx/nginx.conf](file://nginx/nginx.conf)
- [scripts/install_and_run.py](file://scripts/install_and_run.py)
</cite>

## 目录
1. [简介](#简介)
2. [Docker部署](#docker部署)
3. [源码安装](#源码安装)
4. [Windows便携版安装](#windows便携版安装)
5. [反向代理与SSL配置](#反向代理与ssl配置)
6. [部署场景最佳实践](#部署场景最佳实践)
7. [常见问题排查](#常见问题排查)

## 简介

sagacity系统提供多种部署方式，包括Docker部署、源码安装和Windows便携版。系统采用FastAPI + Vue 3的前后端分离架构，支持A股、港股、美股的股票分析与研究。本指南将详细介绍各种部署方式的完整流程。

**Section sources**
- [README.md](file://README.md#L1-L318)

## Docker部署

### 镜像拉取与构建

Docker部署是推荐的生产环境部署方式。系统提供完整的Docker Compose配置，支持多架构（amd64和arm64）。

1. **拉取镜像**：
```bash
docker-compose pull
```

2. **构建镜像**：
```bash
docker-compose build
```

Dockerfile.backend文件定义了后端服务的构建过程，包括安装系统依赖（pandoc、wkhtmltopdf）、Python依赖和复制应用代码。

### 容器编排

docker-compose.yml文件定义了完整的容器编排，包括以下服务：

- **backend**: FastAPI后端服务，暴露8000端口
- **frontend**: Vue 3前端服务，暴露3000端口
- **mongodb**: MongoDB数据库服务，暴露27017端口
- **redis**: Redis缓存服务，暴露6379端口
- **redis-commander**: Redis管理界面（可选）
- **mongo-express**: MongoDB管理界面（可选）

### 网络配置

系统使用自定义的bridge网络`tradingagents-network`，确保服务间的通信。各服务通过服务名称进行内部通信，如后端服务通过`mongodb`和`redis`访问数据库和缓存服务。

### 卷挂载

Docker部署通过卷挂载实现数据持久化：

- `./logs:/app/logs`: 日志目录
- `./config:/app/config`: 配置目录
- `./data:/app/data`: 数据目录
- `mongodb_data`: MongoDB数据卷
- `redis_data`: Redis数据卷

### 初始化流程

使用scripts/docker-init.sh脚本进行环境初始化：

1. 检查并创建.env文件
2. 创建必需的目录结构
3. 停止现有容器
4. 拉取最新镜像
5. 构建自定义镜像
6. 启动数据库服务
7. 初始化数据库
8. 启动应用服务

```bash
chmod +x scripts/docker-init.sh
./scripts/docker-init.sh
```

**Section sources**
- [Dockerfile.backend](file://Dockerfile.backend#L1-L89)
- [docker-compose.yml](file://docker-compose.yml#L1-L209)
- [scripts/docker-init.sh](file://scripts/docker-init.sh#L1-L216)

## 源码安装

### 依赖安装

1. **Python环境**：需要Python 3.10+版本
2. **虚拟环境**：建议使用虚拟环境
```bash
python -m venv env
source env/bin/activate  # Linux/macOS
# 或
env\Scripts\activate     # Windows
```

3. **安装项目依赖**：
```bash
pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
pip install -e .
```

### 环境配置

1. **配置文件**：复制.env.example为.env
```bash
cp .env.example .env
```

2. **必需配置**：
- `DEEPSEEK_API_KEY`: DeepSeek API密钥
- `JWT_SECRET`: JWT密钥
- `TUSHARE_TOKEN`: Tushare令牌

3. **数据库配置**：
- `MONGODB_ENABLED=true`
- `REDIS_ENABLED=true`

### 启动命令

使用scripts/install_and_run.py脚本进行一键安装和启动：

```bash
python scripts/install_and_run.py
```

该脚本会：
1. 检查虚拟环境
2. 安装项目依赖
3. 安装Web界面依赖
4. 检查并创建.env文件
5. 启动Web应用

**Section sources**
- [scripts/install_and_run.py](file://scripts/install_and_run.py#L1-L162)
- [README.md](file://README.md#L73-L82)

## Windows便携版安装

Windows便携版提供绿色安装，无需复杂的环境配置。

### 安装步骤

1. 下载Windows便携版压缩包
2. 解压到任意目录
3. 运行`start.bat`启动服务
4. 访问`http://localhost:8501`

### 特殊说明

1. **端口配置**：默认使用8501端口，可在配置文件中修改
2. **数据目录**：所有数据存储在程序目录下的`data`文件夹中
3. **备份与恢复**：直接复制整个程序目录即可完成备份

### 启动脚本

Windows便携版使用批处理脚本进行启动，包含环境检查、依赖安装和应用启动的完整流程。

**Section sources**
- [README.md](file://README.md#L79-L80)

## 反向代理与SSL配置

### Nginx配置

系统提供nginx/nginx.conf文件作为反向代理配置示例：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### SSL配置

1. **获取SSL证书**：使用Let's Encrypt或其他CA机构
2. **配置Nginx**：
```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    
    location / {
        proxy_pass http://localhost:3000;
        # ... 其他配置
    }
}
```

3. **HTTP重定向到HTTPS**：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

**Section sources**
- [nginx/nginx.conf](file://nginx/nginx.conf)

## 部署场景最佳实践

### 开发环境

1. **使用源码安装**：便于代码调试和修改
2. **启用详细日志**：设置`TRADINGAGENTS_LOG_LEVEL=DEBUG`
3. **禁用生产优化**：关闭缓存和压缩
4. **使用本地数据库**：避免影响生产数据

### 测试环境

1. **使用Docker部署**：确保环境一致性
2. **独立数据库**：使用独立的MongoDB实例
3. **模拟数据**：使用测试数据集
4. **监控配置**：启用性能监控和日志分析

### 生产环境

1. **Docker部署**：确保稳定性和可维护性
2. **数据备份**：定期备份MongoDB和Redis数据
3. **安全配置**：
   - 使用SSL加密通信
   - 配置防火墙规则
   - 定期更新系统和依赖
4. **高可用性**：
   - 配置负载均衡
   - 设置服务健康检查
   - 实现自动故障转移

**Section sources**
- [README.md](file://README.md#L75-L82)
- [docker-compose.yml](file://docker-compose.yml#L1-L209)

## 常见问题排查

### 端口冲突

**症状**：服务无法启动，提示端口已被占用

**解决方案**：
1. 检查端口占用情况：
```bash
netstat -an | grep 8000
# 或
lsof -i :8000
```

2. 修改docker-compose.yml中的端口映射：
```yaml
ports:
  - "8001:8000"  # 将8000映射到8001
```

3. 重启Docker服务

### 权限问题

**症状**：无法写入日志或数据目录

**解决方案**：
1. 检查目录权限：
```bash
ls -la logs/ data/
```

2. 修复权限：
```bash
chmod -R 755 logs data config
chown -R $USER:$USER logs data config
```

3. 在Docker中确保用户ID匹配

### 网络连接故障

**症状**：服务间无法通信

**解决方案**：
1. 检查Docker网络：
```bash
docker network ls
docker network inspect tradingagents-network
```

2. 测试服务间连接：
```bash
docker-compose exec backend ping mongodb
docker-compose exec backend curl http://redis:6379
```

3. 检查防火墙设置

### 数据库连接问题

**症状**：应用无法连接MongoDB或Redis

**解决方案**：
1. 检查数据库服务状态：
```bash
docker-compose ps
```

2. 检查环境变量：
```bash
docker-compose exec backend env | grep MONGODB
docker-compose exec backend env | grep REDIS
```

3. 手动测试连接：
```bash
# 测试MongoDB
docker-compose exec mongodb mongo --eval "db.adminCommand('ping')"

# 测试Redis
docker-compose exec redis redis-cli ping
```

**Section sources**
- [scripts/docker-init.sh](file://scripts/docker-init.sh#L98-L133)
- [docker-compose.yml](file://docker-compose.yml#L95-L144)