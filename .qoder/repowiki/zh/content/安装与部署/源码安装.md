# 源码安装

<cite>
**本文档引用的文件**   
- [README.md](file://README.md)
- [requirements.txt](file://requirements.txt)
- [pyproject.toml](file://pyproject.toml)
- [app/main.py](file://app/main.py)
- [app/core/config.py](file://app/core/config.py)
- [app/core/database.py](file://app/core/database.py)
- [app/routers/health.py](file://app/routers/health.py)
- [frontend/package.json](file://frontend/package.json)
- [docker-compose.yml](file://docker-compose.yml)
- [Dockerfile.backend](file://Dockerfile.backend)
- [scripts/docker-init.sh](file://scripts/docker-init.sh)
- [scripts/smart_start.sh](file://scripts/smart_start.sh)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [依赖安装](#依赖安装)
4. [环境配置](#环境配置)
5. [数据库与缓存初始化](#数据库与缓存初始化)
6. [后端服务启动](#后端服务启动)
7. [前端应用启动](#前端应用启动)
8. [开发模式与生产模式配置](#开发模式与生产模式配置)
9. [系统初始化与验证](#系统初始化与验证)
10. [跨平台注意事项](#跨平台注意事项)
11. [常见问题解决方案](#常见问题解决方案)

## 简介

sagacity系统是一个面向中文用户的多智能体与大模型股票分析学习平台，基于FastAPI和Vue 3构建。本安装文档将指导用户从源代码构建和运行该系统，涵盖从环境配置到系统验证的完整流程。

该系统采用现代化的技术栈，包括FastAPI作为后端框架、Vue 3作为前端框架，以及MongoDB和Redis作为数据存储。系统支持A股、港股和美股的分析，提供企业级的性能和用户体验。

**Section sources**
- [README.md](file://README.md#L1-L318)

## 项目结构

sagacity系统的项目结构清晰，分为多个功能模块：

- **app/**: FastAPI后端应用，包含核心逻辑、路由、服务和模型
- **frontend/**: Vue 3前端应用，包含组件、页面和静态资源
- **config/**: 配置文件，包括日志配置等
- **docker/**: Docker相关配置文件
- **docs/**: 详细的文档和指南
- **examples/**: 使用示例代码
- **scripts/**: 各种脚本工具，包括部署、维护和开发辅助脚本
- **tests/**: 测试代码
- **tradingagents/**: 交易代理相关模块
- **utils/**: 实用工具脚本
- **web/**: Web相关组件

系统采用前后端分离架构，后端提供RESTful API，前端通过API与后端交互。

**Section sources**
- [README.md](file://README.md#L1-L318)

## 依赖安装

### Python环境配置

系统要求Python 3.10或更高版本。建议使用虚拟环境来隔离项目依赖。

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Linux/macOS
source venv/bin/activate
# Windows
venv\Scripts\activate
```

### 包管理工具使用

项目推荐使用`pip`或`uv`作为包管理工具。项目提供了`pyproject.toml`文件，这是现代Python项目的标准配置。

```bash
# 使用pip安装
pip install -e .

# 或使用uv（推荐）
uv pip install -e .
```

### 第三方库安装

系统依赖多个第三方库，主要分为以下几类：

- **后端框架**: FastAPI, Uvicorn
- **数据库**: Motor (异步MongoDB驱动), PyMongo, Redis
- **AI和LLM**: LangChain, OpenAI, Google GenAI, DashScope
- **数据处理**: Pandas, AkShare, Tushare, BaoStock
- **前端框架**: Vue 3, Element Plus
- **文档生成**: Markdown, PyPandoc, PDFKit

所有依赖都已在`pyproject.toml`文件中定义，安装时会自动处理。

**Section sources**
- [requirements.txt](file://requirements.txt#L1-L58)
- [pyproject.toml](file://pyproject.toml#L1-L99)

## 环境配置

### 配置文件

系统使用`.env`文件进行环境配置。首次安装时，需要从`.env.example`复制并修改配置文件。

```bash
cp .env.example .env
```

关键配置项包括：

- **API配置**: HOST, PORT, DEBUG
- **数据库配置**: MONGODB_HOST, MONGODB_PORT, REDIS_HOST, REDIS_PORT
- **认证配置**: JWT_SECRET, ACCESS_TOKEN_EXPIRE_MINUTES
- **数据源配置**: TUSHARE_TOKEN, DEEPSEEK_API_KEY
- **代理配置**: HTTP_PROXY, HTTPS_PROXY, NO_PROXY

### 配置优先级

系统采用多层级配置机制，配置优先级从高到低为：

1. 环境变量
2. `.env`文件
3. 代码中的默认值

这种设计使得系统可以在不同环境中灵活配置。

**Section sources**
- [app/core/config.py](file://app/core/config.py#L1-L301)
- [README.md](file://README.md#L1-L318)

## 数据库与缓存初始化

### MongoDB配置

系统使用MongoDB作为主要数据库，存储用户数据、分析结果和系统配置。在`app/core/config.py`中定义了MongoDB的连接配置：

```python
MONGODB_HOST: str = Field(default="localhost")
MONGODB_PORT: int = Field(default=27017)
MONGODB_DATABASE: str = Field(default="tradingagents")
```

### Redis配置

Redis用于缓存、队列和实时通知。配置如下：

```python
REDIS_HOST: str = Field(default="localhost")
REDIS_PORT: int = Field(default=6379)
REDIS_DB: int = Field(default=0)
```

### 初始化脚本

系统提供了`scripts/docker-init.sh`脚本用于初始化数据库和缓存服务。该脚本会：

1. 检查并创建必需的目录
2. 停止现有容器
3. 拉取最新镜像
4. 构建自定义镜像
5. 启动数据库服务
6. 等待数据库就绪
7. 初始化数据库
8. 启动应用服务

**Section sources**
- [app/core/database.py](file://app/core/database.py#L1-L443)
- [app/core/redis_client.py](file://app/core/redis_client.py#L1-L203)
- [scripts/docker-init.sh](file://scripts/docker-init.sh#L1-L216)

## 后端服务启动

### 启动方法

后端服务基于FastAPI框架，可以通过以下方式启动：

```bash
# 开发模式启动
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 生产模式启动
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 主应用入口

`app/main.py`是后端服务的主入口文件，负责：

- 创建FastAPI应用实例
- 配置中间件（CORS、日志、认证等）
- 注册路由
- 管理应用生命周期（通过lifespan上下文管理器）

在应用启动时，会执行以下初始化操作：
- 设置日志
- 验证启动配置
- 初始化数据库连接
- 配置动态设置（日志级别、监控等）
- 启动定时任务调度器

### 路由注册

系统注册了多个路由模块，包括：
- 健康检查
- 认证
- 分析
- 筛选
- 队列
- 自选股
- 股票数据
- 配置管理
- 报告生成

**Section sources**
- [app/main.py](file://app/main.py#L1-L764)

## 前端应用启动

### 前端技术栈

前端应用基于Vue 3 + Vite + Element Plus构建，使用TypeScript开发。

### 启动方法

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 开发模式启动
npm run dev

# 构建生产版本
npm run build

# 预览生产版本
npm run preview
```

### 环境配置

前端通过`VITE_API_BASE_URL`环境变量配置后端API地址。在`.env`文件中设置：

```
VITE_API_BASE_URL=http://localhost:8000
```

### 依赖管理

前端依赖在`package.json`中定义，主要包括：
- Vue 3核心框架
- Element Plus UI组件库
- Axios HTTP客户端
- ECharts数据可视化
- Pinia状态管理
- Vue Router路由管理

**Section sources**
- [frontend/package.json](file://frontend/package.json#L1-L60)

## 开发模式与生产模式配置

### 开发模式

开发模式下，系统启用以下特性：
- 代码热重载
- 详细的API文档（Swagger UI）
- 更宽松的CORS策略
- 详细的日志输出

在`app/main.py`中，通过`DEBUG`配置项控制开发模式：

```python
app = FastAPI(
    docs_url="/docs" if settings.DEBUG else None,
    redoc_url="/redoc" if settings.DEBUG else None,
    lifespan=lifespan
)
```

### 生产模式

生产模式下，系统启用以下优化：
- 禁用API文档
- 严格的CORS策略
- 错误信息隐藏
- 性能优化

通过设置`.env`文件中的`DEBUG=false`来启用生产模式。

### Docker部署

系统提供了完整的Docker支持，通过`docker-compose.yml`文件定义了服务编排：

- backend: FastAPI后端服务
- frontend: Vue前端服务
- mongodb: MongoDB数据库
- redis: Redis缓存
- redis-commander: Redis管理界面（可选）
- mongo-express: MongoDB管理界面（可选）

使用以下命令启动Docker环境：

```bash
# 初始化并启动
./scripts/docker-init.sh

# 或使用智能启动脚本
./scripts/smart_start.sh
```

**Section sources**
- [app/main.py](file://app/main.py#L604-L611)
- [docker-compose.yml](file://docker-compose.yml#L1-L209)
- [scripts/docker-init.sh](file://scripts/docker-init.sh#L1-L216)
- [scripts/smart_start.sh](file://scripts/smart_start.sh#L1-L34)

## 系统初始化与验证

### 初始化步骤

1. **创建必要目录**:
   ```bash
   mkdir -p logs data/cache data/exports data/reports data/progress config
   ```

2. **初始化数据库**:
   系统会在启动时自动创建必要的数据库视图和索引。

3. **启动定时任务**:
   系统使用APScheduler启动各种定时任务，包括：
   - 股票基础信息同步
   - 实时行情入库
   - 财务数据同步
   - 新闻数据同步

### 健康检查API

系统提供了健康检查API用于验证安装是否成功：

```python
@router.get("/health")
async def health():
    return {
        "success": True,
        "data": {
            "status": "ok",
            "version": get_version(),
            "timestamp": int(time.time()),
            "service": "TradingAgents-CN API"
        },
        "message": "服务运行正常"
    }
```

可以通过以下命令验证服务状态：

```bash
curl http://localhost:8000/api/health
```

预期返回：
```json
{
    "success": true,
    "data": {
        "status": "ok",
        "version": "1.0.0-preview",
        "timestamp": 1732500000,
        "service": "TradingAgents-CN API"
    },
    "message": "服务运行正常"
}
```

### 验证流程

1. 检查后端服务是否正常运行
2. 检查前端服务是否可访问
3. 验证数据库连接
4. 测试API调用
5. 检查定时任务是否正常执行

**Section sources**
- [app/routers/health.py](file://app/routers/health.py#L1-L41)
- [app/main.py](file://app/main.py#L215-L601)

## 跨平台注意事项

### Windows系统

在Windows系统上安装时需要注意：
- 路径分隔符使用反斜杠`\`
- 权限管理与Linux不同
- 可能需要以管理员权限运行某些命令
- PowerShell脚本的执行策略可能需要调整

### Linux系统

Linux系统是推荐的部署环境，具有最佳兼容性。注意事项包括：
- 确保有足够的磁盘空间
- 配置适当的文件权限
- 确保防火墙允许必要的端口通信

### macOS系统

macOS系统基于Unix，与Linux类似，但需要注意：
- Apple Silicon (M1/M2)芯片使用ARM64架构
- 可能需要安装额外的开发工具
- 系统完整性保护(SIP)可能影响某些操作

### Docker多架构支持

系统支持跨平台部署，通过Docker实现了对amd64和arm64架构的支持。`Dockerfile.backend`中包含了架构检测逻辑：

```dockerfile
ARG TARGETARCH
...
if [ "$TARGETARCH" = "arm64" ]; then \
    PANDOC_ARCH="arm64"; \
    WKHTMLTOPDF_ARCH="arm64"; \
else \
    PANDOC_ARCH="amd64"; \
    WKHTMLTOPDF_ARCH="amd64"; \
fi
```

这使得系统可以在x86_64和ARM64架构上无缝运行。

**Section sources**
- [Dockerfile.backend](file://Dockerfile.backend#L1-L89)
- [README.md](file://README.md#L1-L318)

## 常见问题解决方案

### 依赖安装问题

**问题**: 安装依赖时出现网络超时或包下载失败
**解决方案**: 
- 使用国内镜像源
- 重试安装命令
- 检查网络连接和代理设置

### 数据库连接问题

**问题**: 无法连接MongoDB或Redis
**解决方案**:
- 检查服务是否已启动
- 验证连接配置（主机、端口、认证信息）
- 检查防火墙设置
- 查看服务日志获取详细错误信息

### API调用问题

**问题**: API返回500错误或无法访问
**解决方案**:
- 检查后端服务是否正常运行
- 验证路由配置
- 检查中间件配置
- 查看日志文件定位具体错误

### 性能问题

**问题**: 系统响应缓慢
**解决方案**:
- 检查数据库索引是否完整
- 优化查询语句
- 增加缓存
- 监控系统资源使用情况

### 配置问题

**问题**: 配置不生效
**解决方案**:
- 检查配置文件格式是否正确
- 验证环境变量优先级
- 重启服务使配置生效
- 使用配置验证工具检查配置完整性

**Section sources**
- [README.md](file://README.md#L1-L318)
- [app/core/config.py](file://app/core/config.py#L1-L301)