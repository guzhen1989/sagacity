# å›¾ç»“æ„å®šåˆ¶

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**   
- [trading_graph.py](file://tradingagents/graph/trading_graph.py)
- [setup.py](file://tradingagents/graph/setup.py)
- [conditional_logic.py](file://tradingagents/graph/conditional_logic.py)
- [agent_utils.py](file://tradingagents/agents/utils/agent_utils.py)
- [propagation.py](file://tradingagents/graph/propagation.py)
- [signal_processing.py](file://tradingagents/graph/signal_processing.py)
- [reflection.py](file://tradingagents/graph/reflection.py)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)
2. [å›¾ç»“æ„æ ¸å¿ƒç»„ä»¶](#å›¾ç»“æ„æ ¸å¿ƒç»„ä»¶)
3. [èŠ‚ç‚¹å®šä¹‰ä¸è¾¹è¿æ¥æœºåˆ¶](#èŠ‚ç‚¹å®šä¹‰ä¸è¾¹è¿æ¥æœºåˆ¶)
4. [ä¿¡å·ä¼ æ’­ä¸æ¡ä»¶é€»è¾‘](#ä¿¡å·ä¼ æ’­ä¸æ¡ä»¶é€»è¾‘)
5. [è‡ªå®šä¹‰åˆ†ææµç¨‹é…ç½®](#è‡ªå®šä¹‰åˆ†ææµç¨‹é…ç½®)
6. [å¤æ‚åˆ†æå·¥ä½œæµæ„å»º](#å¤æ‚åˆ†æå·¥ä½œæµæ„å»º)
7. [å›¾ç»“æ„éªŒè¯ä¸è°ƒè¯•](#å›¾ç»“æ„éªŒè¯ä¸è°ƒè¯•)
8. [æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ](#æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ)

## å¼•è¨€
æœ¬æ–‡æ¡£è¯¦ç»†é˜è¿°äº†å¤šæ™ºèƒ½ä½“å†³ç­–å›¾ç³»ç»Ÿçš„å›¾ç»“æ„å®šåˆ¶æ–¹æ³•ã€‚ç³»ç»ŸåŸºäºLangGraphæ¡†æ¶æ„å»ºï¼Œé€šè¿‡`trading_graph.py`ä¸­çš„`TradingAgentsGraph`ç±»åè°ƒå¤šä¸ªæ™ºèƒ½ä½“çš„å·¥ä½œæµç¨‹ã€‚å›¾ç»“æ„ç”±`setup.py`ä¸­çš„`GraphSetup`ç±»è´Ÿè´£é…ç½®ï¼Œæ”¯æŒçµæ´»çš„èŠ‚ç‚¹å®šä¹‰ã€è¾¹è¿æ¥å’Œä¿¡å·ä¼ æ’­æœºåˆ¶ã€‚é€šè¿‡`agent_utils.py`ä¸­çš„å·¥å…·è°ƒç”¨æœºåˆ¶ç¡®ä¿æ™ºèƒ½ä½“é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œå¹¶é€šè¿‡`conditional_logic.py`å®ç°å¤æ‚çš„æ¡ä»¶åˆ¤æ–­é€»è¾‘ã€‚

## å›¾ç»“æ„æ ¸å¿ƒç»„ä»¶

ç³»ç»Ÿå›¾ç»“æ„ç”±å¤šä¸ªæ ¸å¿ƒç»„ä»¶æ„æˆï¼ŒåŒ…æ‹¬èŠ‚ç‚¹å®šä¹‰ã€è¾¹è¿æ¥ã€çŠ¶æ€ä¼ æ’­å’Œä¿¡å·å¤„ç†ç­‰æœºåˆ¶ã€‚`TradingAgentsGraph`ç±»ä½œä¸ºä¸»åè°ƒå™¨ï¼Œåˆå§‹åŒ–æ‰€æœ‰å¿…è¦çš„ç»„ä»¶å¹¶æ„å»ºå®Œæ•´çš„å†³ç­–æµç¨‹ã€‚`GraphSetup`ç±»è´Ÿè´£å…·ä½“çš„å›¾ç»“æ„é…ç½®ï¼Œ`Propagator`ç±»å¤„ç†çŠ¶æ€åˆå§‹åŒ–å’Œä¼ æ’­ï¼Œ`SignalProcessor`ç±»è´Ÿè´£ä¿¡å·å¤„ç†ï¼Œ`Reflector`ç±»å¤„ç†å†³ç­–åæ€ã€‚

**Section sources**
- [trading_graph.py](file://tradingagents/graph/trading_graph.py#L193-L800)
- [setup.py](file://tradingagents/graph/setup.py#L19-L254)
- [propagation.py](file://tradingagents/graph/propagation.py#L15-L69)
- [signal_processing.py](file://tradingagents/graph/signal_processing.py#L11-L337)
- [reflection.py](file://tradingagents/graph/reflection.py#L11-L126)

## èŠ‚ç‚¹å®šä¹‰ä¸è¾¹è¿æ¥æœºåˆ¶

å›¾ç»“æ„ä¸­çš„èŠ‚ç‚¹å®šä¹‰å’Œè¾¹è¿æ¥æœºåˆ¶æ˜¯ç³»ç»Ÿçµæ´»æ€§çš„åŸºç¡€ã€‚èŠ‚ç‚¹é€šè¿‡`GraphSetup`ç±»çš„`setup_graph`æ–¹æ³•åˆ›å»ºï¼Œæ”¯æŒå¤šç§åˆ†æå¸ˆç±»å‹ï¼ˆå¸‚åœºã€ç¤¾äº¤ã€æ–°é—»ã€åŸºæœ¬é¢ï¼‰çš„åŠ¨æ€ç»„åˆã€‚

```mermaid
graph TD
START[å¼€å§‹] --> MarketAnalyst[å¸‚åœºåˆ†æå¸ˆ]
START --> SocialAnalyst[ç¤¾äº¤åˆ†æå¸ˆ]
START --> NewsAnalyst[æ–°é—»åˆ†æå¸ˆ]
START --> FundamentalsAnalyst[åŸºæœ¬é¢åˆ†æå¸ˆ]
MarketAnalyst --> MarketTools[å¸‚åœºå·¥å…·èŠ‚ç‚¹]
SocialAnalyst --> SocialTools[ç¤¾äº¤å·¥å…·èŠ‚ç‚¹]
NewsAnalyst --> NewsTools[æ–°é—»å·¥å…·èŠ‚ç‚¹]
FundamentalsAnalyst --> FundamentalsTools[åŸºæœ¬é¢å·¥å…·èŠ‚ç‚¹]
MarketTools --> MarketAnalyst
SocialTools --> SocialAnalyst
NewsTools --> NewsAnalyst
FundamentalsTools --> FundamentalsAnalyst
MarketAnalyst --> BullResearcher[å¤šå¤´ç ”ç©¶å‘˜]
SocialAnalyst --> BullResearcher
NewsAnalyst --> BullResearcher
FundamentalsAnalyst --> BullResearcher
BullResearcher --> BearResearcher[ç©ºå¤´ç ”ç©¶å‘˜]
BearResearcher --> ResearchManager[ç ”ç©¶ç»ç†]
BullResearcher --> ResearchManager
ResearchManager --> Trader[äº¤æ˜“å‘˜]
Trader --> RiskyAnalyst[æ¿€è¿›åˆ†æå¸ˆ]
RiskyAnalyst --> SafeAnalyst[ä¿å®ˆåˆ†æå¸ˆ]
SafeAnalyst --> NeutralAnalyst[ä¸­ç«‹åˆ†æå¸ˆ]
NeutralAnalyst --> RiskJudge[é£é™©è£åˆ¤]
RiskyAnalyst --> RiskJudge
SafeAnalyst --> RiskJudge
RiskJudge --> END[ç»“æŸ]
```

**Diagram sources**
- [setup.py](file://tradingagents/graph/setup.py#L51-L254)
- [conditional_logic.py](file://tradingagents/graph/conditional_logic.py#L18-L243)

**Section sources**
- [setup.py](file://tradingagents/graph/setup.py#L51-L254)
- [conditional_logic.py](file://tradingagents/graph/conditional_logic.py#L18-L243)

## ä¿¡å·ä¼ æ’­ä¸æ¡ä»¶é€»è¾‘

ä¿¡å·ä¼ æ’­æœºåˆ¶é€šè¿‡`conditional_logic.py`ä¸­çš„`ConditionalLogic`ç±»å®ç°ï¼Œè¯¥ç±»å®šä¹‰äº†å›¾ä¸­å„ä¸ªèŠ‚ç‚¹çš„æ¡ä»¶åˆ¤æ–­é€»è¾‘ã€‚æ¯ä¸ªåˆ†æå¸ˆèŠ‚ç‚¹éƒ½æœ‰å¯¹åº”çš„æ¡ä»¶åˆ¤æ–­æ–¹æ³•ï¼Œå¦‚`should_continue_market`ã€`should_continue_social`ç­‰ï¼Œè¿™äº›æ–¹æ³•å†³å®šäº†æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·èŠ‚ç‚¹æˆ–ç»§ç»­åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

```mermaid
graph TD
MarketAnalyst[å¸‚åœºåˆ†æå¸ˆ] --> CheckMarket[æ£€æŸ¥å¸‚åœºåˆ†æ]
CheckMarket --> |æœ‰å·¥å…·è°ƒç”¨| MarketTools[å¸‚åœºå·¥å…·èŠ‚ç‚¹]
CheckMarket --> |æ— å·¥å…·è°ƒç”¨| ClearMarket[æ¸…é™¤æ¶ˆæ¯]
MarketTools --> MarketAnalyst
ClearMarket --> BullResearcher[å¤šå¤´ç ”ç©¶å‘˜]
BullResearcher --> CheckDebate[æ£€æŸ¥è¾©è®ºçŠ¶æ€]
CheckDebate --> |æœªå®Œæˆ| BearResearcher[ç©ºå¤´ç ”ç©¶å‘˜]
CheckDebate --> |å·²å®Œæˆ| ResearchManager[ç ”ç©¶ç»ç†]
BearResearcher --> CheckDebate
RiskyAnalyst[æ¿€è¿›åˆ†æå¸ˆ] --> CheckRisk[æ£€æŸ¥é£é™©åˆ†æ]
CheckRisk --> |æœªå®Œæˆ| SafeAnalyst[ä¿å®ˆåˆ†æå¸ˆ]
CheckRisk --> |å·²å®Œæˆ| RiskJudge[é£é™©è£åˆ¤]
```

**Diagram sources**
- [conditional_logic.py](file://tradingagents/graph/conditional_logic.py#L18-L243)
- [setup.py](file://tradingagents/graph/setup.py#L181-L254)

**Section sources**
- [conditional_logic.py](file://tradingagents/graph/conditional_logic.py#L18-L243)
- [setup.py](file://tradingagents/graph/setup.py#L181-L254)

## è‡ªå®šä¹‰åˆ†ææµç¨‹é…ç½®

é€šè¿‡`setup.py`ä¸­çš„`GraphSetup`ç±»å¯ä»¥é…ç½®è‡ªå®šä¹‰çš„åˆ†ææµç¨‹ã€‚`setup_graph`æ–¹æ³•æ¥å—`selected_analysts`å‚æ•°ï¼Œå…è®¸ç”¨æˆ·é€‰æ‹©éœ€è¦åŒ…å«çš„åˆ†æå¸ˆç±»å‹ï¼Œä»è€Œæ„å»ºä¸åŒçš„åˆ†æå·¥ä½œæµã€‚

```python
def setup_graph(self, selected_analysts=["market", "social", "news", "fundamentals"]):
    """è®¾ç½®å’Œç¼–è¯‘ä»£ç†å·¥ä½œæµå›¾ã€‚
    
    Args:
        selected_analysts (list): è¦åŒ…å«çš„åˆ†æå¸ˆç±»å‹åˆ—è¡¨ã€‚é€‰é¡¹åŒ…æ‹¬ï¼š
            - "market": å¸‚åœºåˆ†æå¸ˆ
            - "social": ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ  
            - "news": æ–°é—»åˆ†æå¸ˆ
            - "fundamentals": åŸºæœ¬é¢åˆ†æå¸ˆ
    """
```

**Section sources**
- [setup.py](file://tradingagents/graph/setup.py#L51-L254)

## å¤æ‚åˆ†æå·¥ä½œæµæ„å»º

ç³»ç»Ÿæ”¯æŒæ„å»ºå¤æ‚çš„åˆ†æå·¥ä½œæµï¼Œå¦‚ç ”ç©¶å‘˜-åˆ†æå¸ˆ-äº¤æ˜“å‘˜åä½œé“¾ã€‚è¿™ç§å·¥ä½œæµé€šè¿‡å¤šä¸ªèŠ‚ç‚¹çš„ä¸²è”å’Œæ¡ä»¶åˆ¤æ–­å®ç°ï¼Œç¡®ä¿åˆ†æè¿‡ç¨‹çš„å®Œæ•´æ€§å’Œé€»è¾‘æ€§ã€‚

```mermaid
sequenceDiagram
participant ç ”ç©¶å‘˜ as ç ”ç©¶å‘˜
participant åˆ†æå¸ˆ as åˆ†æå¸ˆ
participant äº¤æ˜“å‘˜ as äº¤æ˜“å‘˜
participant é£é™©ç®¡ç† as é£é™©ç®¡ç†
ç ”ç©¶å‘˜->>åˆ†æå¸ˆ : å‘é€ç ”ç©¶è¯·æ±‚
åˆ†æå¸ˆ->>åˆ†æå¸ˆ : æ‰§è¡Œå¸‚åœºåˆ†æ
åˆ†æå¸ˆ->>åˆ†æå¸ˆ : æ‰§è¡ŒåŸºæœ¬é¢åˆ†æ
åˆ†æå¸ˆ->>åˆ†æå¸ˆ : æ‰§è¡Œæ–°é—»åˆ†æ
åˆ†æå¸ˆ->>ç ”ç©¶å‘˜ : è¿”å›ç»¼åˆåˆ†ææŠ¥å‘Š
ç ”ç©¶å‘˜->>äº¤æ˜“å‘˜ : å‘é€äº¤æ˜“å»ºè®®
äº¤æ˜“å‘˜->>é£é™©ç®¡ç† : è¯·æ±‚é£é™©è¯„ä¼°
é£é™©ç®¡ç†->>äº¤æ˜“å‘˜ : è¿”å›é£é™©è¯„ä¼°æŠ¥å‘Š
äº¤æ˜“å‘˜->>ç ”ç©¶å‘˜ : ç¡®è®¤äº¤æ˜“å†³ç­–
```

**Diagram sources**
- [setup.py](file://tradingagents/graph/setup.py#L140-L158)
- [trading_graph.py](file://tradingagents/graph/trading_graph.py#L193-L800)

**Section sources**
- [setup.py](file://tradingagents/graph/setup.py#L140-L158)
- [trading_graph.py](file://tradingagents/graph/trading_graph.py#L193-L800)

## å›¾ç»“æ„éªŒè¯ä¸è°ƒè¯•

ç³»ç»Ÿæä¾›äº†å®Œå–„çš„å›¾ç»“æ„éªŒè¯å’Œè°ƒè¯•æœºåˆ¶ã€‚é€šè¿‡æ—¥å¿—ç³»ç»Ÿå¯ä»¥è¿½è¸ªæ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡ŒçŠ¶æ€å’Œæ¡ä»¶åˆ¤æ–­ç»“æœï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚

```python
def should_continue_market(self, state: AgentState):
    """ç¡®å®šå¸‚åœºåˆ†ææ˜¯å¦åº”ç»§ç»­ã€‚"""
    messages = state["messages"]
    last_message = messages[-1]
    
    # æ­»å¾ªç¯ä¿®å¤: æ·»åŠ å·¥å…·è°ƒç”¨æ¬¡æ•°æ£€æŸ¥
    tool_call_count = state.get("market_tool_call_count", 0)
    max_tool_calls = 3
    
    # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å¸‚åœºåˆ†ææŠ¥å‘Š
    market_report = state.get("market_report", "")
    
    logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] should_continue_market")
    logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] - æ¶ˆæ¯æ•°é‡: {len(messages)}")
    logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] - æŠ¥å‘Šé•¿åº¦: {len(market_report)}")
    logger.info(f"ğŸ”§ [æ­»å¾ªç¯ä¿®å¤] - å·¥å…·è°ƒç”¨æ¬¡æ•°: {tool_call_count}/{max_tool_calls}")
```

**Section sources**
- [conditional_logic.py](file://tradingagents/graph/conditional_logic.py#L18-L62)
- [trading_graph.py](file://tradingagents/graph/trading_graph.py#L779-L786)

## æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

ä¸ºäº†ç¡®ä¿ç³»ç»Ÿçš„é«˜æ€§èƒ½å’Œç¨³å®šæ€§ï¼Œå»ºè®®éµå¾ªä»¥ä¸‹æœ€ä½³å®è·µï¼š

1. **çŠ¶æ€æœ€å°åŒ–**: åªåœ¨çŠ¶æ€ä¸­ä¿å­˜å¿…è¦çš„ä¿¡æ¯ï¼Œé¿å…çŠ¶æ€è¿‡å¤§å½±å“æ€§èƒ½ã€‚
2. **èŠ‚ç‚¹å•ä¸€èŒè´£**: æ¯ä¸ªèŠ‚ç‚¹åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šçš„ä»»åŠ¡ï¼Œç¡®ä¿èŠ‚ç‚¹çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚
3. **é”™è¯¯å¤„ç†**: æ¯ä¸ªèŠ‚ç‚¹éƒ½åº”è¯¥æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹èƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†ã€‚
4. **æ—¥å¿—è®°å½•**: é€šè¿‡è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œå¯ä»¥å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€‚

**Section sources**
- [trading_graph.py](file://tradingagents/graph/trading_graph.py#L774-L776)
- [setup.py](file://tradingagents/graph/setup.py#L250-L253)
- [conditional_logic.py](file://tradingagents/graph/conditional_logic.py#L18-L243)