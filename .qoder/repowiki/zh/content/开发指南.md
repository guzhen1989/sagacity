# 开发指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [CONTRIBUTORS.md](file://CONTRIBUTORS.md)
- [requirements.txt](file://requirements.txt)
- [pyproject.toml](file://pyproject.toml)
- [main.py](file://main.py)
- [QUICK_START.md](file://docs/QUICK_START.md)
- [BUILD_GUIDE.md](file://docs/BUILD_GUIDE.md)
- [test_environment_setup.md](file://docs/test_environment_setup.md)
- [pytest.ini](file://tests/pytest.ini)
- [config/README.md](file://config/README.md)
</cite>

## 目录
1. [简介](#简介)
2. [开发环境搭建](#开发环境搭建)
3. [分支管理与代码提交](#分支管理与代码提交)
4. [代码风格指南](#代码风格指南)
5. [测试策略](#测试策略)
6. [功能开发与Bug修复流程](#功能开发与bug修复流程)
7. [调试技巧与性能分析](#调试技巧与性能分析)
8. [贡献者支持](#贡献者支持)

## 简介

本开发指南为sagacity项目贡献者提供完整的开发指导。项目是一个面向中文用户的多智能体与大模型股票分析学习平台，基于FastAPI + Vue 3架构构建，支持A股、港股、美股的分析与教学。项目采用混合许可证模式，其中`app/`和`frontend/`目录为专有部分，需要商业授权，其余文件采用Apache 2.0开源协议。

项目核心功能包括用户权限管理、配置管理中心、缓存管理系统、实时通知系统、批量分析功能、智能股票筛选、自选股管理、个股详情页、模拟交易系统等。技术栈包括FastAPI后端、Vue 3前端、MongoDB + Redis双数据库架构，支持Docker多架构部署。

**Section sources**
- [README.md](file://README.md#L1-L318)

## 开发环境搭建

### 代码克隆

首先克隆项目代码库：

```bash
git clone https://github.com/hsliuping/TradingAgents-CN.git
cd TradingAgents-CN
```

### 依赖安装

项目提供多种安装方式，推荐使用Docker方式以确保环境一致性。

#### Docker安装（推荐）

```bash
# 启动服务
docker-compose up -d

# 访问应用
# 前端: http://localhost:3000
# 后端API: http://localhost:8000
# API文档: http://localhost:8000/docs
```

#### 本地代码安装

```bash
# 创建虚拟环境
python -m venv env

# 激活虚拟环境
# Windows: env\Scripts\activate
# macOS/Linux: source env/bin/activate

# 安装依赖
pip install -e .

# 或使用uv
uv pip install -e .
```

### 本地配置

#### 配置API密钥

复制示例配置文件并编辑：

```bash
cp .env.example .env
# 编辑.env文件，添加您的API密钥
```

推荐配置至少一个AI模型提供商：

- **DeepSeek**：在`.env`文件中设置`DEEPSEEK_API_KEY`
- **通义千问**：在`.env`文件中设置`DASHSCOPE_API_KEY`
- **OpenAI**：在`.env`文件中设置`OPENAI_API_KEY`

可选配置数据源：

- **Tushare**：在`.env`文件中设置`TUSHARE_TOKEN`

#### 配置文件说明

`config/`目录用于存储系统配置和使用统计数据：

- `usage.json` - Token使用统计数据（自动生成）
- `models.json` - 模型配置文件（自动生成）
- `pricing.json` - 定价配置文件（自动生成）
- `settings.json` - 系统设置文件（自动生成）

**重要提示**：此目录已在Docker Compose中配置为卷挂载，确保容器重启后配置不会丢失。建议定期备份`usage.json`和`settings.json`文件。

**Section sources**
- [QUICK_START.md](file://docs/QUICK_START.md#L1-L188)
- [config/README.md](file://config/README.md#L1-L29)
- [pyproject.toml](file://pyproject.toml#L1-L99)
- [requirements.txt](file://requirements.txt#L1-L58)

## 分支管理与代码提交

### 分支策略

项目采用Git Flow分支管理策略：

- `main`：主分支，用于生产环境，受保护
- `develop`：开发分支，集成所有功能开发
- `feature/*`：功能分支，开发新功能
- `bugfix/*`：修复分支，修复生产环境问题
- `release/*`：发布分支，准备版本发布

### 贡献流程

1. Fork本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建Pull Request

### 代码提交规范

- 提交信息应清晰描述更改内容
- 功能添加使用`feat:`前缀
- Bug修复使用`fix:`前缀
- 代码重构使用`refactor:`前缀
- 文档更新使用`docs:`前缀
- 性能优化使用`perf:`前缀

### 质量保证

1. **自动化测试** - 每个PR都要通过CI测试
2. **代码覆盖率** - 保持80%以上的测试覆盖率
3. **性能测试** - 重要功能要进行性能测试
4. **安全扫描** - 定期进行安全漏洞扫描
5. **文档更新** - 功能变更同步更新文档

**Section sources**
- [CONTRIBUTORS.md](file://CONTRIBUTORS.md#L1-L154)
- [docs/development/branch-strategy.md](file://docs/development/branch-strategy.md#L532-L541)

## 代码风格指南

### Python编码标准

项目遵循PEP 8编码规范，主要要求包括：

- 使用4个空格缩进
- 行长度不超过88个字符
- 使用双引号表示字符串
- 函数和变量使用小写下划线命名法
- 类名使用驼峰命名法
- 导入语句按标准顺序分组

### TypeScript编码标准

前端代码遵循TypeScript最佳实践：

- 使用接口定义数据结构
- 类型安全优先
- 使用ES6+语法特性
- 模块化组织代码
- 使用async/await处理异步操作

### 代码质量工具

项目使用以下工具确保代码质量：

- **pylint**：Python代码静态分析
- **black**：Python代码格式化
- **isort**：Python导入排序
- **ESLint**：TypeScript代码检查
- **Prettier**：代码格式化

### 代码组织原则

- 按功能模块组织代码
- 保持单一职责原则
- 高内聚低耦合
- 清晰的依赖关系
- 充分的文档注释

**Section sources**
- [CONTRIBUTORS.md](file://CONTRIBUTORS.md#L1-L154)

## 测试策略

### 单元测试

项目使用pytest框架进行单元测试，测试文件位于`tests/`目录。

#### 测试配置

`pytest.ini`配置文件定义了测试参数：

```ini
[pytest]
testpaths = tests
addopts = -m "not integration" -k "not (test_server_config or test_stock_codes)"
markers =
    integration: 标记集成/端到端测试（默认跳过）
```

#### 编写单元测试

单元测试应遵循以下原则：

- 测试单一功能点
- 使用mock隔离外部依赖
- 覆盖正常和异常情况
- 保持测试独立性
- 提供清晰的断言信息

### 集成测试

集成测试验证多个组件协同工作，标记为`integration`，默认跳过。

#### 运行集成测试

```bash
# 运行所有测试，包括集成测试
pytest -m "integration"

# 运行特定测试文件
pytest tests/test_integration.py
```

### 测试环境

项目提供独立的测试环境，不影响生产数据。

#### 测试环境特点

- 使用独立的数据卷（`tradingagents_test_*`）
- 独立的日志目录（`logs-test/`）
- 独立的配置目录（`config-test/`）
- 独立的数据目录（`data-test/`）

#### 环境切换

```powershell
# 切换到测试环境
.\scripts\switch_to_test_env.ps1

# 切换回生产环境
.\scripts\switch_to_prod_env.ps1

# 清理测试环境
.\scripts\cleanup_test_env.ps1
```

### 测试场景

#### 从零部署测试

验证新用户首次部署体验：
1. 切换到测试环境
2. 注册新用户
3. 配置数据源
4. 启用数据同步
5. 测试核心功能

#### 受限环境测试

验证在缺少某些API时的表现：
1. 不配置Tushare Token
2. 只启用AKShare数据源
3. 测试系统运行情况

#### 配置错误测试

验证错误配置的处理：
1. 配置错误的Tushare Token
2. 观察系统行为和错误提示

**Section sources**
- [test_environment_setup.md](file://docs/test_environment_setup.md#L1-L351)
- [pytest.ini](file://tests/pytest.ini#L1-L12)

## 功能开发与Bug修复流程

### 设计评审

新功能开发前应进行设计评审，包括：

1. **需求分析**：明确功能目标和用户场景
2. **架构设计**：确定技术方案和组件关系
3. **接口定义**：设计API接口和数据结构
4. **风险评估**：识别潜在问题和应对方案
5. **评审会议**：团队讨论并确认设计方案

### 代码实现

#### 创建功能分支

```bash
git checkout -b feature/new-analysis-module
```

#### 实现步骤

1. 实现核心功能逻辑
2. 添加必要的类型注解
3. 编写清晰的函数文档
4. 确保代码可测试性
5. 添加适当的日志记录

### 测试验证

#### 单元测试验证

确保新功能有相应的单元测试覆盖：

```python
def test_new_analysis_feature():
    # 测试正常情况
    result = analyze_stock("000001")
    assert result is not None
    
    # 测试异常情况
    with pytest.raises(ValueError):
        analyze_stock("invalid_code")
```

#### 集成测试验证

验证新功能与其他组件的集成：

```python
def test_analysis_with_database():
    # 测试与数据库的集成
    result = analyze_with_db("000001")
    assert result.saved_to_db
```

#### 手动测试

1. 在本地环境部署
2. 使用真实数据测试
3. 验证用户界面
4. 检查日志输出
5. 确认性能表现

### Bug修复流程

1. **问题复现**：确认Bug的可复现性
2. **根因分析**：定位问题根本原因
3. **修复实现**：编写修复代码
4. **测试验证**：确保修复有效且无副作用
5. **回归测试**：确保不影响其他功能

**Section sources**
- [CONTRIBUTORS.md](file://CONTRIBUTORS.md#L1-L154)
- [test_environment_setup.md](file://docs/test_environment_setup.md#L1-L351)

## 调试技巧与性能分析

### 调试工具

#### 日志调试

项目使用结构化日志，可通过以下方式查看：

```bash
# 查看后端日志
docker logs -f tradingagents-backend

# 查看特定级别的日志
docker logs tradingagents-backend | grep "ERROR"

# 实时查看日志
tail -f logs/tradingagents.log
```

#### 断点调试

使用Python调试器进行断点调试：

```python
import pdb; pdb.set_trace()
# 或使用更现代的
import breakpoint; breakpoint()
```

#### 远程调试

配置IDE进行远程调试，支持热重载和实时修改。

### 性能分析工具

#### CPU性能分析

使用cProfile分析CPU性能：

```python
import cProfile
import pstats

def profile_analysis():
    profiler = cProfile.Profile()
    profiler.enable()
    
    # 执行分析代码
    analyze_stock("000001")
    
    profiler.disable()
    stats = pstats.Stats(profiler)
    stats.sort_stats('cumulative')
    stats.print_stats(10)
```

#### 内存分析

使用memory_profiler监控内存使用：

```python
from memory_profiler import profile

@profile
def analyze_with_memory():
    # 内存密集型操作
    data = load_large_dataset()
    result = process_data(data)
    return result
```

#### 数据库性能

监控MongoDB和Redis性能：

```bash
# MongoDB监控
docker exec -it tradingagents-mongodb mongostat

# Redis监控
docker exec -it tradingagents-redis redis-cli info memory
```

### 常见问题排查

#### 启动失败

1. 检查Python版本是否为3.10+
2. 确认API密钥配置正确
3. 检查网络连接
4. 验证端口是否被占用

#### 分析失败

1. 验证API密钥有效性
2. 检查API余额
3. 确认股票代码格式正确
4. 测试网络连通性

#### 性能问题

1. 检查数据库连接
2. 监控内存使用
3. 分析慢查询
4. 优化缓存策略

**Section sources**
- [test_environment_setup.md](file://docs/test_environment_setup.md#L1-L351)
- [QUICK_START.md](file://docs/QUICK_START.md#L1-L188)

## 贡献者支持

### 贡献类型

我们欢迎各种形式的贡献：

- **Bug修复** - 发现并修复问题
- **新功能** - 添加新的功能特性
- **文档改进** - 完善文档和教程
- **本地化** - 翻译和本地化工作
- **代码优化** - 性能优化和代码重构

### 贡献者名单

感谢所有为项目做出贡献的开发者和用户：

- **[@breeze303](https://github.com/breeze303)**：提供完整的Docker Compose配置和容器化部署方案
- **[@baiyuxiong](https://github.com/baiyuxiong)**：设计并实现了完整的多格式报告导出系统
- **[@charliecai](https://github.com/charliecai)**：添加硅基流动(SiliconFlow) LLM提供商支持
- **[@yifanhere](https://github.com/yifanhere)**：修复关键Bug和CLI代码质量改进

### 联系方式

如果您想成为贡献者或有任何问题，请通过以下方式联系我们：

- **GitHub Issues**: [提交问题或建议](https://github.com/hsliuping/TradingAgents-CN/issues)
- **GitHub Discussions**: [参与社区讨论](https://github.com/hsliuping/TradingAgents-CN/discussions)
- **Pull Requests**: [提交代码贡献](https://github.com/hsliuping/TradingAgents-CN/pulls)
- 加入到ＱＱ群：782124367

**Section sources**
- [CONTRIBUTORS.md](file://CONTRIBUTORS.md#L1-L154)
- [README.md](file://README.md#L1-L318)