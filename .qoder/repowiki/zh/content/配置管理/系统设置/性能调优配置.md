# 性能调优配置

<cite>
**本文档引用文件**   
- [config.py](file://app/core/config.py)
- [rate_limiter.py](file://app/core/rate_limiter.py)
- [redis_client.py](file://app/core/redis_client.py)
- [database.py](file://app/core/database.py)
- [queue_service.py](file://app/services/queue_service.py)
- [rate_limit.py](file://app/middleware/rate_limit.py)
</cite>

## 目录
1. [并发处理配置](#并发处理配置)
2. [速率限制器配置](#速率限制器配置)
3. [缓存策略配置](#缓存策略配置)
4. [数据库连接池配置](#数据库连接池配置)
5. [内存与垃圾回收配置](#内存与垃圾回收配置)

## 并发处理配置

系统通过队列服务实现并发任务处理，支持用户级和全局并发限制。配置参数包括线程池大小、异步任务队列容量和批量处理的最大数量。

- **用户并发限制**：通过 `DEFAULT_USER_CONCURRENT_LIMIT` 配置，默认值为3，表示每个用户最多同时处理3个任务。
- **全局并发限制**：通过 `GLOBAL_CONCURRENT_LIMIT` 配置，默认值为50，表示系统最多同时处理50个任务。
- **队列大小**：通过 `QUEUE_MAX_SIZE` 配置，默认值为10000，表示任务队列的最大容量。
- **可见性超时**：通过 `QUEUE_VISIBILITY_TIMEOUT` 配置，默认值为300秒（5分钟），表示任务被取出后在指定时间内未完成则重新入队。

这些配置确保系统在高并发场景下稳定运行，避免资源耗尽。

**Section sources**
- [config.py](file://app/core/config.py#L91-L93)
- [queue_service.py](file://app/services/queue_service.py#L50-L52)

## 速率限制器配置

系统实现了基于滑动窗口算法的速率限制器，用于控制API调用频率，防止对数据源造成过大压力。

### Tushare速率限制器

Tushare数据源根据用户积分等级设置不同的速率限制：

- **免费用户**：100次/分钟
- **基础用户**：200次/分钟
- **标准用户**：400次/分钟
- **高级用户**：600次/分钟
- **VIP用户**：800次/分钟

通过 `TUSHARE_RATE_LIMIT_SAFETY_MARGIN` 配置安全边际，默认值为0.8，实际限制为理论限制的80%，以避免达到上限。

### 其他数据源速率限制器

- **AKShare**：默认60次/分钟
- **BaoStock**：默认100次/分钟

系统还实现了基于Redis的用户级速率限制中间件，不同API端点有不同的限制：

- 单股分析：每分钟10次
- 批量分析：每分钟5次
- 股票筛选：每分钟20次
- 登录：每分钟5次
- 注册：每分钟3次

**Section sources**
- [rate_limiter.py](file://app/core/rate_limiter.py#L108-L114)
- [rate_limit.py](file://app/middleware/rate_limit.py#L23-L29)

## 缓存策略配置

系统采用多级缓存策略，包括Redis缓存和本地文件缓存，以提高数据访问速度和系统性能。

### Redis连接池配置

- **最大连接数**：通过 `REDIS_MAX_CONNECTIONS` 配置，默认值为20
- **连接超时**：通过 `socket_connect_timeout` 配置，设置为5秒
- **套接字超时**：通过 `socket_timeout` 配置，设置为10秒
- **TCP Keepalive**：启用TCP保活机制，60秒后开始发送探测，每10秒发送一次，最多发送3次

### 缓存过期时间设置

- **通用缓存TTL**：通过 `CACHE_TTL` 配置，默认值为3600秒（1小时）
- **筛选缓存TTL**：通过 `SCREENING_CACHE_TTL` 配置，默认值为1800秒（30分钟）
- **港股数据缓存**：通过 `HK_DATA_CACHE_HOURS` 配置，默认值为24小时
- **美股数据缓存**：通过 `US_DATA_CACHE_HOURS` 配置，默认值为24小时

系统支持自动清理过期缓存，可通过调用清理接口清空所有缓存。

**Section sources**
- [redis_client.py](file://app/core/redis_client.py#L25-L33)
- [config.py](file://app/core/config.py#L120-L122)

## 数据库连接池配置

系统使用MongoDB和Redis作为主要数据存储，通过连接池管理数据库连接。

### MongoDB连接池配置

- **最大连接数**：通过 `MONGO_MAX_CONNECTIONS` 配置，默认值为100
- **最小连接数**：通过 `MONGO_MIN_CONNECTIONS` 配置，默认值为10
- **连接超时**：通过 `MONGO_CONNECT_TIMEOUT_MS` 配置，默认值为30000毫秒（30秒）
- **套接字超时**：通过 `MONGO_SOCKET_TIMEOUT_MS` 配置，默认值为60000毫秒（60秒）
- **服务器选择超时**：通过 `MONGO_SERVER_SELECTION_TIMEOUT_MS` 配置，默认值为5000毫秒（5秒）

### 查询超时时间优化

系统在数据库查询中设置了合理的超时时间，避免长时间等待导致资源占用。对于大量历史数据的处理，适当延长了超时时间以确保查询能够完成。

**Section sources**
- [database.py](file://app/core/database.py#L48-L55)
- [config.py](file://app/core/config.py#L37-L42)

## 内存与垃圾回收配置

系统通过内存状态管理器监控任务执行情况，并提供垃圾回收相关的配置选项。

### 内存使用监控

- **僵尸任务清理**：系统定期检查运行时间超过2小时的任务，将其标记为失败，防止内存泄漏。
- **任务统计**：提供任务状态统计功能，包括待处理、处理中、已完成和失败的任务数量。

### 垃圾回收配置

- **连接池健康检查**：Redis连接池每30秒检查一次连接健康状态，自动关闭不健康的连接。
- **TCP Keepalive**：启用TCP保活机制，防止长时间空闲的连接被意外关闭。
- **自动过期**：Redis缓存使用TTL机制自动过期，无需手动清理。

根据硬件资源调整这些参数可以获得最佳性能。例如，在内存充足的服务器上可以适当增加连接池大小，在网络不稳定的环境中可以适当延长超时时间。

**Section sources**
- [memory_state_manager.py](file://app/services/memory_state_manager.py#L375-L390)
- [redis_client.py](file://app/core/redis_client.py#L34-L35)