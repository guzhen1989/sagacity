# 系统设置

<cite>
**本文档引用的文件**   
- [config.py](file://app/core/config.py)
- [unified_config.py](file://app/core/unified_config.py)
- [dev_config.py](file://app/core/dev_config.py)
- [logging.toml](file://config/logging.toml)
- [logging_docker.toml](file://config/logging_docker.toml)
- [logging_config.py](file://app/core/logging_config.py)
- [timezone.py](file://app/utils/timezone.py)
- [trading_time.py](file://app/utils/trading_time.py)
- [config_service.py](file://app/services/config_service.py)
- [system_config.py](file://app/routers/system_config.py)
- [websocket_notifications.py](file://app/routers/websocket_notifications.py)
</cite>

## 目录
1. [环境变量配置](#环境变量配置)
2. [日志系统配置](#日志系统配置)
3. [时区与交易时间配置](#时区与交易时间配置)
4. [通知系统与WebSocket配置](#通知系统与websocket配置)
5. [性能相关设置](#性能相关设置)

## 环境变量配置

本平台通过环境变量进行系统级配置，支持多种配置方式和优先级。核心配置位于 `app/core/config.py` 文件中，定义了平台运行所需的各种参数。

环境变量的使用方法遵循以下优先级规则：
1. **数据库配置优先**：系统首先尝试从MongoDB数据库中读取配置，这是最高优先级的配置来源。
2. **环境变量次之**：如果数据库中没有配置，则使用环境变量（如 `.env` 文件或系统环境变量）中的值。
3. **默认值兜底**：如果前两者都不存在，则使用代码中定义的默认值。

主要的环境变量包括：
- **数据库连接**：通过 `MONGODB_HOST`、`MONGODB_PORT`、`MONGODB_USERNAME`、`MONGODB_PASSWORD` 和 `MONGODB_DATABASE` 等变量配置MongoDB连接信息。系统会自动根据这些变量构建 `MONGO_URI` 连接字符串。
- **运行模式**：`DEBUG` 变量控制平台的运行模式。当 `DEBUG=True` 时，平台运行在开发模式，启用详细日志和调试功能；当 `DEBUG=False` 时，平台运行在生产模式。
- **调试设置**：`LOG_LEVEL` 变量控制日志级别，可设置为 `DEBUG`、`INFO`、`WARNING`、`ERROR` 或 `CRITICAL`。`ACCESS_LOG` 变量控制是否显示访问日志。

此外，系统还支持一些遗留的环境变量别名（如 `API_HOST` 映射到 `HOST`），但已标记为废弃，建议使用新的变量名。

**Section sources**
- [config.py](file://app/core/config.py#L22-L278)

## 日志系统配置

平台的日志系统采用灵活的配置方式，支持不同环境下的日志输出。日志配置文件位于 `config/logging.toml` 和 `config/logging_docker.toml`，分别用于普通环境和Docker环境。

日志系统的主要配置包括：
- **日志级别**：通过 `logging.level` 配置全局日志级别，同时可以为不同的日志器（logger）单独配置级别，如 `tradingagents`、`web`、`dataflows` 等。
- **输出格式**：支持控制台、文件和结构化（JSON）三种输出格式。控制台格式简洁，便于开发调试；文件格式包含更详细的信息，如模块名、函数名和行号；结构化格式便于日志分析和监控系统处理。
- **文件轮转策略**：日志文件采用轮转策略，当文件大小达到指定阈值（如 `10MB` 或 `100MB`）时，会自动创建新的日志文件，并保留指定数量的旧文件（`backup_count`）。在Windows系统上，使用 `concurrent-log-handler` 避免文件占用问题。

日志处理器（handler）配置如下：
- **控制台处理器**：将日志输出到标准输出，便于实时查看。
- **文件处理器**：将日志写入文件，支持详细的日志记录。
- **错误日志处理器**：专门记录 `WARNING` 及以上级别的日志，便于快速定位问题。
- **结构化日志处理器**：以JSON格式输出日志，便于机器解析。

在Docker环境中，日志配置会自动调整，确保日志输出到 `stdout`，以便Docker日志驱动收集。

**Section sources**
- [logging.toml](file://config/logging.toml#L1-L122)
- [logging_docker.toml](file://config/logging_docker.toml#L1-L132)
- [logging_config.py](file://app/core/logging_config.py#L1-L424)

## 时区与交易时间配置

平台支持灵活的时区设置和交易时间判断，确保在不同地区和市场环境下正确运行。

### 时区设置

时区配置通过 `TIMEZONE` 环境变量进行设置，默认值为 `"Asia/Shanghai"`。系统会优先从数据库缓存中读取时区设置，如果不存在则使用环境变量的值。时区信息用于所有时间相关的操作，如日志记录、数据同步和任务调度。

相关代码位于 `app/utils/timezone.py`，提供了获取时区名称、创建时区对象和获取当前时间的工具函数。

### 交易时间配置

交易时间判断逻辑位于 `app/utils/trading_time.py`，用于判断当前是否在A股交易时间内。交易时间包括：
- **上午交易时段**：9:30-11:30
- **下午交易时段**：13:00-15:00
- **收盘后缓冲期**：15:00-15:30（确保获取到收盘价）

系统提供了多个函数来判断交易状态：
- `is_trading_time()`：判断是否在交易时间或收盘后缓冲期内。
- `is_strict_trading_time()`：判断是否在严格的交易时间内（不包含缓冲期）。
- `get_trading_status()`：获取当前的交易状态，返回值包括 `"pre_market"`（盘前）、`"morning_session"`（上午交易）、`"noon_break"`（午间休市）、`"afternoon_session"`（下午交易）、`"after_market"`（盘后）和 `"closed"`（休市）。

这些函数使用配置的时区进行判断，确保时间计算的准确性。

**Section sources**
- [timezone.py](file://app/utils/timezone.py#L1-L58)
- [trading_time.py](file://app/utils/trading_time.py#L1-L180)

## 通知系统与WebSocket配置

平台的通知系统支持WebSocket和SSE（Server-Sent Events）两种实时通信方式，优先使用WebSocket，失败时自动降级到SSE。

### WebSocket配置

WebSocket配置位于 `app/routers/websocket_notifications.py`，提供了实时通知推送功能。前端通过WebSocket连接到 `/api/ws/notifications` 端点，后端通过 `ConnectionManager` 管理连接。

WebSocket的主要配置包括：
- **心跳机制**：服务器每30秒发送一次心跳消息，保持连接活跃，防止被代理服务器超时关闭。
- **自动重连**：前端实现指数退避重连机制，最多尝试5次，失败后降级到SSE。
- **消息格式**：支持 `connected`（连接确认）、`notification`（通知）和 `heartbeat`（心跳）三种消息类型。

### 通知服务集成

通知服务位于 `app/services/notifications_service.py`，在发送通知时优先尝试通过WebSocket发送，如果失败则降级到Redis PubSub（兼容SSE）。这种设计确保了向后兼容性，同时提供了更好的实时性。

前端实现位于 `frontend/src/stores/notifications.ts`，使用Pinia store管理WebSocket连接和通知状态。

**Section sources**
- [websocket_notifications.py](file://app/routers/websocket_notifications.py)
- [notifications_service.py](file://app/services/notifications_service.py)
- [notifications.ts](file://frontend/src/stores/notifications.ts)

## 性能相关设置

平台提供了多种性能相关设置，以优化系统资源使用和响应速度。

### 并发线程数

通过 `DEFAULT_USER_CONCURRENT_LIMIT` 和 `GLOBAL_CONCURRENT_LIMIT` 环境变量控制用户和全局的并发任务数。这些设置防止系统过载，确保稳定运行。

### 请求超时时间

各种服务的请求超时时间可以通过环境变量配置，如 `MONGO_CONNECT_TIMEOUT_MS`、`MONGO_SOCKET_TIMEOUT_MS` 和 `REDIS_RETRY_ON_TIMEOUT`。合理的超时设置可以避免长时间等待，提高系统响应速度。

### 批量处理大小

数据初始化和同步任务的批量处理大小可以通过 `TUSHARE_INIT_BATCH_SIZE`、`AKSHARE_INIT_BATCH_SIZE` 和 `BAOSTOCK_INIT_BATCH_SIZE` 等变量配置。较大的批量大小可以提高处理效率，但会增加内存使用。

### 队列和缓存设置

- **队列配置**：通过 `QUEUE_MAX_SIZE`、`QUEUE_VISIBILITY_TIMEOUT` 和 `QUEUE_MAX_RETRIES` 控制任务队列的行为。
- **缓存配置**：通过 `CACHE_TTL` 和 `SCREENING_CACHE_TTL` 设置缓存的生存时间，减少重复计算和数据库查询。

这些性能设置可以根据实际硬件资源和业务需求进行调整，以达到最佳的性能和稳定性平衡。

**Section sources**
- [config.py](file://app/core/config.py#L79-L93)
- [config_service.py](file://app/services/config_service.py#L485-L499)