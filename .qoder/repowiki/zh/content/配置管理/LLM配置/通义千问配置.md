# é€šä¹‰åƒé—®é…ç½®

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [dashscope-config.md](file://docs/configuration/dashscope-config.md)
- [dashscope_openai_adapter.py](file://tradingagents/llm_adapters/dashscope_openai_adapter.py)
- [config_service.py](file://app/services/config_service.py)
- [api_keys_security.md](file://docs/security/api_keys_security.md)
- [API_KEY_PRIORITY.md](file://docs/configuration/API_KEY_PRIORITY.md)
- [rate_limiter.py](file://app/core/rate_limiter.py)
- [rate_limit.py](file://app/middleware/rate_limit.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [APIå¯†é’¥é…ç½®](#apiå¯†é’¥é…ç½®)
3. [è¯·æ±‚å‚æ•°è®¾ç½®](#è¯·æ±‚å‚æ•°è®¾ç½®)
4. [æ¨¡å‹è°ƒç”¨ç®¡ç†](#æ¨¡å‹è°ƒç”¨ç®¡ç†)
5. [ç³»ç»Ÿé›†æˆ](#ç³»ç»Ÿé›†æˆ)
6. [é€‚é…å™¨å®ç°](#é€‚é…å™¨å®ç°)
7. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)
8. [ç¯å¢ƒé…ç½®ç¤ºä¾‹](#ç¯å¢ƒé…ç½®ç¤ºä¾‹)
9. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
10. [ä¼˜å…ˆçº§æ¯”è¾ƒä¸æ•…éšœè½¬ç§»](#ä¼˜å…ˆçº§æ¯”è¾ƒä¸æ•…éšœè½¬ç§»)

## ç®€ä»‹

é€šä¹‰åƒé—®ï¼ˆDashScopeï¼‰æ˜¯é˜¿é‡Œäº‘æ¨å‡ºçš„å¤§æ¨¡å‹æœåŠ¡å¹³å°ï¼Œæä¾›é€šä¹‰åƒé—®ç³»åˆ—æ¨¡å‹ã€‚æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨TradingAgentsç³»ç»Ÿä¸­é…ç½®å’Œä½¿ç”¨é˜¿é‡Œç™¾ç‚¼å¤§æ¨¡å‹ï¼ŒåŒ…æ‹¬APIå¯†é’¥é…ç½®ã€è¯·æ±‚å‚æ•°è®¾ç½®ã€æ¨¡å‹è°ƒç”¨ç®¡ç†ã€ç³»ç»Ÿé›†æˆã€é€‚é…å™¨å®ç°ã€é”™è¯¯å¤„ç†æœºåˆ¶ã€ç¯å¢ƒé…ç½®ç¤ºä¾‹ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®ä»¥åŠä¸å…¶ä»–LLMæä¾›å•†çš„ä¼˜å…ˆçº§æ¯”è¾ƒå’Œæ•…éšœè½¬ç§»æœºåˆ¶ã€‚

**Section sources**
- [dashscope-config.md](file://docs/configuration/dashscope-config.md)

## APIå¯†é’¥é…ç½®

### é…ç½®æ¥æº

ç³»ç»Ÿæ”¯æŒä¸¤ç§APIå¯†é’¥é…ç½®æ¥æºï¼š

1. **MongoDBæ•°æ®åº“**ï¼ˆ`llm_providers`é›†åˆï¼‰
   - âœ… **é€šè¿‡Webç•Œé¢é…ç½®**ï¼ˆæ¨èï¼‰
   - å­˜å‚¨åœ¨å‚å®¶é…ç½®ä¸­
   - æ‰€æœ‰ç”¨æˆ·å…±äº«
   - æ”¯æŒåœ¨çº¿ç¼–è¾‘å’Œæ›´æ–°

2. **ç¯å¢ƒå˜é‡**ï¼ˆ`.env`æ–‡ä»¶ï¼‰
   - ç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½
   - CLIå®¢æˆ·ç«¯ä½¿ç”¨
   - ä½œä¸ºå…œåº•é…ç½®
   - é€‚åˆå¼€å‘ç¯å¢ƒ

### ä¼˜å…ˆçº§è§„åˆ™

```
æœ‰æ•ˆçš„æ•°æ®åº“é…ç½® > ç¯å¢ƒå˜é‡é…ç½® > æ— é…ç½®ï¼ˆæŠ¥é”™ï¼‰
```

#### ä»€ä¹ˆæ˜¯"æœ‰æ•ˆçš„é…ç½®"ï¼Ÿ

ç³»ç»Ÿä¼šéªŒè¯æ•°æ®åº“ä¸­çš„APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆï¼Œåˆ¤æ–­æ ‡å‡†ï¼š

1. âœ… Keyä¸ä¸ºç©º
2. âœ… Keyä¸æ˜¯å ä½ç¬¦ï¼ˆä¸ä»¥`your_`æˆ–`your-`å¼€å¤´ï¼‰
3. âœ… Keyé•¿åº¦ > 10ä¸ªå­—ç¬¦

### é…ç½®é€‰æ‹©é€»è¾‘

```python
if æ•°æ®åº“ä¸­çš„Keyæœ‰æ•ˆ:
    ä½¿ç”¨æ•°æ®åº“ä¸­çš„Key
    æ¥æºæ ‡è®°ä¸º "database"
else:
    if ç¯å¢ƒå˜é‡ä¸­æœ‰æœ‰æ•ˆçš„Key:
        ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„Key
        æ¥æºæ ‡è®°ä¸º "environment"
    else:
        æŠ¥é”™ï¼šæœªé…ç½®æœ‰æ•ˆçš„APIKey
```

### å®‰å…¨æœ€ä½³å®è·µ

1. **ä½¿ç”¨ç¯å¢ƒå˜é‡**
   ```bash
   # åœ¨.envæ–‡ä»¶ä¸­é…ç½®
   DASHSCOPE_API_KEY=your_real_api_key_here
   FINNHUB_API_KEY=your_real_finnhub_key_here
   ```

2. **æ­£ç¡®çš„æ–‡ä»¶æƒé™**
   ```bash
   # è®¾ç½®.envæ–‡ä»¶åªæœ‰æ‰€æœ‰è€…å¯è¯»å†™
   chmod 600 .env
   ```

3. **ä½¿ç”¨.gitignore**
   ç¡®ä¿.gitignoreåŒ…å«ï¼š
   ```
   .env
   .env.local
   .env.*.local
   ```

4. **å®šæœŸè½®æ¢APIå¯†é’¥**
   - å®šæœŸæ›´æ¢APIå¯†é’¥
   - å¦‚æœæ€€ç–‘å¯†é’¥æ³„éœ²ï¼Œç«‹å³æ›´æ¢
   - ç›‘æ§APIä½¿ç”¨æƒ…å†µï¼Œå‘ç°å¼‚å¸¸ç«‹å³å¤„ç†

**Section sources**
- [API_KEY_PRIORITY.md](file://docs/configuration/API_KEY_PRIORITY.md)
- [api_keys_security.md](file://docs/security/api_keys_security.md)

## è¯·æ±‚å‚æ•°è®¾ç½®

### åŸºç¡€é…ç½®

```python
config = {
    "llm_provider": "dashscope",
    "deep_think_llm": "qwen-plus-latest",  # æ·±åº¦æ€è€ƒä½¿ç”¨Plus
    "quick_think_llm": "qwen-turbo",       # å¿«é€Ÿä»»åŠ¡ä½¿ç”¨Turbo
    "max_debate_rounds": 1,               # å‡å°‘è¾©è®ºè½®æ¬¡
}
```

### é«˜çº§é…ç½®

```python
config = {
    "llm_provider": "dashscope",
    "deep_think_llm": "qwen-max",         # æ·±åº¦æ€è€ƒä½¿ç”¨Max
    "quick_think_llm": "qwen-plus",       # å¿«é€Ÿä»»åŠ¡ä½¿ç”¨Plus
    "max_debate_rounds": 2,               # å¢åŠ è¾©è®ºè½®æ¬¡
}
```

### é•¿æ–‡æœ¬é…ç½®

```python
config = {
    "llm_provider": "dashscope",
    "deep_think_llm": "qwen-max-longcontext",  # ä½¿ç”¨é•¿æ–‡æœ¬ç‰ˆæœ¬
    "quick_think_llm": "qwen-plus",
    "max_debate_rounds": 1,
}
```

**Section sources**
- [dashscope-config.md](file://docs/configuration/dashscope-config.md)

## æ¨¡å‹è°ƒç”¨ç®¡ç†

### æ”¯æŒçš„æ¨¡å‹

| æ¨¡å‹åç§° | æ¨¡å‹ID | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|--------|------|----------|
| **é€šä¹‰åƒé—® Turbo** | `qwen-turbo` | å¿«é€Ÿå“åº”ï¼Œæˆæœ¬ä½ | å¿«é€Ÿä»»åŠ¡ã€æ—¥å¸¸å¯¹è¯ |
| **é€šä¹‰åƒé—® Plus** | `qwen-plus-latest` | å¹³è¡¡æ€§èƒ½å’Œæˆæœ¬ | å¤æ‚åˆ†æã€ä¸“ä¸šä»»åŠ¡ |
| **é€šä¹‰åƒé—® Max** | `qwen-max` | æœ€å¼ºæ€§èƒ½ | æœ€å¤æ‚ä»»åŠ¡ã€é«˜è´¨é‡è¾“å‡º |
| **é€šä¹‰åƒé—® Max é•¿æ–‡æœ¬** | `qwen-max-longcontext` | è¶…é•¿ä¸Šä¸‹æ–‡ | é•¿æ–‡æ¡£åˆ†æã€å¤§é‡æ•°æ®å¤„ç† |

### æˆæœ¬æ§åˆ¶

#### å…¸å‹ä½¿ç”¨æˆæœ¬
- **ç»æµæ¨¡å¼**: Â¥0.01-0.05/æ¬¡åˆ†æ (ä½¿ç”¨ qwen-turbo)
- **æ ‡å‡†æ¨¡å¼**: Â¥0.05-0.15/æ¬¡åˆ†æ (ä½¿ç”¨ qwen-plus)
- **é«˜ç²¾åº¦æ¨¡å¼**: Â¥0.10-0.30/æ¬¡åˆ†æ (ä½¿ç”¨ qwen-max)

#### æˆæœ¬ä¼˜åŒ–å»ºè®®
1. **åˆç†é€‰æ‹©æ¨¡å‹**: æ ¹æ®ä»»åŠ¡å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„æ¨¡å‹
2. **æ§åˆ¶è¾©è®ºè½®æ¬¡**: å‡å°‘ `max_debate_rounds` å‚æ•°
3. **ä½¿ç”¨ç¼“å­˜**: å¯ç”¨æ•°æ®ç¼“å­˜å‡å°‘é‡å¤è°ƒç”¨
4. **ç›‘æ§ä½¿ç”¨é‡**: å®šæœŸæ£€æŸ¥APIè°ƒç”¨é‡å’Œè´¹ç”¨

**Section sources**
- [dashscope-config.md](file://docs/configuration/dashscope-config.md)

## ç³»ç»Ÿé›†æˆ

### é…ç½®ç¤ºä¾‹

```python
from tradingagents.graph.trading_graph import TradingAgentsGraph
from tradingagents.default_config import DEFAULT_CONFIG

# åˆ›å»ºé˜¿é‡Œç™¾ç‚¼é…ç½®
config = DEFAULT_CONFIG.copy()
config["llm_provider"] = "dashscope"
config["deep_think_llm"] = "qwen-plus-latest"
config["quick_think_llm"] = "qwen-turbo"

# åˆå§‹åŒ–
ta = TradingAgentsGraph(debug=True, config=config)

# è¿è¡Œåˆ†æ
state, decision = ta.propagate("AAPL", "2024-05-10")
print(decision)
```

### é«˜çº§é…ç½®

```python
# è‡ªå®šä¹‰æ¨¡å‹å‚æ•°
config = DEFAULT_CONFIG.copy()
config.update({
    "llm_provider": "dashscope",
    "deep_think_llm": "qwen-max",
    "quick_think_llm": "qwen-plus-latest",
    "max_debate_rounds": 2,
    "max_risk_discuss_rounds": 2,
    "online_tools": True,
})

# ä½¿ç”¨è‡ªå®šä¹‰å‚æ•°åˆ›å»ºLLM
from tradingagents.llm_adapters import ChatDashScope

custom_llm = ChatDashScope(
    model="qwen-max",
    temperature=0.1,
    max_tokens=3000,
    top_p=0.9
)
```

**Section sources**
- [dashscope-config.md](file://docs/configuration/dashscope-config.md)

## é€‚é…å™¨å®ç°

### OpenAIå…¼å®¹é€‚é…å™¨æ¶æ„

#### 1. é€‚é…å™¨ç±»å±‚æ¬¡ç»“æ„
```python
# æ–°çš„OpenAIå…¼å®¹é€‚é…å™¨
from tradingagents.llm_adapters import ChatDashScopeOpenAI

# ç»§æ‰¿å…³ç³»
ChatDashScopeOpenAI -> ChatOpenAI -> BaseChatModel
```

#### 2. æ ¸å¿ƒç‰¹æ€§
- **æ ‡å‡†æ¥å£**: å®Œå…¨å…¼å®¹LangChainçš„ChatOpenAIæ¥å£
- **å·¥å…·è°ƒç”¨**: æ”¯æŒåŸç”ŸFunction Calling
- **è‡ªåŠ¨å›é€€**: å¼ºåˆ¶å·¥å…·è°ƒç”¨æœºåˆ¶ç¡®ä¿æ•°æ®è·å–
- **Tokenè¿½è¸ª**: è‡ªåŠ¨è®°å½•ä½¿ç”¨é‡å’Œæˆæœ¬

#### 3. å·¥å…·è°ƒç”¨æµç¨‹
```
ç”¨æˆ·è¯·æ±‚ â†’ LLMåˆ†æ â†’ å°è¯•å·¥å…·è°ƒç”¨
    â†“
å¦‚æœå·¥å…·è°ƒç”¨å¤±è´¥ â†’ å¼ºåˆ¶è°ƒç”¨æ•°æ®å·¥å…· â†’ é‡æ–°ç”Ÿæˆåˆ†æ
    â†“
è¿”å›å®Œæ•´çš„åŸºäºçœŸå®æ•°æ®çš„åˆ†ææŠ¥å‘Š
```

### ä¸æ—§ç‰ˆæœ¬çš„å¯¹æ¯”

| ç‰¹æ€§ | æ—§ç‰ˆæœ¬ (ReActæ¨¡å¼) | æ–°ç‰ˆæœ¬ (OpenAIå…¼å®¹) |
|------|-------------------|---------------------|
| **æ¶æ„å¤æ‚åº¦** | å¤æ‚çš„ReActå¾ªç¯ | ç®€å•çš„æ ‡å‡†æ¨¡å¼ |
| **APIè°ƒç”¨æ¬¡æ•°** | å¤šæ¬¡è°ƒç”¨ | å•æ¬¡è°ƒç”¨ |
| **å·¥å…·è°ƒç”¨ç¨³å®šæ€§** | ä¸ç¨³å®š | ç¨³å®š |
| **æŠ¥å‘Šé•¿åº¦** | 30å­—ç¬¦ | å®Œæ•´æŠ¥å‘Š |
| **ç»´æŠ¤éš¾åº¦** | é«˜ | ä½ |
| **æ€§èƒ½** | è¾ƒæ…¢ | å¿«é€Ÿ |

**Section sources**
- [dashscope-config.md](file://docs/configuration/dashscope-config.md)
- [dashscope_openai_adapter.py](file://tradingagents/llm_adapters/dashscope_openai_adapter.py)

## é”™è¯¯å¤„ç†æœºåˆ¶

### å¸¸è§é—®é¢˜

#### 1. APIå¯†é’¥é”™è¯¯
```
Error: Invalid API key
```
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®ï¼Œç¡®è®¤å·²å¼€é€šç™¾ç‚¼æœåŠ¡

#### 2. é¢åº¦ä¸è¶³
```
Error: Insufficient quota
```
**è§£å†³æ–¹æ¡ˆ**: åœ¨ç™¾ç‚¼æ§åˆ¶å°å……å€¼æˆ–å‡çº§å¥—é¤

#### 3. ç½‘ç»œè¿æ¥é—®é¢˜
```
Error: Connection timeout
```
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¡®è®¤å¯ä»¥è®¿é—®é˜¿é‡Œäº‘æœåŠ¡

#### 4. æ¨¡å‹ä¸å­˜åœ¨
```
Error: Model not found
```
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥æ¨¡å‹åç§°æ˜¯å¦æ­£ç¡®ï¼Œç¡®è®¤æ¨¡å‹å·²å¼€é€š

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ¨¡å¼**:
   ```python
   ta = TradingAgentsGraph(debug=True, config=config)
   ```

2. **æ£€æŸ¥APIè¿æ¥**:
   ```python
   import dashscope
   dashscope.api_key = "your_api_key"
   
   from dashscope import Generation
   response = Generation.call(
       model="qwen-turbo",
       messages=[{"role": "user", "content": "Hello"}]
   )
   print(response)
   ```

**Section sources**
- [dashscope-config.md](file://docs/configuration/dashscope-config.md)

## ç¯å¢ƒé…ç½®ç¤ºä¾‹

### å¼€å‘ç¯å¢ƒé…ç½®

```bash
# å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥çœŸå®çš„APIå¯†é’¥
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
FINNHUB_API_KEY=your_finnhub_api_key_here
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®

1. **ç™»å½•ç³»ç»Ÿ** â†’ **è®¾ç½®** â†’ **å‚å®¶ç®¡ç†**
2. **ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®**ï¼Œæ‰“å¼€å‚å®¶ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†
3. **åœ¨"API Key"è¾“å…¥æ¡†ä¸­è¾“å…¥ä½ çš„API Key**
4. **ç‚¹å‡»"æ›´æ–°"æŒ‰é’®**ä¿å­˜

**æ³¨æ„äº‹é¡¹**ï¼š
- API Keyä¼šè¢«åŠ å¯†å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
- å¦‚æœç•™ç©ºï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨`.env`æ–‡ä»¶ä¸­çš„é…ç½®
- å¦‚æœè¾“å…¥æ— æ•ˆçš„Keyï¼ˆå ä½ç¬¦æˆ–é•¿åº¦ä¸å¤Ÿï¼‰ï¼Œç³»ç»Ÿä¼šå¿½ç•¥å¹¶ä½¿ç”¨ç¯å¢ƒå˜é‡

**Section sources**
- [api_keys_security.md](file://docs/security/api_keys_security.md)
- [API_KEY_PRIORITY.md](file://docs/configuration/API_KEY_PRIORITY.md)

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### é‡è¯•ç­–ç•¥

```python
async def _execute_bulk_write_with_retry(
    self,
    symbol: str,
    operations: List,
    max_retries: int = 3
) -> int:
    """
    æ‰§è¡Œæ‰¹é‡å†™å…¥ï¼Œæ”¯æŒé‡è¯•
    
    Args:
        symbol: è‚¡ç¥¨ä»£ç 
        operations: æ‰¹é‡æ“ä½œåˆ—è¡¨
        max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°
    
    Returns:
        æˆåŠŸå†™å…¥çš„è®°å½•æ•°
    """
    saved_count = 0
    retry_count = 0
    
    while retry_count < max_retries:
        try:
            result = await self.collection.bulk_write(
                operations, 
                ordered=False  # ğŸ”¥ éé¡ºåºæ‰§è¡Œï¼Œæœ€å¤§åŒ–æˆåŠŸç‡
            )
            saved_count = result.upserted_count + result.modified_count
            
            if retry_count > 0:
                logger.info(
                    f"âœ… {symbol} é‡è¯•æˆåŠŸ "
                    f"(ç¬¬{retry_count}æ¬¡é‡è¯•ï¼Œä¿å­˜{saved_count}æ¡)"
                )
            
            return saved_count
            
        except asyncio.TimeoutError as e:
            retry_count += 1
            if retry_count < max_retries:
                wait_time = 2 ** retry_count  # ğŸ”¥ æŒ‡æ•°é€€é¿ï¼š2ç§’ã€4ç§’ã€8ç§’
                logger.warning(
                    f"âš ï¸ {symbol} æ‰¹é‡å†™å…¥è¶…æ—¶ "
                    f"(ç¬¬{retry_count}/{max_retries}æ¬¡é‡è¯•)ï¼Œ"
                    f"ç­‰å¾…{wait_time}ç§’åé‡è¯•..."
                )
                await asyncio.sleep(wait_time)
            else:
                logger.error(
                    f"âŒ {symbol} æ‰¹é‡å†™å…¥å¤±è´¥ï¼Œ"
                    f"å·²é‡è¯•{max_retries}æ¬¡: {e}"
                )
                return 0
                
        except Exception as e:
            # ğŸ”¥ éè¶…æ—¶é”™è¯¯ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…æ— é™é‡è¯•
            logger.error(f"âŒ {symbol} æ‰¹é‡å†™å…¥å¤±è´¥: {e}")
            return 0
    
    return saved_count
```

### é€Ÿç‡é™åˆ¶å¤„ç†

```python
class RateLimiter:
    """
    æ»‘åŠ¨çª—å£é€Ÿç‡é™åˆ¶å™¨
    
    ä½¿ç”¨æ»‘åŠ¨çª—å£ç®—æ³•ç²¾ç¡®æ§åˆ¶APIè°ƒç”¨é¢‘ç‡
    """
    
    def __init__(self, max_calls: int, time_window: float, name: str = "RateLimiter"):
        """
        åˆå§‹åŒ–é€Ÿç‡é™åˆ¶å™¨
        
        Args:
            max_calls: æ—¶é—´çª—å£å†…æœ€å¤§è°ƒç”¨æ¬¡æ•°
            time_window: æ—¶é—´çª—å£å¤§å°ï¼ˆç§’ï¼‰
            name: é™åˆ¶å™¨åç§°ï¼ˆç”¨äºæ—¥å¿—ï¼‰
        """
        self.max_calls = max_calls
        self.time_window = time_window
        self.name = name
        self.calls = deque()  # å­˜å‚¨è°ƒç”¨æ—¶é—´æˆ³
        self.lock = asyncio.Lock()  # ç¡®ä¿çº¿ç¨‹å®‰å…¨
        
        # ç»Ÿè®¡ä¿¡æ¯
        self.total_calls = 0
        self.total_waits = 0
        self.total_wait_time = 0.0
        
        logger.info(f"ğŸ”§ {self.name} åˆå§‹åŒ–: {max_calls}æ¬¡/{time_window}ç§’")
    
    async def acquire(self):
        """
        è·å–è°ƒç”¨è®¸å¯
        å¦‚æœè¶…è¿‡é€Ÿç‡é™åˆ¶ï¼Œä¼šç­‰å¾…ç›´åˆ°å¯ä»¥è°ƒç”¨
        """
        async with self.lock:
            now = time.time()
            
            # ç§»é™¤æ—¶é—´çª—å£å¤–çš„æ—§è°ƒç”¨è®°å½•
            while self.calls and self.calls[0] <= now - self.time_window:
                self.calls.popleft()
            
            # å¦‚æœå½“å‰çª—å£å†…è°ƒç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œéœ€è¦ç­‰å¾…
            if len(self.calls) >= self.max_calls:
                # è®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´
                oldest_call = self.calls[0]
                wait_time = oldest_call + self.time_window - now + 0.01  # åŠ ä¸€ç‚¹ç¼“å†²
                
                if wait_time > 0:
                    self.total_waits += 1
                    self.total_wait_time += wait_time
                    
                    logger.debug(f"â³ {self.name} è¾¾åˆ°é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾… {wait_time:.2f}ç§’")
                    await asyncio.sleep(wait_time)
                    
                    # é‡æ–°è·å–å½“å‰æ—¶é—´
                    now = time.time()
                    
                    # å†æ¬¡æ¸…ç†æ—§è®°å½•
                    while self.calls and self.calls[0] <= now - self.time_window:
                        self.calls.popleft()
            
            # è®°å½•æœ¬æ¬¡è°ƒç”¨
            self.calls.append(now)
            self.total_calls += 1
```

**Section sources**
- [rate_limiter.py](file://app/core/rate_limiter.py)
- [blog/2025-10-30-priority-retries-and-realtime-backfill.md](file://docs/blog/2025-10-30-priority-retries-and-realtime-backfill.md)

## ä¼˜å…ˆçº§æ¯”è¾ƒä¸æ•…éšœè½¬ç§»

### ä¼˜å…ˆçº§æ¯”è¾ƒ

| ç‰¹æ€§ | é€šä¹‰åƒé—® | DeepSeek | OpenAI |
|------|---------|---------|--------|
| **ä¸­æ–‡ä¼˜åŒ–** | âœ… ä¸“é—¨é’ˆå¯¹ä¸­æ–‡åœºæ™¯ä¼˜åŒ– | âœ… ä¸­æ–‡ç†è§£èƒ½åŠ›å¼º | âš ï¸ è‹±æ–‡ä¸ºä¸» |
| **ç½‘ç»œç¨³å®šæ€§** | âœ… å›½å†…ç›´æ¥è®¿é—®ï¼Œç½‘ç»œç¨³å®š | âœ… å›½å†…è®¿é—® | âŒ éœ€è¦ç¿»å¢™ |
| **åˆè§„å®‰å…¨** | âœ… ç¬¦åˆå›½å†…æ•°æ®å®‰å…¨è¦æ±‚ | âœ… ç¬¦åˆå›½å†…æ•°æ®å®‰å…¨è¦æ±‚ | âš ï¸ æ•°æ®å‡ºå¢ƒé£é™© |
| **æˆæœ¬ä¼˜åŠ¿** | âœ… ä»·æ ¼é€æ˜ï¼Œæ€§ä»·æ¯”é«˜ | âœ… ä»·æ ¼é€æ˜ï¼Œæ€§ä»·æ¯”é«˜ | âŒ ä»·æ ¼è¾ƒé«˜ |
| **æœ¬åœŸåŒ–æœåŠ¡** | âœ… ä¸­æ–‡å®¢æœå’ŒæŠ€æœ¯æ”¯æŒ | âœ… ä¸­æ–‡å®¢æœå’ŒæŠ€æœ¯æ”¯æŒ | âš ï¸ è‹±æ–‡å®¢æœ |

### æ•…éšœè½¬ç§»æœºåˆ¶

```python
def get_llm_providers(self) -> List[LLMProvider]:
    providers_data = await providers_collection.find().to_list(length=None)
    providers = []
    
    for provider_data in providers_data:
        provider = LLMProvider(**provider_data)
        
        # åˆ¤æ–­æ•°æ®åº“ä¸­çš„Keyæ˜¯å¦æœ‰æ•ˆ
        db_key_valid = self._is_valid_api_key(provider.api_key)
        
        if not db_key_valid:
            # å°è¯•ä»ç¯å¢ƒå˜é‡è·å–
            env_key = self._get_env_api_key(provider.name)
            if env_key:
                provider.api_key = env_key
                provider.extra_config["source"] = "environment"
        else:
            provider.extra_config["source"] = "database"
        
        providers.append(provider)
    
    return providers
```

**Section sources**
- [API_KEY_PRIORITY.md](file://docs/configuration/API_KEY_PRIORITY.md)
- [config_service.py](file://app/services/config_service.py)