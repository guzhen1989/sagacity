# æ•°æ®åº“ç¼“å­˜é…ç½®æ–¹æ³•

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨æ–‡ä»¶**   
- [CACHE_CONFIGURATION.md](file://docs/configuration/CACHE_CONFIGURATION.md)
- [config.py](file://app/core/config.py)
- [database.py](file://app/core/database.py)
- [redis_client.py](file://app/core/redis_client.py)
- [database_manager.py](file://tradingagents/config/database_manager.py)
- [__init__.py](file://tradingagents/dataflows/cache/__init__.py)
- [integrated.py](file://tradingagents/dataflows/cache/integrated.py)
- [adaptive.py](file://tradingagents/dataflows/cache/adaptive.py)
- [file_cache.py](file://tradingagents/dataflows/cache/file_cache.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [ç¯å¢ƒå˜é‡é…ç½®](#ç¯å¢ƒå˜é‡é…ç½®)
3. [é…ç½®æ–‡ä»¶è®¾ç½®](#é…ç½®æ–‡ä»¶è®¾ç½®)
4. [è‡ªåŠ¨é™çº§æœºåˆ¶](#è‡ªåŠ¨é™çº§æœºåˆ¶)
5. [é…ç½®éªŒè¯](#é…ç½®éªŒè¯)
6. [æ€§èƒ½æ¨¡å¼è¯´æ˜](#æ€§èƒ½æ¨¡å¼è¯´æ˜)
7. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

## ç®€ä»‹
æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†å¦‚ä½•é€šè¿‡ç¯å¢ƒå˜é‡å’Œç³»ç»Ÿé…ç½®å¯ç”¨MongoDBå’ŒRedisä½œä¸ºç¼“å­˜åç«¯ã€‚æ–‡æ¡£æ¶µç›–äº†MONGODB_URLå’ŒREDIS_URLçš„è®¾ç½®æ ¼å¼ï¼Œcache.primary_backendå‚æ•°çš„é…ç½®æ–¹æ³•ï¼Œä»¥åŠåœ¨æ•°æ®åº“æœåŠ¡ä¸å¯ç”¨æ—¶çš„è‡ªåŠ¨é™çº§æœºåˆ¶ã€‚åŒæ—¶æä¾›äº†é…ç½®éªŒè¯æ­¥éª¤å’Œä¸åŒé…ç½®ç»„åˆä¸‹çš„æ€§èƒ½æ¨¡å¼è¯´æ˜ã€‚

## ç¯å¢ƒå˜é‡é…ç½®
ç³»ç»Ÿæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ç¼“å­˜åç«¯ï¼Œè¿™æ˜¯æœ€æ¨èçš„é…ç½®æ–¹å¼ã€‚

### MongoDB URLè®¾ç½®
MongoDBè¿æ¥å­—ç¬¦ä¸²çš„æ ¼å¼å¦‚ä¸‹ï¼š
```
mongodb://[username:password@]host:port/database?authSource=admin
```

**ç¤ºä¾‹**ï¼š
```bash
# æ— è®¤è¯çš„æœ¬åœ°è¿æ¥
export MONGODB_URL=mongodb://localhost:27017/tradingagents

# å¸¦è®¤è¯çš„è¿œç¨‹è¿æ¥
export MONGODB_URL=mongodb://user:pass@192.168.1.100:27017/tradingagents?authSource=admin
```

åœ¨`app/core/config.py`ä¸­ï¼Œç³»ç»Ÿé€šè¿‡ä»¥ä¸‹å±æ€§æ„å»ºMongoDB URIï¼š
```python
@property
def MONGO_URI(self) -> str:
    """æ„å»ºMongoDB URI"""
    if self.MONGODB_USERNAME and self.MONGODB_PASSWORD:
        return f"mongodb://{self.MONGODB_USERNAME}:{self.MONGODB_PASSWORD}@{self.MONGODB_HOST}:{self.MONGODB_PORT}/{self.MONGODB_DATABASE}?authSource={self.MONGODB_AUTH_SOURCE}"
    else:
        return f"mongodb://{self.MONGODB_HOST}:{self.MONGODB_PORT}/{self.MONGODB_DATABASE}"
```

**Section sources**
- [config.py](file://app/core/config.py#L44-L50)

### Redis URLè®¾ç½®
Redisè¿æ¥å­—ç¬¦ä¸²çš„æ ¼å¼å¦‚ä¸‹ï¼š
```
redis://[:password@]host:port/db
```

**ç¤ºä¾‹**ï¼š
```bash
# æ— å¯†ç çš„æœ¬åœ°è¿æ¥
export REDIS_URL=redis://localhost:6379/0

# å¸¦å¯†ç çš„è¿œç¨‹è¿æ¥
export REDIS_URL=redis://:mypassword@192.168.1.100:6379/2
```

åœ¨`app/core/config.py`ä¸­ï¼Œç³»ç»Ÿé€šè¿‡ä»¥ä¸‹å±æ€§æ„å»ºRedis URLï¼š
```python
@property
def REDIS_URL(self) -> str:
    """æ„å»ºRedis URL"""
    if self.REDIS_PASSWORD:
        return f"redis://:{self.REDIS_PASSWORD}@{self.REDIS_HOST}:{self.REDIS_PORT}/{self.REDIS_DB}"
    else:
        return f"redis://{self.REDIS_HOST}:{self.REDIS_PORT}/{self.REDIS_DB}"
```

**Section sources**
- [config.py](file://app/core/config.py#L66-L71)

## é…ç½®æ–‡ä»¶è®¾ç½®
é™¤äº†ç¯å¢ƒå˜é‡ï¼Œè¿˜å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œè®¾ç½®ã€‚

### ä¸»è¦ç¼“å­˜åç«¯é…ç½®
åœ¨ç³»ç»Ÿé…ç½®ä¸­ï¼Œ`cache.primary_backend`å‚æ•°ç”¨äºæŒ‡å®šä¸»è¦ç¼“å­˜åç«¯ã€‚è¯¥å‚æ•°çš„å€¼ç”±`tradingagents/config/database_manager.py`ä¸­çš„`DatabaseManager`ç±»æ ¹æ®æ•°æ®åº“å¯ç”¨æ€§è‡ªåŠ¨ç¡®å®šï¼š

```python
def _update_config_based_on_detection(self):
    """æ ¹æ®æ£€æµ‹ç»“æœæ›´æ–°é…ç½®"""
    # ç¡®å®šç¼“å­˜åç«¯
    if self.redis_available:
        self.primary_backend = "redis"
    elif self.mongodb_available:
        self.primary_backend = "mongodb"
    else:
        self.primary_backend = "file"
    
    self.logger.info(f"ä¸»è¦ç¼“å­˜åç«¯: {self.primary_backend}")
```

**Section sources**
- [database_manager.py](file://tradingagents/config/database_manager.py#L184-L194)

### é…ç½®ä¼˜å…ˆçº§
ç³»ç»Ÿé…ç½®éµå¾ªä»¥ä¸‹ä¼˜å…ˆçº§é¡ºåºï¼š
1. ç¯å¢ƒå˜é‡
2. .envæ–‡ä»¶
3. ä»£ç ä¸­çš„é»˜è®¤å€¼

åœ¨`app/core/config.py`ä¸­ï¼Œç³»ç»Ÿä½¿ç”¨Pydanticçš„SettingsConfigDictæ¥å¤„ç†é…ç½®ä¼˜å…ˆçº§ï¼š
```python
# Ignore any extra environment variables present in .env or process env
model_config = SettingsConfigDict(env_file=".env", env_file_encoding="utf-8", extra="ignore")
```

**Section sources**
- [config.py](file://app/core/config.py#L284-L285)

## è‡ªåŠ¨é™çº§æœºåˆ¶
ç³»ç»Ÿå®ç°äº†å®Œå–„çš„è‡ªåŠ¨é™çº§æœºåˆ¶ï¼Œç¡®ä¿åœ¨æ•°æ®åº“æœåŠ¡ä¸å¯ç”¨æ—¶ç³»ç»Ÿä»èƒ½æ­£å¸¸è¿è¡Œã€‚

### é™çº§ç­–ç•¥
å½“ä¸»è¦ç¼“å­˜åç«¯ï¼ˆMongoDBæˆ–Redisï¼‰ä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§åˆ°æ–‡ä»¶ç¼“å­˜ã€‚é™çº§æœºåˆ¶åœ¨`tradingagents/dataflows/cache/integrated.py`ä¸­å®ç°ï¼š

```python
def get_cache() -> Union[StockDataCache, IntegratedCacheManager]:
    """
    è·å–ç¼“å­˜å®ä¾‹ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
    
    æ ¹æ®ç¯å¢ƒå˜é‡ TA_CACHE_STRATEGY é€‰æ‹©ç¼“å­˜ç­–ç•¥ï¼š
    - "file" (é»˜è®¤): ä½¿ç”¨æ–‡ä»¶ç¼“å­˜
    - "integrated": ä½¿ç”¨é›†æˆç¼“å­˜ï¼ˆè‡ªåŠ¨é€‰æ‹© MongoDB/Redis/Fileï¼‰
    - "adaptive": ä½¿ç”¨è‡ªé€‚åº”ç¼“å­˜ï¼ˆåŒ integratedï¼‰
    """
    global _cache_instance

    if _cache_instance is None:
        if DEFAULT_CACHE_STRATEGY in ["integrated", "adaptive"]:
            if INTEGRATED_CACHE_AVAILABLE:
                try:
                    _cache_instance = IntegratedCacheManager()
                    logger.info("âœ… ä½¿ç”¨é›†æˆç¼“å­˜ç³»ç»Ÿï¼ˆæ”¯æŒ MongoDB/Redis/File è‡ªåŠ¨é€‰æ‹©ï¼‰")
                except Exception as e:
                    logger.warning(f"âš ï¸ é›†æˆç¼“å­˜åˆå§‹åŒ–å¤±è´¥ï¼Œé™çº§åˆ°æ–‡ä»¶ç¼“å­˜: {e}")
                    _cache_instance = StockDataCache()
            else:
                logger.warning("âš ï¸ é›†æˆç¼“å­˜ä¸å¯ç”¨ï¼Œä½¿ç”¨æ–‡ä»¶ç¼“å­˜")
                _cache_instance = StockDataCache()
        else:
            _cache_instance = StockDataCache()
            logger.info("âœ… ä½¿ç”¨æ–‡ä»¶ç¼“å­˜ç³»ç»Ÿ")
    
    return _cache_instance
```

**Section sources**
- [__init__.py](file://tradingagents/dataflows/cache/__init__.py#L77-L114)

### é™çº§æµç¨‹
ç³»ç»Ÿåœ¨åˆå§‹åŒ–æ—¶ä¼šæ£€æµ‹æ•°æ®åº“å¯ç”¨æ€§ï¼Œå¹¶æ ¹æ®æ£€æµ‹ç»“æœé€‰æ‹©åˆé€‚çš„ç¼“å­˜åç«¯ï¼š

```mermaid
graph TD
A[å¼€å§‹] --> B{TA_CACHE_STRATEGY=integrated?}
B --> |æ˜¯| C{é›†æˆç¼“å­˜å¯ç”¨?}
C --> |æ˜¯| D[å°è¯•åˆå§‹åŒ–IntegratedCacheManager]
D --> E{åˆå§‹åŒ–æˆåŠŸ?}
E --> |æ˜¯| F[ä½¿ç”¨é›†æˆç¼“å­˜]
E --> |å¦| G[é™çº§åˆ°æ–‡ä»¶ç¼“å­˜]
C --> |å¦| G
B --> |å¦| H[ä½¿ç”¨æ–‡ä»¶ç¼“å­˜]
F --> I[ç»“æŸ]
G --> I
H --> I
```

**Diagram sources**
- [__init__.py](file://tradingagents/dataflows/cache/__init__.py#L77-L114)

## é…ç½®éªŒè¯
é…ç½®å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤éªŒè¯ç¼“å­˜ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

### æ£€æŸ¥ç¼“å­˜ç­–ç•¥
å¯ä»¥é€šè¿‡æ—¥å¿—ç¡®è®¤ç¼“å­˜ç³»ç»Ÿåˆå§‹åŒ–çŠ¶æ€ï¼š

```python
def _log_cache_status(self):
    """è®°å½•ç¼“å­˜çŠ¶æ€"""
    if self.use_adaptive:
        backend = self.adaptive_cache.primary_backend
        mongodb_available = self.db_manager.is_mongodb_available()
        redis_available = self.db_manager.is_redis_available()
        
        self.logger.info(f"ğŸ“Š ç¼“å­˜é…ç½®:")
        self.logger.info(f"  ä¸»è¦åç«¯: {backend}")
        self.logger.info(f"  MongoDB: {'âœ… å¯ç”¨' if mongodb_available else 'âŒ ä¸å¯ç”¨'}")
        self.logger.info(f"  Redis: {'âœ… å¯ç”¨' if redis_available else 'âŒ ä¸å¯ç”¨'}")
        self.logger.info(f"  é™çº§æ”¯æŒ: {'âœ… å¯ç”¨' if self.adaptive_cache.fallback_enabled else 'âŒ ç¦ç”¨'}")
    else:
        self.logger.info("ğŸ“ ä½¿ç”¨ä¼ ç»Ÿæ–‡ä»¶ç¼“å­˜ç³»ç»Ÿ")
```

**Section sources**
- [integrated.py](file://tradingagents/dataflows/cache/integrated.py#L58-L72)

### è·å–ç¼“å­˜ç»Ÿè®¡
å¯ä»¥é€šè¿‡`get_cache_stats()`æ–¹æ³•è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ï¼š

```python
def get_cache_stats(self) -> Dict[str, Any]:
    """è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯"""
    if self.use_adaptive:
        # è·å–è‡ªé€‚åº”ç¼“å­˜ç»Ÿè®¡ï¼ˆå·²ç»æ˜¯æ ‡å‡†æ ¼å¼ï¼‰
        stats = self.adaptive_cache.get_cache_stats()
        
        # æ·»åŠ ç¼“å­˜ç³»ç»Ÿä¿¡æ¯
        stats['cache_system'] = 'adaptive'
        
        # ç¡®ä¿åç«¯ä¿¡æ¯å­˜åœ¨
        if 'backend_info' not in stats:
            stats['backend_info'] = {}
        
        stats['backend_info']['database_available'] = self.db_manager.is_database_available()
        stats['backend_info']['mongodb_available'] = self.db_manager.is_mongodb_available()
        stats['backend_info']['redis_available'] = self.db_manager.is_redis_available()
        
        return stats
    else:
        # è¿”å›ä¼ ç»Ÿç¼“å­˜ç»Ÿè®¡ï¼ˆå·²ç»æ˜¯æ ‡å‡†æ ¼å¼ï¼‰
        stats = self.legacy_cache.get_cache_stats()
        
        # æ·»åŠ ç¼“å­˜ç³»ç»Ÿä¿¡æ¯
        stats['cache_system'] = 'legacy'
        
        # ç¡®ä¿åç«¯ä¿¡æ¯å­˜åœ¨
        if 'backend_info' not in stats:
            stats['backend_info'] = {}
        
        stats['backend_info']['database_available'] = False
        stats['backend_info']['mongodb_available'] = False
        stats['backend_info']['redis_available'] = False
        
        return stats
```

**Section sources**
- [integrated.py](file://tradingagents/dataflows/cache/integrated.py#L230-L263)

## æ€§èƒ½æ¨¡å¼è¯´æ˜
æ ¹æ®ä¸åŒçš„é…ç½®ç»„åˆï¼Œç³»ç»Ÿä¼šè¿›å…¥ä¸åŒçš„æ€§èƒ½æ¨¡å¼ã€‚

### é«˜æ€§èƒ½æ¨¡å¼
å½“Rediså’ŒMongoDBéƒ½å¯ç”¨æ—¶ï¼Œç³»ç»Ÿè¿›å…¥é«˜æ€§èƒ½æ¨¡å¼ï¼š

```python
def get_performance_mode(self) -> str:
    """è·å–æ€§èƒ½æ¨¡å¼"""
    if not self.use_adaptive:
        return "åŸºç¡€æ¨¡å¼ (æ–‡ä»¶ç¼“å­˜)"
    
    mongodb_available = self.db_manager.is_mongodb_available()
    redis_available = self.db_manager.is_redis_available()
    
    if redis_available and mongodb_available:
        return "é«˜æ€§èƒ½æ¨¡å¼ (Redis + MongoDB + æ–‡ä»¶)"
    elif redis_available:
        return "å¿«é€Ÿæ¨¡å¼ (Redis + æ–‡ä»¶)"
    elif mongodb_available:
        return "æŒä¹…åŒ–æ¨¡å¼ (MongoDB + æ–‡ä»¶)"
    else:
        return "æ ‡å‡†æ¨¡å¼ (æ™ºèƒ½æ–‡ä»¶ç¼“å­˜)"
```

**Section sources**
- [integrated.py](file://tradingagents/dataflows/cache/integrated.py#L364-L379)

### æ€§èƒ½æ¨¡å¼å¯¹æ¯”
ä¸åŒæ€§èƒ½æ¨¡å¼çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š

```mermaid
graph TD
A[é«˜æ€§èƒ½æ¨¡å¼] --> B[Redis + MongoDB + æ–‡ä»¶]
A --> C[å“åº”æ—¶é—´: <0.001ç§’]
A --> D[æ•°æ®æŒä¹…åŒ–: æ˜¯]
A --> E[å†…å­˜ç¼“å­˜: æ˜¯]
F[å¿«é€Ÿæ¨¡å¼] --> G[Redis + æ–‡ä»¶]
F --> H[å“åº”æ—¶é—´: <0.01ç§’]
F --> I[æ•°æ®æŒä¹…åŒ–: å¦]
F --> J[å†…å­˜ç¼“å­˜: æ˜¯]
K[æŒä¹…åŒ–æ¨¡å¼] --> L[MongoDB + æ–‡ä»¶]
K --> M[å“åº”æ—¶é—´: <0.1ç§’]
K --> N[æ•°æ®æŒä¹…åŒ–: æ˜¯]
K --> O[å†…å­˜ç¼“å­˜: å¦]
P[åŸºç¡€æ¨¡å¼] --> Q[çº¯æ–‡ä»¶ç¼“å­˜]
P --> R[å“åº”æ—¶é—´: <0.5ç§’]
P --> S[æ•°æ®æŒä¹…åŒ–: æ˜¯]
P --> T[å†…å­˜ç¼“å­˜: å¦]
```

**Diagram sources**
- [integrated.py](file://tradingagents/dataflows/cache/integrated.py#L364-L379)

## æ•…éšœæ’æŸ¥
### é—®é¢˜1: é›†æˆç¼“å­˜ä¸å¯ç”¨
**ç°è±¡**ï¼š
```
âš ï¸ é›†æˆç¼“å­˜ä¸å¯ç”¨ï¼Œä½¿ç”¨æ–‡ä»¶ç¼“å­˜
```

**åŸå› **ï¼š
- ç¼ºå°‘å¿…è¦çš„ä¾èµ–æ¨¡å—
- MongoDB/Redisè¿æ¥å¤±è´¥
- ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥æ˜¯å¦å®‰è£…äº†å¿…è¦çš„ä¾èµ–
2. æ£€æŸ¥MongoDB/RedisæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. éªŒè¯MONGODB_URLå’ŒREDIS_URLæ ¼å¼æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥è®¤è¯ä¿¡æ¯æ˜¯å¦æ­£ç¡®

### é—®é¢˜2: æ•°æ®åº“è¿æ¥å¤±è´¥
**ç°è±¡**ï¼š
```
âŒ MongoDBå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ...
âŒ Rediså®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ...
```

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
2. éªŒè¯ä¸»æœºåœ°å€å’Œç«¯å£æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
4. ç¡®è®¤æ•°æ®åº“æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ

**Section sources**
- [database_manager.py](file://tradingagents/config/database_manager.py#L222-L224)
- [database_manager.py](file://tradingagents/config/database_manager.py#L246-L247)