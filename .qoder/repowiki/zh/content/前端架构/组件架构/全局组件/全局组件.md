# 全局组件

<cite>
**本文档引用的文件**
- [GlobalConfirm.vue](file://frontend/src/components/Global/GlobalConfirm.vue)
- [GlobalNotification.vue](file://frontend/src/components/Global/GlobalNotification.vue)
- [MarketSelector.vue](file://frontend/src/components/Global/MarketSelector.vue)
- [MultiMarketStockSearch.vue](file://frontend/src/components/Global/MultiMarketStockSearch.vue)
- [TaskReportDialog.vue](file://frontend/src/components/Global/TaskReportDialog.vue)
- [TaskResultDialog.vue](file://frontend/src/components/Global/TaskResultDialog.vue)
- [TaskCenter.vue](file://frontend/src/views/Tasks/TaskCenter.vue)
- [multiMarket.ts](file://frontend/src/api/multiMarket.ts)
- [multi_market_stocks.py](file://app/routers/multi_market_stocks.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心全局组件](#核心全局组件)
3. [用户交互组件](#用户交互组件)
4. [多市场股票选择组件](#多市场股票选择组件)
5. [任务结果展示组件](#任务结果展示组件)
6. [使用示例与最佳实践](#使用示例与最佳实践)
7. [总结](#总结)

## 简介
本文档详细解析了系统中的全局通用组件，重点描述了`GlobalConfirm`和`GlobalNotification`组件如何实现统一的用户交互体验，`MarketSelector`和`MultiMarketStockSearch`组件如何支持多市场股票选择功能，以及`TaskReportDialog`和`TaskResultDialog`组件在任务结果展示中的作用。文档将解释这些组件的props、events设计，以及如何在不同业务场景中复用，并提供使用示例和最佳实践。

## 核心全局组件
系统中的全局组件被设计为可复用的UI元素，位于`frontend/src/components/Global/`目录下。这些组件遵循统一的设计规范和交互模式，确保了整个应用的一致性体验。主要的全局组件包括：
- `GlobalConfirm`: 全局确认对话框，用于关键操作的二次确认
- `GlobalNotification`: 全局通知系统，用于向用户传递重要信息
- `MarketSelector`: 市场选择器，支持多市场切换
- `MultiMarketStockSearch`: 多市场股票搜索组件，集成了市场选择和股票搜索功能
- `TaskReportDialog`: 任务报告详情对话框，用于展示完整的分析报告
- `TaskResultDialog`: 任务结果对话框，用于快速查看任务的核心结果

这些组件通过统一的API设计和事件机制，实现了高度的可复用性和灵活性。

## 用户交互组件

### GlobalConfirm 组件
`GlobalConfirm`组件是系统中的全局确认对话框，用于在执行关键操作（如删除、修改等）前获取用户的二次确认。该组件通过统一的交互模式，确保了用户操作的安全性。

**组件属性 (Props)**
- 该组件使用标准的Element Plus对话框模式，通过`v-model`控制显示状态

**组件事件 (Events)**
- 通过`emit`机制触发`close`事件来关闭对话框
- 确认和取消操作通过对话框内置的按钮处理

**Section sources**
- [GlobalConfirm.vue](file://frontend/src/components/Global/GlobalConfirm.vue)

### GlobalNotification 组件
`GlobalNotification`组件是系统的全局通知中心，用于向用户展示系统消息、操作反馈和重要提醒。该组件与后端的WebSocket通知系统集成，实现了实时的消息推送。

**后端通知服务**
后端通过`notifications_service.py`中的`create_and_publish`方法创建通知，并通过WebSocket实时推送给前端。通知包含类型、标题、内容、链接、来源、严重程度等信息。

**前端通知管理**
前端通过`stores/notifications.ts`管理通知状态，并在`GlobalNotification`组件中展示。用户可以标记单个或全部通知为已读。

**Section sources**
- [GlobalNotification.vue](file://frontend/src/components/Global/GlobalNotification.vue)
- [notifications_service.py](file://app/services/notifications_service.py)
- [notifications.ts](file://frontend/src/api/notifications.ts)

## 多市场股票选择组件

### MarketSelector 组件
`MarketSelector`组件是一个下拉选择器，允许用户在不同股票市场之间进行切换。目前支持A股(CN)、港股(HK)和美股(US)三个市场。

**组件属性 (Props)**
- `modelValue`: 双向绑定的选中市场代码，默认为'CN'
- `placeholder`: 占位符文本，默认为'选择市场'
- `size`: 选择器大小，可选'large'、'default'、'small'，默认为'default'
- `clearable`: 是否可清空，默认为false
- `disabled`: 是否禁用，默认为false

**组件事件 (Events)**
- `update:modelValue`: 当选中值改变时触发，用于v-model双向绑定
- `change`: 当选中值改变时触发，传递新的市场代码

**组件实现**
组件使用Element Plus的`el-select`和`el-option`组件构建，每个选项包含国旗emoji和市场名称。市场数据在组件内部定义，包括市场代码、标签和国旗。

**Section sources**
- [MarketSelector.vue](file://frontend/src/components/Global/MarketSelector.vue)

### MultiMarketStockSearch 组件
`MultiMarketStockSearch`组件是一个复合组件，集成了`MarketSelector`和股票搜索功能，为用户提供了一站式的多市场股票搜索体验。

**组件属性 (Props)**
- 该组件无自定义props，所有状态在组件内部管理

**组件事件 (Events)**
- `select`: 当用户选择一个股票时触发，传递选中的股票信息对象

**组件实现**
组件由两部分组成：顶部的市场选择器和搜索输入框，以及底部的搜索结果列表。实现特点包括：
- **防抖搜索**: 使用500ms的防抖机制，避免频繁的API调用
- **市场联动**: 切换市场时自动清空搜索结果
- **格式化显示**: 港股代码自动格式化为5位（如00700）
- **丰富结果**: 搜索结果包含股票代码、名称、市场、行业和PE等信息

**后端API支持**
前端通过`multiMarket.ts`中的`searchStocks`方法调用后端API，后端在`multi_market_stocks.py`中提供`/api/multi_market_stocks/{market}/stocks/search`接口，支持按市场和关键词搜索股票。

**Section sources**
- [MultiMarketStockSearch.vue](file://frontend/src/components/Global/MultiMarketStockSearch.vue)
- [multiMarket.ts](file://frontend/src/api/multiMarket.ts)
- [multi_market_stocks.py](file://app/routers/multi_market_stocks.py)

## 任务结果展示组件

### TaskReportDialog 组件
`TaskReportDialog`组件用于展示完整的任务分析报告，支持多标签页的报告内容展示。

**组件属性 (Props)**
- `modelValue`: 控制对话框显示状态的v-model值
- `sections`: 报告的章节数组，每个章节包含标题和内容

**组件事件 (Events)**
- `update:modelValue`: 用于v-model双向绑定
- `close`: 当用户关闭对话框时触发

**组件实现**
组件使用Element Plus的`el-dialog`和`el-tabs`组件构建。每个章节作为一个标签页，内容支持Markdown渲染和JSON格式化显示。通过`marked`库将Markdown内容转换为HTML进行展示。

**Section sources**
- [TaskReportDialog.vue](file://frontend/src/components/Global/TaskReportDialog.vue)

### TaskResultDialog 组件
`TaskResultDialog`组件用于快速查看任务的核心结果，提供简洁的结果预览和查看完整报告的入口。

**组件属性 (Props)**
- `modelValue`: 控制对话框显示状态的v-model值
- `result`: 任务结果对象，包含建议和摘要

**组件事件 (Events)**
- `update:modelValue`: 用于v-model双向绑定
- `close`: 当用户关闭对话框时触发
- `view-report`: 当用户点击"查看报告详情"时触发

**组件实现**
组件使用Element Plus的`el-dialog`构建，展示任务的建议和摘要内容。内容同样支持Markdown渲染。底部提供"关闭"和"查看报告详情"两个操作按钮，方便用户进一步操作。

**实际应用**
在`TaskCenter.vue`中，`TaskResultDialog`被用于任务中心的"查看结果"功能。当用户点击"查看结果"按钮时，系统获取任务结果并显示在对话框中。

```mermaid
flowchart TD
A[用户点击"查看结果"] --> B[调用getTaskResult API]
B --> C{API调用成功?}
C --> |是| D[设置currentResult数据]
C --> |否| E[显示错误消息]
D --> F[显示TaskResultDialog]
F --> G[用户查看建议和摘要]
G --> H{用户操作}
H --> I[点击"关闭" -> 隐藏对话框]
H --> J[点击"查看报告详情" -> 打开报告页面]
```

**Diagram sources**
- [TaskResultDialog.vue](file://frontend/src/components/Global/TaskResultDialog.vue)
- [TaskCenter.vue](file://frontend/src/views/Tasks/TaskCenter.vue)

## 使用示例与最佳实践

### GlobalConfirm 使用示例
```vue
<template>
  <el-button @click="showConfirm = true">删除任务</el-button>
  <GlobalConfirm v-model="showConfirm" />
</template>
```

**最佳实践**
- 在执行删除、修改等关键操作前使用
- 提供清晰的确认信息，避免用户误操作
- 保持确认对话框的样式和交互一致性

### MultiMarketStockSearch 使用示例
```vue
<template>
  <MultiMarketStockSearch @select="onStockSelected" />
</template>

<script setup>
const onStockSelected = (stock) => {
  console.log('选中的股票:', stock)
  // 处理选中的股票
}
</script>
```

**最佳实践**
- 将组件用于需要选择股票的任何场景
- 利用防抖机制优化性能
- 处理搜索失败的情况，提供友好的错误提示

### TaskResultDialog 使用示例
```vue
<template>
  <TaskResultDialog 
    v-model="resultVisible" 
    :result="taskResult" 
    @close="handleClose"
    @view-report="handleViewReport"
  />
</template>
```

**最佳实践**
- 用于快速预览任务结果，避免用户频繁打开完整报告
- 保持建议和摘要内容的简洁明了
- 提供明确的下一步操作指引

## 总结
本文档详细解析了系统中的全局通用组件，包括用户交互组件、多市场股票选择组件和任务结果展示组件。这些组件通过统一的设计和实现，为系统提供了良好的用户体验和开发效率。通过合理使用这些组件，开发者可以快速构建功能丰富、交互一致的用户界面，同时确保了代码的可维护性和可复用性。