# 业务接口层

<cite>
**本文档引用的文件**   
- [stocks.ts](file://frontend/src/api/stocks.ts)
- [analysis.ts](file://frontend/src/api/analysis.ts)
- [config.ts](file://frontend/src/api/config.ts)
- [scheduler.ts](file://frontend/src/api/scheduler.ts)
- [paper.ts](file://frontend/src/api/paper.ts)
- [request.ts](file://frontend/src/api/request.ts)
- [analysis.ts](file://frontend/src/types/analysis.ts)
- [config.ts](file://frontend/src/types/config.ts)
</cite>

## 目录
1. [引言](#引言)
2. [股票数据服务](#股票数据服务)
3. [分析服务](#分析服务)
4. [配置管理服务](#配置管理服务)
5. [任务调度服务](#任务调度服务)
6. [模拟交易服务](#模拟交易服务)
7. [API客户端与错误处理](#api客户端与错误处理)
8. [类型安全与TypeScript实现](#类型安全与typescript实现)
9. [调用示例与最佳实践](#调用示例与最佳实践)
10. [API版本管理与向后兼容性](#api版本管理与向后兼容性)

## 引言
本接口层文档旨在系统性地介绍sagacity前端各业务模块的API服务。文档详细说明了股票数据查询、实时行情获取、单股/批量分析调用、系统配置管理、任务调度控制以及模拟交易操作等核心接口。通过结合前端API定义和类型系统，本文档解释了各API的参数结构、返回数据格式和错误码，并展示了TypeScript类型安全的实现方式。同时，文档提供了各业务场景的调用示例，包括分页处理、筛选条件构造和WebSocket连接建立等，以及API版本管理策略和向后兼容性保障措施。

## 股票数据服务

股票数据服务提供了对股票行情、基本面、K线和新闻数据的查询接口。这些接口通过`stocksApi`对象暴露，每个方法都使用了泛型来确保类型安全。

### 接口定义
- **getQuote**: 获取股票行情
- **getFundamentals**: 获取股票基本面数据
- **getKline**: 获取K线数据
- **getNews**: 获取股票新闻

### 参数与返回结构
- `getQuote(symbol: string)`: 接收6位股票代码，返回`QuoteResponse`类型，包含价格、涨跌幅、成交量等实时行情数据。
- `getFundamentals(symbol: string)`: 接收6位股票代码，返回`FundamentalsResponse`类型，包含市盈率(PE)、市净率(PB)、市销率(PS)等财务指标。
- `getKline(symbol: string, period: 'day'|'week'|'month'|'5m'|'15m'|'30m'|'60m', limit = 120, adj: 'none'|'qfq'|'hfq')`: 接收股票代码、周期、条数和复权方式，返回`KlineResponse`类型，包含指定周期的K线数据。
- `getNews(symbol: string, days = 30, limit = 50, includeAnnouncements = true)`: 接收股票代码、天数、数量限制和是否包含公告，返回`NewsResponse`类型，包含相关新闻列表。

**Section sources**
- [stocks.ts](file://frontend/src/api/stocks.ts#L83-L121)

## 分析服务

分析服务提供了单股和批量分析的调用接口，支持获取分析进度、结果和历史记录。该服务通过`analysisApi`对象提供，支持复杂的分析请求和进度跟踪。

### 接口定义
- **startAnalysis**: 开始单股分析
- **getProgress**: 获取分析进度
- **getResult**: 获取分析结果
- **getHistory**: 获取分析历史
- **startBatchAnalysis**: 开始批量分析

### 参数与返回结构
- `startAnalysis(analysisRequest: AnalysisRequest)`: 接收`AnalysisRequest`类型的请求对象，包含市场类型、股票代码、分析日期、分析类型、数据源、分析深度等参数，返回包含分析ID的响应。
- `getProgress(analysisId: string)`: 接收分析ID，返回`AnalysisProgress`类型，包含当前状态、进度百分比、当前步骤和详细步骤列表。
- `getResult(analysisId: string)`: 接收分析ID，返回`AnalysisResult`类型，包含分析摘要、技术分析、基本面分析、情绪分析、推荐和评分等详细结果。
- `getHistory(params?: { page?: number; page_size?: number; market_type?: string; symbol?: string })`: 接收分页和筛选参数，返回`AnalysisHistory`类型，包含分析历史列表和分页信息。
- `startBatchAnalysis(batchRequest: { title: string; description?: string; symbols?: string[]; parameters?: SingleAnalysisRequest['parameters'] })`: 接收批量分析请求，返回包含批次ID和任务ID列表的响应。

**Section sources**
- [analysis.ts](file://frontend/src/api/analysis.ts#L119-L227)

## 配置管理服务

配置管理服务提供了对大模型厂家、模型配置、数据源配置和数据库配置的管理接口。该服务通过`configApi`对象提供，支持配置的增删改查和测试。

### 接口定义
- **getSystemConfig**: 获取系统配置
- **getLLMProviders**: 获取所有大模型厂家
- **addLLMProvider**: 添加大模型厂家
- **getLLMConfigs**: 获取所有大模型配置
- **updateLLMConfig**: 更新大模型配置
- **getDataSourceConfigs**: 获取所有数据源配置
- **addDataSourceConfig**: 添加数据源配置
- **getDatabaseConfigs**: 获取所有数据库配置
- **addDatabaseConfig**: 添加数据库配置

### 参数与返回结构
- `getSystemConfig()`: 返回`SystemConfig`类型，包含LLM配置、数据源配置、数据库配置和系统设置。
- `getLLMProviders()`: 返回`LLMProvider[]`类型，包含所有大模型厂家的详细信息。
- `addLLMProvider(provider: Partial<LLMProvider>)`: 接收部分`LLMProvider`类型的对象，返回包含消息和ID的响应。
- `getLLMConfigs()`: 返回`LLMConfig[]`类型，包含所有大模型配置。
- `updateLLMConfig(config: Partial<LLMConfig>)`: 接收部分`LLMConfig`类型的对象，返回包含消息和模型名称的响应。
- `getDataSourceConfigs()`: 返回`DataSourceConfig[]`类型，包含所有数据源配置。
- `addDataSourceConfig(config: Partial<DataSourceConfig>)`: 接收部分`DataSourceConfig`类型的对象，返回包含消息和名称的响应。
- `getDatabaseConfigs()`: 返回`DatabaseConfig[]`类型，包含所有数据库配置。
- `addDatabaseConfig(config: Partial<DatabaseConfig>)`: 接收部分`DatabaseConfig`类型的对象，返回包含成功状态和消息的响应。

**Section sources**
- [config.ts](file://frontend/src/api/config.ts#L161-L467)

## 任务调度服务

任务调度服务提供了对定时任务的管理接口，支持获取任务列表、暂停/恢复任务、手动触发任务和查看执行历史。该服务通过`getJobs`、`pauseJob`等函数提供。

### 接口定义
- **getJobs**: 获取所有定时任务列表
- **pauseJob**: 暂停任务
- **resumeJob**: 恢复任务
- **triggerJob**: 手动触发任务
- **getJobExecutions**: 获取任务执行历史

### 参数与返回结构
- `getJobs()`: 返回`Job[]`类型，包含所有定时任务的详细信息，如任务ID、名称、下次运行时间、状态等。
- `pauseJob(jobId: string)`: 接收任务ID，无返回值，用于暂停指定任务。
- `resumeJob(jobId: string)`: 接收任务ID，无返回值，用于恢复指定任务。
- `triggerJob(jobId: string, force: boolean = true)`: 接收任务ID和强制执行标志，无返回值，用于手动触发指定任务。
- `getJobExecutions(params?: { job_id?: string; status?: 'success' | 'failed' | 'missed' | 'running'; is_manual?: boolean; limit?: number; offset?: number })`: 接收筛选参数，返回包含执行记录列表和分页信息的响应。

**Section sources**
- [scheduler.ts](file://frontend/src/api/scheduler.ts#L79-L234)

## 模拟交易服务

模拟交易服务提供了对模拟账户、持仓和订单的管理接口。该服务通过`paperApi`对象提供，支持账户查询、下单、持仓查询和订单查询。

### 接口定义
- **getAccount**: 获取账户信息
- **placeOrder**: 下单
- **getPositions**: 获取持仓
- **getOrders**: 获取订单
- **resetAccount**: 重置账户

### 参数与返回结构
- `getAccount()`: 返回`GetAccountResponse`类型，包含账户现金、已实现盈亏、持仓市值和总资产等信息。
- `placeOrder(data: PlaceOrderPayload)`: 接收`PlaceOrderPayload`类型的订单数据，包含股票代码、买卖方向、数量和分析ID，返回包含订单信息的响应。
- `getPositions()`: 返回包含持仓列表的响应。
- `getOrders(limit = 50)`: 接收数量限制，返回包含订单列表的响应。
- `resetAccount()`: 无参数，用于重置账户为初始状态，返回包含消息和现金的响应。

**Section sources**
- [paper.ts](file://frontend/src/api/paper.ts#L50-L66)

## API客户端与错误处理

API客户端通过`ApiClient`类封装了axios实例，提供了统一的请求方法和错误处理机制。客户端支持请求拦截、响应拦截、错误消息去重和401错误处理。

### 客户端实现
- **请求拦截器**: 在请求发送前添加认证头、请求ID和语言头，并处理端点兼容性。
- **响应拦截器**: 在响应返回后检查业务状态码，处理认证失败、权限不足等错误，并返回`response.data`。
- **错误处理**: 支持HTTP状态码错误（401、403、404等）和网络错误的处理，提供重试机制和错误消息显示。

### 错误码
- **401**: 认证失败，需要重新登录
- **403**: 权限不足
- **404**: 资源不存在
- **429**: 请求过于频繁
- **500**: 服务器内部错误
- **502/503/504**: 服务暂时不可用

**Section sources**
- [request.ts](file://frontend/src/api/request.ts#L492-L593)

## 类型安全与TypeScript实现

系统通过TypeScript的类型系统实现了接口的类型安全。每个API方法都使用了泛型来指定返回类型，确保了编译时的类型检查。

### 类型定义
- **ApiResponse<T>**: 通用API响应接口，包含`success`、`data`、`message`等字段。
- **RequestConfig**: 请求配置接口，扩展了`AxiosRequestConfig`，添加了`skipAuth`、`showLoading`等自定义字段。
- **业务类型**: 如`QuoteResponse`、`AnalysisResult`、`SystemConfig`等，定义了各业务接口的具体数据结构。

### 类型安全优势
- **编译时检查**: 在编译时就能发现类型错误，避免运行时错误。
- **代码提示**: 提供了良好的代码提示和自动补全功能，提高了开发效率。
- **文档化**: 类型定义本身就是一种文档，清晰地描述了数据结构。

**Section sources**
- [request.ts](file://frontend/src/api/request.ts#L8-L27)
- [types/analysis.ts](file://frontend/src/types/analysis.ts)
- [types/config.ts](file://frontend/src/types/config.ts)

## 调用示例与最佳实践

### 股票数据查询示例
```typescript
// 获取股票行情
const quote = await stocksApi.getQuote('000001')
if (quote.success) {
  console.log(quote.data.price)
}

// 获取K线数据
const kline = await stocksApi.getKline('000001', 'day', 30, 'qfq')
if (kline.success) {
  console.log(kline.data.items)
}
```

### 分析服务调用示例
```typescript
// 开始单股分析
const analysisRequest = {
  market_type: 'A股',
  stock_symbol: '000001',
  analysis_date: '2023-10-01',
  analysis_type: 'comprehensive',
  data_sources: ['tushare', 'akshare'],
  analysis_depth: 3,
  include_news: true,
  include_financials: true
}
const result = await analysisApi.startAnalysis(analysisRequest)
if (result.success) {
  const progress = await analysisApi.getProgress(result.data.analysis_id)
  console.log(progress.data.progress)
}
```

### 最佳实践
- **错误处理**: 始终检查`success`字段，处理可能的错误。
- **加载状态**: 使用`showLoading`参数显示加载状态，提升用户体验。
- **分页处理**: 在获取列表数据时，合理使用分页参数，避免一次性加载过多数据。
- **类型断言**: 在处理复杂类型时，使用类型断言确保类型安全。

**Section sources**
- [stocks.ts](file://frontend/src/api/stocks.ts)
- [analysis.ts](file://frontend/src/api/analysis.ts)

## API版本管理与向后兼容性

系统通过以下策略确保API的向后兼容性：
- **版本化API**: 在API路径中包含版本号，如`/api/v1/stocks`，允许同时维护多个版本。
- **渐进式弃用**: 对于需要修改的API，先添加新字段或方法，保持旧接口可用，逐步引导用户迁移到新接口。
- **兼容性测试**: 在发布新版本前，进行充分的兼容性测试，确保现有功能不受影响。
- **文档更新**: 及时更新API文档，明确标注已弃用的接口和推荐的替代方案。

通过这些策略，系统能够在不断演进的同时，保证现有客户端的稳定运行。

**Section sources**
- [request.ts](file://frontend/src/api/request.ts)
- [docs/changes/](file://docs/changes/)