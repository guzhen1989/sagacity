# 配置管理接口

<cite>
**本文档引用的文件**  
- [config.py](file://app/core/config.py)
- [config_service.py](file://app/services/config_service.py)
- [config.py](file://app/routers/config.py)
- [config.ts](file://frontend/src/api/config.ts)
- [config_bridge.py](file://app/core/config_bridge.py)
- [unified_config.py](file://app/core/unified_config.py)
- [config.md](file://docs/config/architecture.md)
- [api_key_utils.py](file://app/utils/api_key_utils.py)
</cite>

## 目录
1. [简介](#简介)
2. [配置数据结构](#配置数据结构)
3. [核心方法使用](#核心方法使用)
4. [配置同步机制](#配置同步机制)
5. [安全考虑](#安全考虑)
6. [配置版本管理](#配置版本管理)
7. [附录](#附录)

## 简介
本接口文档详细说明了系统配置管理的实现，包括配置的读取、更新和验证功能。系统采用分层集中式配置方案，通过数据库作为配置的单一事实来源（SoT），同时支持环境变量和文件配置。配置管理服务提供了对LLM配置、数据源配置和系统设置的全面管理能力，确保配置变更能够实时同步到整个系统。

**Section sources**
- [config.py](file://app/core/config.py#L1-L301)
- [config_service.py](file://app/services/config_service.py#L1-L800)

## 配置数据结构
系统配置由多个核心组件构成，包括LLM配置、数据源配置和系统设置。这些配置通过Pydantic模型定义，确保了类型安全和数据验证。

### LLM配置
LLM配置定义了大模型的连接参数和行为特性，包括供应商、模型名称、API密钥、超时设置等。

```mermaid
classDiagram
class LLMConfig {
+str provider
+str model_name
+Optional[str] api_key
+Optional[str] api_base
+int max_tokens
+float temperature
+int timeout
+int retry_times
+bool enabled
+Optional[str] description
+int priority
+Optional[float] input_price_per_1k
+Optional[float] output_price_per_1k
+str currency
+int capability_level
+List[str] suitable_roles
+List[str] features
+List[str] recommended_depths
+Optional[Dict[str, Any]] performance_metrics
}
```

**Diagram sources**
- [config.py](file://app/core/config.py#L22-L235)
- [config.ts](file://frontend/src/api/config.ts#L34-L65)

### 数据源配置
数据源配置定义了金融数据源的连接参数和优先级，支持多种数据源类型，包括Tushare、AKShare和Finnhub。

```mermaid
classDiagram
class DataSourceConfig {
+str name
+DataSourceType type
+Optional[str] api_key
+Optional[str] api_secret
+Optional[str] endpoint
+int timeout
+int rate_limit
+bool enabled
+int priority
+Dict[str, Any] config_params
+Optional[str] description
+Optional[List[str]] market_categories
+Optional[str] display_name
+Optional[str] provider
}
class DataSourceType {
+str TUSHARE
+str AKSHARE
+str FINNHUB
+str MONGODB
+str BAOSTOCK
}
```

**Diagram sources**
- [config.py](file://app/core/config.py#L237-L256)
- [config.ts](file://frontend/src/api/config.ts#L67-L85)

### 系统设置
系统设置包含了影响整个系统行为的运行时参数，如并发限制、缓存策略和监控配置。

```mermaid
classDiagram
class SystemConfig {
+str config_name
+str config_type
+List[LLMConfig] llm_configs
+Optional[str] default_llm
+List[DataSourceConfig] data_source_configs
+Optional[str] default_data_source
+List[DatabaseConfig] database_configs
+Dict[str, Any] system_settings
+datetime created_at
+datetime updated_at
+int version
+bool is_active
}
class SystemSettings {
+int max_concurrent_tasks
+int default_analysis_timeout
+bool enable_cache
+int cache_ttl
+str log_level
+bool enable_monitoring
+int worker_heartbeat_interval_seconds
+float queue_poll_interval_seconds
+float queue_cleanup_interval_seconds
+float sse_poll_timeout_seconds
+int sse_heartbeat_interval_seconds
+int sse_task_max_idle_seconds
+float sse_batch_poll_interval_seconds
+int sse_batch_max_idle_seconds
+float ta_hk_min_request_interval_seconds
+int ta_hk_timeout_seconds
+int ta_hk_max_retries
+int ta_hk_rate_limit_wait_seconds
+int ta_hk_cache_ttl_seconds
+bool ta_use_app_cache
+float ta_china_min_api_interval_seconds
+float ta_us_min_api_interval_seconds
+float ta_google_news_sleep_min_seconds
+float ta_google_news_sleep_max_seconds
+str app_timezone
}
```

**Diagram sources**
- [config.py](file://app/core/config.py#L323-L351)
- [config_service.py](file://app/services/config_service.py#L362-L381)

## 核心方法使用
配置管理接口提供了`getConfig`、`updateConfig`和`validateConfig`等核心方法，用于配置的读取、更新和验证。

### 获取配置
`getConfig`方法用于获取当前的系统配置，优先从数据库读取最新数据。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Router as "配置路由"
participant Service as "配置服务"
participant DB as "数据库"
Client->>Router : GET /api/config/system
Router->>Service : get_system_config()
Service->>DB : 查询激活的配置
DB-->>Service : 返回配置数据
Service-->>Router : SystemConfig对象
Router-->>Client : 返回脱敏后的配置
```

**Diagram sources**
- [config.py](file://app/routers/config.py#L171-L197)
- [config_service.py](file://app/services/config_service.py#L362-L381)

### 更新配置
`updateConfig`方法用于更新系统配置，支持LLM配置、数据源配置和系统设置的更新。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Router as "配置路由"
participant Service as "配置服务"
participant DB as "数据库"
Client->>Router : POST /api/config/llm
Router->>Service : update_llm_config(llm_config)
Service->>DB : 保存新配置
DB-->>Service : 保存成功
Service-->>Router : 返回结果
Router-->>Client : 返回更新结果
```

**Diagram sources**
- [config.py](file://app/routers/config.py#L582-L688)
- [config_service.py](file://app/services/config_service.py#L516-L573)

### 验证配置
`validateConfig`方法用于验证配置的有效性，确保配置值符合预期格式和范围。

```mermaid
flowchart TD
Start([开始验证]) --> ValidateInput["验证输入参数"]
ValidateInput --> InputValid{"输入有效?"}
InputValid --> |否| ReturnError["返回错误信息"]
InputValid --> |是| CheckLLM["验证LLM配置"]
CheckLLM --> LLMValid{"LLM配置有效?"}
LLMValid --> |否| ReturnError
LLMValid --> |是| CheckDataSource["验证数据源配置"]
CheckDataSource --> DSValid{"数据源配置有效?"}
DSValid --> |否| ReturnError
DSValid --> |是| CheckSystem["验证系统设置"]
CheckSystem --> SysValid{"系统设置有效?"}
SysValid --> |否| ReturnError
SysValid --> |是| ReturnSuccess["返回验证成功"]
ReturnError --> End([结束])
ReturnSuccess --> End
```

**Diagram sources**
- [config.py](file://app/routers/config.py#L470-L481)
- [config_service.py](file://app/services/config_service.py#L771-L778)

## 配置同步机制
系统采用配置桥接机制，将数据库中的配置实时同步到环境变量，确保配置变更能够立即生效。

```mermaid
graph TD
subgraph "配置源"
DB[(数据库)]
ENV[环境变量]
end
subgraph "配置管理"
ConfigService[配置服务]
UnifiedConfig[统一配置管理器]
ConfigBridge[配置桥接器]
end
subgraph "应用组件"
TradingAgents[TradingAgents]
WebAPI[WebAPI]
end
DB --> ConfigService
ConfigService --> UnifiedConfig
UnifiedConfig --> ConfigBridge
ConfigBridge --> ENV
ENV --> TradingAgents
ENV --> WebAPI
ConfigService --> |实时同步| ConfigBridge
```

**Diagram sources**
- [config_bridge.py](file://app/core/config_bridge.py#L15-L287)
- [unified_config.py](file://app/core/unified_config.py#L34-L500)

## 安全考虑
系统在配置管理中实施了多项安全措施，保护敏感信息并防止配置泄露。

### 敏感信息保护
- API响应对敏感字段进行脱敏处理
- REST接口写入时不接受敏感字段
- 导出配置时对敏感项清空
- 生产环境不在数据库中持久化明文密钥

```mermaid
flowchart TD
Request["API请求"] --> CheckSensitive["检查敏感字段"]
CheckSensitive --> |包含敏感字段| RemoveSensitive["移除或清空"]
CheckSensitive --> |不包含| Process["正常处理"]
RemoveSensitive --> Process
Process --> GenerateResponse["生成响应"]
GenerateResponse --> Sanitize["脱敏处理"]
Sanitize --> SendResponse["发送响应"]
```

**Diagram sources**
- [config.py](file://app/routers/config.py#L83-L160)
- [api_key_utils.py](file://app/utils/api_key_utils.py#L11-L165)

### 配置验证
系统在启动时进行配置验证，确保必需的配置项已正确设置。

```mermaid
flowchart TD
Start([启动验证]) --> CheckRequired["检查必需配置"]
CheckRequired --> MissingRequired{"缺少必需配置?"}
MissingRequired --> |是| LogError["记录错误"]
MissingRequired --> |否| CheckRecommended["检查推荐配置"]
CheckRecommended --> MissingRecommended{"缺少推荐配置?"}
MissingRecommended --> |是| LogWarning["记录警告"]
MissingRecommended --> |否| CheckSecurity["检查安全配置"]
CheckSecurity --> SecurityIssues{"存在安全问题?"}
SecurityIssues --> |是| LogWarning
SecurityIssues --> |否| Success["验证成功"]
LogError --> End([结束])
LogWarning --> End
Success --> End
```

**Diagram sources**
- [startup_validator.py](file://app/core/startup_validator.py#L158-L276)
- [config.md](file://docs/config/architecture.md#L1-L39)

## 配置版本管理
系统通过版本号和激活状态管理配置，支持配置的历史追溯和回滚。

### 配置版本结构
```mermaid
classDiagram
class SystemConfig {
+str config_name
+str config_type
+List[LLMConfig] llm_configs
+Optional[str] default_llm
+List[DataSourceConfig] data_source_configs
+Optional[str] default_data_source
+List[DatabaseConfig] database_configs
+Dict[str, Any] system_settings
+datetime created_at
+datetime updated_at
+int version
+bool is_active
}
SystemConfig --> SystemConfig : "版本历史"
```

**Diagram sources**
- [config.py](file://app/models/config.py#L323-L351)
- [config_service.py](file://app/services/config_service.py#L516-L573)

### 版本管理流程
```mermaid
sequenceDiagram
participant Admin as "管理员"
participant Router as "配置路由"
participant Service as "配置服务"
participant DB as "数据库"
Admin->>Router : 保存新配置
Router->>Service : save_system_config(config)
Service->>DB : 查询当前激活配置
DB-->>Service : 返回当前配置
Service->>Service : 禁用当前配置
Service->>Service : 递增版本号
Service->>DB : 插入新配置
DB-->>Service : 保存成功
Service-->>Router : 返回结果
Router-->>Admin : 配置保存成功
```

**Diagram sources**
- [config_service.py](file://app/services/config_service.py#L516-L573)
- [config.py](file://app/routers/config.py#L749-L750)

## 附录
### 配置优先级
配置的优先级顺序如下（从高到低）：
1. 请求级覆盖（仅本次请求生效）
2. 用户/租户偏好（数据库）
3. 系统运营参数（数据库）
4. 环境变量/.env
5. 代码默认值

### SoT模式开关
`Settings.CONFIG_SOT`参数控制配置的单一事实来源模式：
- `file`：以文件/env为准（推荐，生产缺省）
- `db`：以数据库为准（仅兼容旧版，不推荐）
- `hybrid`：文件/env优先，DB兜底

**Section sources**
- [config.md](file://docs/config/architecture.md#L1-L39)
- [config.py](file://app/core/config.py#L145-L149)