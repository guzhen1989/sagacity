# 增量同步

<cite>
**本文档引用的文件**   
- [akshare_sync_service.py](file://app/worker/akshare_sync_service.py)
- [tushare_sync_service.py](file://app/worker/tushare_sync_service.py)
- [historical_data_service.py](file://app/services/historical_data_service.py)
- [data_consistency_checker.py](file://app/services/data_consistency_checker.py)
- [database.py](file://app/core/database.py)
</cite>

## 目录
1. [增量同步机制](#增量同步机制)
2. [数据一致性处理](#数据一致性处理)
3. [性能优化策略](#性能优化策略)
4. [全量与增量同步切换](#全量与增量同步切换)

## 增量同步机制

该系统通过时间戳和版本号实现增量数据更新。在数据库中记录最后同步时间点的实现方式是通过`_get_last_sync_date`方法获取特定股票的最新日期，然后返回最后日期的下一天作为起始同步日期，避免重复同步。增量同步的触发条件是`incremental`参数为True，判断逻辑是通过比较数据源之间的差异百分比与容忍度阈值来识别新增或变更的数据记录。查询条件构建、数据比对和更新策略在`_process_historical_batch`方法中实现，该方法会根据股票代码、交易日期、数据源和周期等条件进行批量操作。

**Section sources**
- [akshare_sync_service.py](file://app/worker/akshare_sync_service.py#L632-L697)
- [tushare_sync_service.py](file://app/worker/tushare_sync_service.py#L627-L741)

## 数据一致性处理

系统通过`DataConsistencyChecker`类处理多数据源之间的数据不一致性问题。该类设置了各种指标的容忍度阈值，如PE允许5%差异、PB允许5%差异、市值允许2%差异等。关键指标权重用于计算置信度分数，如PE占0.25、PB占0.25、总市值占0.20等。数据一致性检查结果包括是否一致、主数据源、次数据源、差异、置信度分数、推荐操作和详细信息。根据一致性检查结果解决数据冲突，如果置信度分数大于0.8，则使用任一数据源；如果大于0.6，则使用主数据源但发出警告；如果大于0.3，则仅使用主数据源；否则需要调查数据源问题。

**Section sources**
- [data_consistency_checker.py](file://app/services/data_consistency_checker.py#L1-L319)

## 性能优化策略

系统通过索引优化和批量处理策略提高性能。在`_ensure_indexes`方法中，为历史数据集合创建了复合唯一索引，包括股票代码、交易日期、数据源和周期，以提升查询和upsert性能。批量处理策略在`save_historical_data`方法中实现，将操作列表分批执行，每批200条记录，避免超时。此外，还实现了重试机制，在批量写入超时时进行指数退避重试，等待时间分别为3秒、9秒、27秒、81秒。这些优化措施显著提高了数据同步的效率和稳定性。

**Section sources**
- [historical_data_service.py](file://app/services/historical_data_service.py#L40-L69)
- [database.py](file://app/core/database.py#L347-L369)

## 全量与增量同步切换

系统通过`all_history`参数控制全量与增量同步的切换。当`all_history`为True时，从1990-01-01开始同步所有历史数据；当为False且`incremental`为True时，从各股票最后日期开始增量同步；当两者都为False时，从最近一年开始全量同步。这种机制允许用户根据需要选择不同的同步模式，既保证了数据的完整性，又提高了同步效率。在数据不一致情况下，系统会自动修复，通过检查数据源之间的差异并根据置信度分数决定使用哪个数据源，确保数据的一致性和准确性。

**Section sources**
- [tushare_sync_service.py](file://app/worker/tushare_sync_service.py#L568-L624)