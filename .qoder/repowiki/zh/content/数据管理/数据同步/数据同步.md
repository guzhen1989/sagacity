# 数据同步

<cite>
**本文档引用的文件**  
- [data_consistency_checker.py](file://app/services/data_consistency_checker.py)
- [multi_source_basics_sync_service.py](file://app/services/multi_source_basics_sync_service.py)
- [tushare_sync_service.py](file://app/worker/tushare_sync_service.py)
- [akshare_sync_service.py](file://app/worker/akshare_sync_service.py)
- [baostock_sync_service.py](file://app/worker/baostock_sync_service.py)
- [manager.py](file://app/services/data_sources/manager.py)
- [multi_source_sync.py](file://app/routers/multi_source_sync.py)
- [sync.py](file://app/routers/sync.py)
- [multi_period_sync_service.py](file://app/worker/multi_period_sync_service.py)
- [scheduler_service.py](file://app/services/scheduler_service.py)
</cite>

## 目录
1. [引言](#引言)
2. [多数据源获取机制](#多数据源获取机制)
3. [数据优先级与冲突解决](#数据优先级与冲突解决)
4. [定时同步任务调度](#定时同步任务调度)
5. [增量与全量同步实现](#增量与全量同步实现)
6. [错误重试与断点续传](#错误重试与断点续传)
7. [数据一致性检查](#数据一致性检查)
8. [性能优化策略](#性能优化策略)
9. [同步服务调用示例](#同步服务调用示例)

## 引言
本文档详细介绍了数据同步服务的核心功能与实现机制。该服务旨在通过整合Tushare、AkShare和BaoStock等多个数据源，实现股票基础信息、行情数据、财务数据和新闻资讯的高效同步。系统采用多数据源优先级策略和数据冲突解决机制，确保数据的准确性和完整性。通过Apscheduler实现定时同步任务的调度，并支持增量同步与全量同步两种模式。此外，系统还提供了错误重试、断点续传和数据一致性检查等高级功能，以保障数据同步的稳定性和可靠性。

## 多数据源获取机制
数据同步服务通过多个数据源获取股票相关信息，包括基础信息、行情数据、财务数据和新闻资讯。每个数据源都有其特定的适配器，负责与数据源进行交互。

### Tushare数据源
Tushare是一个专业的金融数据API，提供高质量的A股数据和财务指标。TushareSyncService类负责与Tushare数据源进行交互，支持股票基础信息、实时行情、历史数据和财务数据的同步。

```mermaid
classDiagram
class TushareSyncService {
+provider : TushareProvider
+stock_service : StockDataService
+historical_service : HistoricalDataService
+news_service : NewsDataService
+db : AsyncIOMotorDatabase
+settings : Settings
+batch_size : int
+rate_limit_delay : float
+max_retries : int
+rate_limiter : RateLimiter
+initialize() : Coroutine
+sync_stock_basic_info(force_update : bool, job_id : str) : Dict[str, Any]
+sync_realtime_quotes(symbols : List[str], force : bool) : Dict[str, Any]
+sync_historical_data(symbols : List[str], start_date : str, end_date : str, incremental : bool, all_history : bool, period : str, job_id : str) : Dict[str, Any]
+sync_financial_data(symbols : List[str], job_id : str) : Dict[str, Any]
}
```

**Diagram sources**
- [tushare_sync_service.py](file://app/worker/tushare_sync_service.py#L35-L789)

### AkShare数据源
AkShare是一个开源的金融数据库，提供基础的股票信息。AKShareSyncService类负责与AkShare数据源进行交互，支持股票基础信息、实时行情、历史数据和财务数据的同步。

```mermaid
classDiagram
class AKShareSyncService {
+provider : AKShareProvider
+historical_service : HistoricalDataService
+news_service : NewsDataService
+db : AsyncIOMotorDatabase
+batch_size : int
+rate_limit_delay : float
+initialize() : Coroutine
+sync_stock_basic_info(force_update : bool) : Dict[str, Any]
+sync_realtime_quotes(symbols : List[str], force : bool) : Dict[str, Any]
+sync_historical_data(start_date : str, end_date : str, symbols : List[str], incremental : bool, period : str) : Dict[str, Any]
+sync_financial_data(symbols : List[str]) : Dict[str, Any]
}
```

**Diagram sources**
- [akshare_sync_service.py](file://app/worker/akshare_sync_service.py#L18-L800)

### BaoStock数据源
BaoStock是一个免费的证券数据平台，提供历史数据。BaoStockSyncService类负责与BaoStock数据源进行交互，支持股票基础信息、日K线数据和历史数据的同步。

```mermaid
classDiagram
class BaoStockSyncService {
+settings : Settings
+provider : BaoStockProvider
+historical_service : HistoricalDataService
+db : AsyncIOMotorDatabase
+sync_stock_basic_info(batch_size : int) : BaoStockSyncStats
+sync_daily_quotes(batch_size : int) : BaoStockSyncStats
+sync_historical_data(days : int, batch_size : int, period : str, incremental : bool) : BaoStockSyncStats
}
```

**Diagram sources**
- [baostock_sync_service.py](file://app/worker/baostock_sync_service.py#L34-L608)

**Section sources**
- [tushare_sync_service.py](file://app/worker/tushare_sync_service.py#L1-L1360)
- [akshare_sync_service.py](file://app/worker/akshare_sync_service.py#L1-L1236)
- [baostock_sync_service.py](file://app/worker/baostock_sync_service.py#L1-L608)

## 数据优先级与冲突解决
系统通过DataSourceManager类管理多个数据源的优先级，并在数据冲突时进行解决。

### 数据源优先级管理
DataSourceManager类负责管理多个数据源的优先级。它根据配置文件中的优先级设置，决定数据源的使用顺序。默认情况下，Tushare的优先级最高，其次是AkShare，最后是BaoStock。

```mermaid
classDiagram
class DataSourceManager {
+adapters : List[DataSourceAdapter]
+consistency_checker : DataConsistencyChecker
+get_available_adapters() : List[DataSourceAdapter]
+get_stock_list_with_fallback(preferred_sources : List[str]) : Tuple[Optional[pd.DataFrame], Optional[str]]
+get_daily_basic_with_fallback(trade_date : str, preferred_sources : List[str]) : Tuple[Optional[pd.DataFrame], Optional[str]]
+find_latest_trade_date_with_fallback(preferred_sources : List[str]) : Optional[str]
+get_realtime_quotes_with_fallback() : Tuple[Optional[Dict], Optional[str]]
+get_daily_basic_with_consistency_check(trade_date : str) : Tuple[Optional[pd.DataFrame], Optional[str], Optional[Dict]]
+get_kline_with_fallback(code : str, period : str, limit : int, adj : Optional[str]) : Tuple[Optional[List[Dict]], Optional[str]]
+get_news_with_fallback(code : str, days : int, limit : int, include_announcements : bool) : Tuple[Optional[List[Dict]], Optional[str]]
}
```

**Diagram sources**
- [manager.py](file://app/services/data_sources/manager.py#L17-L309)

### 数据冲突解决
当多个数据源提供的数据存在冲突时，系统通过DataConsistencyChecker类进行一致性检查，并根据检查结果选择最可靠的数据源。

```mermaid
classDiagram
class DataConsistencyChecker {
+tolerance_thresholds : Dict[str, float]
+metric_weights : Dict[str, float]
+check_daily_basic_consistency(primary_data : pd.DataFrame, secondary_data : pd.DataFrame, primary_source : str, secondary_source : str) : DataConsistencyResult
+_find_common_stocks(df1 : pd.DataFrame, df2 : pd.DataFrame) : List[str]
+_compare_metric(df1 : pd.DataFrame, df2 : pd.DataFrame, common_stocks : List[str], metric : str) : Optional[FinancialMetricComparison]
+_get_stock_metric_value(df : pd.DataFrame, stock_code : str, metric : str) : Optional[float]
+_calculate_overall_consistency(comparisons : List[FinancialMetricComparison], primary_source : str, secondary_source : str) : DataConsistencyResult
+resolve_data_conflicts(primary_data : pd.DataFrame, secondary_data : pd.DataFrame, consistency_result : DataConsistencyResult) : Tuple[pd.DataFrame, str]
}
```

**Diagram sources**
- [data_consistency_checker.py](file://app/services/data_consistency_checker.py#L35-L319)

**Section sources**
- [manager.py](file://app/services/data_sources/manager.py#L1-L309)
- [data_consistency_checker.py](file://app/services/data_consistency_checker.py#L1-L319)

## 定时同步任务调度
系统通过Apscheduler实现定时同步任务的调度，支持任务的暂停、恢复和手动触发。

### 任务调度器
SchedulerService类负责管理定时任务的调度。它提供了获取任务列表、获取任务详情、暂停任务、恢复任务和手动触发任务等功能。

```mermaid
classDiagram
class SchedulerService {
+scheduler : AsyncIOScheduler
+db : AsyncIOMotorDatabase
+list_jobs() : List[Dict[str, Any]]
+get_job(job_id : str) : Optional[Dict[str, Any]]
+pause_job(job_id : str) : bool
+resume_job(job_id : str) : bool
+trigger_job(job_id : str, kwargs : Optional[Dict[str, Any]]) : bool
+get_job_history(job_id : str, limit : int, offset : int) : List[Dict[str, Any]]
+count_job_history(job_id : str) : int
+get_all_history(limit : int, offset : int, job_id : Optional[str], status : Optional[str]) : List[Dict[str, Any]]
+count_all_history(job_id : Optional[str], status : Optional[str]) : int
+get_job_executions(job_id : Optional[str], status : Optional[str], is_manual : Optional[bool], limit : int, offset : int) : List[Dict[str, Any]]
+count_job_executions(job_id : Optional[str], status : Optional[str], is_manual : Optional[bool]) : int
+cancel_job_execution(execution_id : str) : bool
+mark_execution_as_failed(execution_id : str, reason : str) : bool
+delete_execution(execution_id : str) : bool
+get_job_execution_stats(job_id : str) : Dict[str, Any]
+get_stats() : Dict[str, Any]
+health_check() : Dict[str, Any]
+_job_to_dict(job : Job, include_details : bool) : Dict[str, Any]
+_setup_event_listeners() : None
+_check_zombie_tasks() : Coroutine
+_on_job_executed(event : JobExecutionEvent) : None
+_on_job_error(event : JobExecutionEvent) : None
+_on_job_missed(event : JobExecutionEvent) : None
}
```

**Diagram sources**
- [scheduler_service.py](file://app/services/scheduler_service.py#L45-L800)

### 任务执行历史
系统记录每个任务的执行历史，包括成功、失败和错过的执行记录。这些记录存储在MongoDB的scheduler_executions集合中。

```mermaid
erDiagram
scheduler_executions {
string job_id PK
string job_name
string status
datetime timestamp
datetime scheduled_time
float execution_time
string error_message
string traceback
boolean is_manual
boolean cancel_requested
datetime updated_at
}
```

**Diagram sources**
- [scheduler_service.py](file://app/services/scheduler_service.py#L344-L408)

**Section sources**
- [scheduler_service.py](file://app/services/scheduler_service.py#L1-L1161)

## 增量与全量同步实现
系统支持增量同步和全量同步两种模式，以满足不同的数据同步需求。

### 增量同步
增量同步只同步自上次同步以来发生变化的数据。MultiSourceBasicsSyncService类负责执行增量同步，通过比较数据的更新时间来确定需要同步的数据。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Service as "MultiSourceBasicsSyncService"
participant Manager as "DataSourceManager"
participant DB as "MongoDB"
Client->>Service : run_full_sync(force=False)
Service->>Service : 获取同步状态
Service->>Manager : get_stock_list_with_fallback()
Manager-->>Service : 股票列表
Service->>Manager : find_latest_trade_date_with_fallback()
Manager-->>Service : 最新交易日期
Service->>Manager : get_daily_basic_with_fallback()
Manager-->>Service : 每日基础数据
Service->>DB : 批量写入数据
DB-->>Service : 写入结果
Service->>Service : 更新同步状态
Service-->>Client : 同步结果
```

**Diagram sources**
- [multi_source_basics_sync_service.py](file://app/services/multi_source_basics_sync_service.py#L58-L382)

### 全量同步
全量同步会同步所有数据，无论数据是否发生变化。MultiSourceBasicsSyncService类也支持全量同步，通过设置force参数为True来触发。

```mermaid
flowchart TD
Start([开始全量同步]) --> GetStockList["获取股票列表"]
GetStockList --> GetLatestTradeDate["获取最新交易日期"]
GetLatestTradeDate --> GetDailyBasic["获取每日基础数据"]
GetDailyBasic --> ProcessStocks["处理每只股票"]
ProcessStocks --> ExtractBasicInfo["提取基础信息"]
ExtractBasicInfo --> ExtractFinancialData["提取财务数据"]
ExtractFinancialData --> BuildDocument["构建文档"]
BuildDocument --> BulkWrite["批量写入数据库"]
BulkWrite --> UpdateStats["更新统计信息"]
UpdateStats --> End([结束全量同步])
```

**Diagram sources**
- [multi_source_basics_sync_service.py](file://app/services/multi_source_basics_sync_service.py#L143-L321)

**Section sources**
- [multi_source_basics_sync_service.py](file://app/services/multi_source_basics_sync_service.py#L1-L382)

## 错误重试与断点续传
系统在数据同步过程中实现了错误重试和断点续传机制，以提高数据同步的可靠性。

### 错误重试
当数据同步过程中发生错误时，系统会自动进行重试。TushareSyncService和AKShareSyncService类都实现了重试机制，最大重试次数为3次。

```mermaid
flowchart TD
Start([开始同步]) --> CheckError["检查是否发生错误"]
CheckError --> |是| Retry["重试"]
Retry --> CheckMaxRetries["检查是否达到最大重试次数"]
CheckMaxRetries --> |否| Wait["等待一段时间"]
Wait --> Backoff["指数退避"]
Backoff --> Start
CheckMaxRetries --> |是| Fail["同步失败"]
Fail --> End([结束同步])
CheckError --> |否| Success["同步成功"]
Success --> End
```

**Diagram sources**
- [tushare_sync_service.py](file://app/worker/tushare_sync_service.py#L119-L135)
- [akshare_sync_service.py](file://app/worker/akshare_sync_service.py#L112-L113)

### 断点续传
当数据同步过程中断时，系统可以从断点处继续同步。MultiSourceBasicsSyncService类通过记录同步状态来实现断点续传。

```mermaid
classDiagram
class SyncStats {
+job : str
+data_type : str
+status : str
+started_at : Optional[str]
+finished_at : Optional[str]
+total : int
+inserted : int
+updated : int
+errors : int
+last_trade_date : Optional[str]
+data_sources_used : List[str]
+source_stats : Dict[str, Dict[str, int]]
+message : Optional[str]
}
```

**Diagram sources**
- [multi_source_basics_sync_service.py](file://app/services/multi_source_basics_sync_service.py#L40-L55)

**Section sources**
- [tushare_sync_service.py](file://app/worker/tushare_sync_service.py#L1-L1360)
- [akshare_sync_service.py](file://app/worker/akshare_sync_service.py#L1-L1236)
- [multi_source_basics_sync_service.py](file://app/services/multi_source_basics_sync_service.py#L1-L382)

## 数据一致性检查
系统通过DataConsistencyChecker类进行数据一致性检查，确保从不同数据源获取的数据具有一致性。

### 一致性检查流程
数据一致性检查流程包括以下几个步骤：
1. 获取主数据源和次数据源的数据。
2. 检查两个数据集是否为空。
3. 找到两个数据集中的共同股票。
4. 逐指标比较数据。
5. 计算整体一致性结果。
6. 根据一致性结果解决数据冲突。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Checker as "DataConsistencyChecker"
participant DB as "MongoDB"
Client->>Checker : check_daily_basic_consistency()
Checker->>Checker : 检查数据集是否为空
Checker->>Checker : 找到共同股票
Checker->>Checker : 逐指标比较
Checker->>Checker : 计算整体一致性
Checker->>Checker : 解决数据冲突
Checker-->>Client : 一致性检查结果
```

**Diagram sources**
- [data_consistency_checker.py](file://app/services/data_consistency_checker.py#L59-L319)

### 一致性检查结果
一致性检查结果包括是否一致、主数据源、次数据源、差异、置信度分数、推荐操作和详细信息。

```mermaid
classDiagram
class DataConsistencyResult {
+is_consistent : bool
+primary_source : str
+secondary_source : str
+differences : Dict[str, Any]
+confidence_score : float
+recommended_action : str
+details : Dict[str, Any]
}
```

**Diagram sources**
- [data_consistency_checker.py](file://app/services/data_consistency_checker.py#L14-L23)

**Section sources**
- [data_consistency_checker.py](file://app/services/data_consistency_checker.py#L1-L319)

## 性能优化策略
系统通过批量写入、并发控制和数据预处理等策略来优化数据同步的性能。

### 批量写入
系统通过批量写入来减少数据库操作的次数，提高写入效率。MultiSourceBasicsSyncService类在处理股票数据时，每500只股票进行一次批量写入。

```mermaid
flowchart TD
Start([开始处理股票]) --> ProcessStock["处理单只股票"]
ProcessStock --> AddToBatch["添加到批次"]
AddToBatch --> CheckBatchSize["检查批次大小"]
CheckBatchSize --> |达到500| BulkWrite["批量写入数据库"]
BulkWrite --> ClearBatch["清空批次"]
ClearBatch --> ProcessStock
CheckBatchSize --> |未达到500| ProcessStock
ProcessStock --> |处理完所有股票| BulkWrite
BulkWrite --> End([结束处理])
```

**Diagram sources**
- [multi_source_basics_sync_service.py](file://app/services/multi_source_basics_sync_service.py#L207-L307)

### 并发控制
系统通过并发控制来提高数据同步的效率。TushareSyncService和AKShareSyncService类在获取实时行情时，使用并发任务来同时获取多只股票的行情。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Service as "SyncService"
participant Provider as "数据源提供器"
Client->>Service : sync_realtime_quotes()
Service->>Service : 创建并发任务
loop 每只股票
Service->>Provider : 获取行情
end
Provider-->>Service : 返回行情数据
Service->>Service : 等待所有任务完成
Service->>Service : 统计结果
Service-->>Client : 同步结果
```

**Diagram sources**
- [tushare_sync_service.py](file://app/worker/tushare_sync_service.py#L429-L436)
- [akshare_sync_service.py](file://app/worker/akshare_sync_service.py#L397-L400)

### 数据预处理
系统在将数据写入数据库之前，进行数据预处理，包括生成完整股票代码、确定交易所等。

```mermaid
flowchart TD
Start([开始预处理]) --> ExtractInfo["提取基础信息"]
ExtractInfo --> GenerateFullSymbol["生成完整股票代码"]
GenerateFullSymbol --> DetermineExchange["确定交易所"]
DetermineExchange --> AddSource["添加数据源标识"]
AddSource --> BuildDocument["构建文档"]
BuildDocument --> End([结束预处理])
```

**Diagram sources**
- [multi_source_basics_sync_service.py](file://app/services/multi_source_basics_sync_service.py#L217-L277)

**Section sources**
- [multi_source_basics_sync_service.py](file://app/services/multi_source_basics_sync_service.py#L1-L382)

## 同步服务调用示例
以下是一个调用多数据源同步服务的示例。

### API调用
通过HTTP API调用多数据源同步服务，可以触发股票基础信息的同步。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Router as "MultiSourceSyncRouter"
participant Service as "MultiSourceBasicsSyncService"
Client->>Router : POST /api/sync/multi-source/stock_basics/run
Router->>Service : run_full_sync(force=False, preferred_sources=None)
Service->>Service : 执行同步
Service-->>Router : 返回同步结果
Router-->>Client : 返回响应
```

**Diagram sources**
- [multi_source_sync.py](file://app/routers/multi_source_sync.py#L154-L188)

### 配置方法
在配置文件中设置数据源的优先级和API密钥，以启用相应的数据源。

```mermaid
erDiagram
datasource_groupings {
string market_category_id PK
string data_source_name PK
int priority
boolean enabled
}
api_keys {
string data_source_name PK
string api_key
string token_source
}
```

**Diagram sources**
- [manager.py](file://app/services/data_sources/manager.py#L45-L89)

**Section sources**
- [multi_source_sync.py](file://app/routers/multi_source_sync.py#L1-L488)