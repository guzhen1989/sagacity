# æ•°æ®åº“ç»´æŠ¤

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**   
- [backups.py](file://app/services/database/backups.py)
- [init_database.py](file://scripts/setup/init_database.py)
- [cleanup.py](file://app/services/database/cleanup.py)
- [status_checks.py](file://app/services/database/status_checks.py)
- [database.py](file://app/routers/database.py)
- [optimize_mongodb_indexes.py](file://scripts/maintenance/optimize_mongodb_indexes.py)
- [backup_volumes.ps1](file://scripts/backup_volumes.ps1)
- [restore_volumes.ps1](file://scripts/restore_volumes.ps1)
</cite>

## ç›®å½•
1. [æ•°æ®åº“å¤‡ä»½](#æ•°æ®åº“å¤‡ä»½)
2. [æ•°æ®åº“æ¢å¤](#æ•°æ®åº“æ¢å¤)
3. [æ•°æ®æ¸…ç†](#æ•°æ®æ¸…ç†)
4. [æ•°æ®åº“åˆå§‹åŒ–](#æ•°æ®åº“åˆå§‹åŒ–)
5. [æ•°æ®åº“å¥åº·æ£€æŸ¥](#æ•°æ®åº“å¥åº·æ£€æŸ¥)
6. [ç´¢å¼•ä¼˜åŒ–ä¸æŸ¥è¯¢æ€§èƒ½è°ƒä¼˜](#ç´¢å¼•ä¼˜åŒ–ä¸æŸ¥è¯¢æ€§èƒ½è°ƒä¼˜)
7. [å®é™…æ“ä½œç¤ºä¾‹](#å®é™…æ“ä½œç¤ºä¾‹)

## æ•°æ®åº“å¤‡ä»½

æ•°æ®åº“å¤‡ä»½æ˜¯ç¡®ä¿æ•°æ®å®‰å…¨çš„å…³é”®æ“ä½œã€‚ç³»ç»Ÿæä¾›äº†ä¸¤ç§å¤‡ä»½æ–¹å¼ï¼šä½¿ç”¨ `mongodump` åŸç”Ÿå‘½ä»¤çš„å¿«é€Ÿå¤‡ä»½å’Œä½¿ç”¨ Python å®ç°çš„å…¼å®¹æ€§å¤‡ä»½ã€‚

### å…¨é‡å¤‡ä»½

å…¨é‡å¤‡ä»½ä¼šåˆ›å»ºæ•°æ®åº“çš„å®Œæ•´å‰¯æœ¬ã€‚ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨ `mongodump` å‘½ä»¤è¿›è¡Œå¤‡ä»½ï¼Œå› ä¸ºå®ƒé€Ÿåº¦å¿«ã€å‹ç¼©æ•ˆç‡é«˜ã€‚å¦‚æœ `mongodump` ä¸å¯ç”¨ï¼Œåˆ™ä¼šå›é€€åˆ° Python å®ç°çš„å¤‡ä»½æ–¹æ³•ã€‚

```mermaid
flowchart TD
Start([å¼€å§‹å¤‡ä»½]) --> CheckMongodump["æ£€æŸ¥ mongodump æ˜¯å¦å¯ç”¨"]
CheckMongodump --> |å¯ç”¨| NativeBackup["ä½¿ç”¨ mongodump åˆ›å»ºå¤‡ä»½"]
CheckMongodump --> |ä¸å¯ç”¨| PythonBackup["ä½¿ç”¨ Python åˆ›å»ºå¤‡ä»½"]
NativeBackup --> Complete["å¤‡ä»½å®Œæˆ"]
PythonBackup --> Complete
```

**å¤‡ä»½æµç¨‹ï¼š**
1. æ£€æŸ¥ `mongodump` å‘½ä»¤æ˜¯å¦åœ¨ç³»ç»Ÿ PATH ä¸­
2. å¦‚æœå¯ç”¨ï¼Œä½¿ç”¨ `mongodump` åˆ›å»ºå‹ç¼©å¤‡ä»½
3. å¦‚æœä¸å¯ç”¨ï¼Œä½¿ç”¨ Python é€é›†åˆå¯¼å‡ºæ•°æ®å¹¶å‹ç¼©
4. è®°å½•å¤‡ä»½å…ƒæ•°æ®åˆ° `database_backups` é›†åˆ

### å¢é‡å¤‡ä»½

å¢é‡å¤‡ä»½é€šè¿‡æŒ‡å®šè¦å¤‡ä»½çš„é›†åˆæ¥å®ç°ã€‚å¯ä»¥åœ¨åˆ›å»ºå¤‡ä»½æ—¶é€šè¿‡ `collections` å‚æ•°æŒ‡å®šéœ€è¦å¤‡ä»½çš„é›†åˆåˆ—è¡¨ã€‚

**å¤‡ä»½ç­–ç•¥ï¼š**
- **æ¨èç­–ç•¥**ï¼šä½¿ç”¨ `mongodump` åŸç”Ÿå‘½ä»¤ï¼Œæ€§èƒ½æœ€ä½³
- **å…¼å®¹ç­–ç•¥**ï¼šå½“æ— æ³•å®‰è£… MongoDB å·¥å…·æ—¶ä½¿ç”¨ Python å®ç°

**ç¾éš¾æ¢å¤é¢„æ¡ˆï¼š**
- å®šæœŸå¤‡ä»½ï¼šå»ºè®®æ¯å¤©æ‰§è¡Œä¸€æ¬¡å…¨é‡å¤‡ä»½
- å¤‡ä»½éªŒè¯ï¼šå®šæœŸæµ‹è¯•å¤‡ä»½æ–‡ä»¶çš„å¯æ¢å¤æ€§
- å¤šåœ°å­˜å‚¨ï¼šå°†å¤‡ä»½æ–‡ä»¶å­˜å‚¨åœ¨ä¸åŒç‰©ç†ä½ç½®

**Section sources**
- [backups.py](file://app/services/database/backups.py#L30-L135)

## æ•°æ®åº“æ¢å¤

æ•°æ®åº“æ¢å¤æ“ä½œå¯ä»¥ä»å¤‡ä»½æ–‡ä»¶ä¸­æ¢å¤æ•°æ®ï¼Œæ”¯æŒä»æŒ‡å®šå¤‡ä»½æ¢å¤æˆ–äº¤äº’å¼é€‰æ‹©å¤‡ä»½ã€‚

### æ¢å¤æµç¨‹

æ¢å¤æ“ä½œé€šè¿‡ PowerShell è„šæœ¬ `restore_volumes.ps1` å®ç°ï¼Œä¸»è¦æ­¥éª¤åŒ…æ‹¬ï¼š

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant Script as æ¢å¤è„šæœ¬
participant Docker as Docker
participant Volume as æ•°æ®å·
User->>Script : æ‰§è¡Œæ¢å¤è„šæœ¬
Script->>Script : éªŒè¯å¤‡ä»½è·¯å¾„
alt æœªæŒ‡å®šå¤‡ä»½è·¯å¾„
Script->>User : æ˜¾ç¤ºå¯ç”¨å¤‡ä»½åˆ—è¡¨
User->>Script : é€‰æ‹©å¤‡ä»½
end
Script->>Docker : åœæ­¢ç›¸å…³å®¹å™¨
Script->>Volume : åˆ é™¤ç°æœ‰æ•°æ®å·
Script->>Volume : åˆ›å»ºæ–°æ•°æ®å·
Script->>Docker : ä½¿ç”¨ä¸´æ—¶å®¹å™¨æ¢å¤æ•°æ®
Script->>Docker : é‡å¯å®¹å™¨
Script->>User : æ˜¾ç¤ºæ¢å¤ç»“æœ
```

### æ¢å¤ç­–ç•¥

- **å®Œæ•´æ¢å¤**ï¼šæ¢å¤ MongoDB å’Œ Redis æ‰€æœ‰æ•°æ®
- **é€‰æ‹©æ€§æ¢å¤**ï¼šå¯ä»¥é€‰æ‹©åªæ¢å¤ç‰¹å®šæ•°æ®å·
- **ç¡®è®¤æœºåˆ¶**ï¼šæ¢å¤å‰éœ€è¦ç”¨æˆ·ç¡®è®¤ï¼Œé˜²æ­¢è¯¯æ“ä½œ

**æ¢å¤æ³¨æ„äº‹é¡¹ï¼š**
- æ¢å¤æ“ä½œä¼šè¦†ç›–ç°æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œ
- ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
- æ¢å¤æœŸé—´æœåŠ¡å°†ä¸å¯ç”¨

**Section sources**
- [restore_volumes.ps1](file://scripts/restore_volumes.ps1#L27-L210)

## æ•°æ®æ¸…ç†

æ•°æ®æ¸…ç†æœºåˆ¶ç”¨äºè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ï¼ŒåŒ…æ‹¬åˆ†ææŠ¥å‘Šã€ä¸´æ—¶æ•°æ®å’Œæ—¥å¿—ã€‚

### æ¸…ç†è§„åˆ™

ç³»ç»Ÿæä¾›äº†å¤šç§æ¸…ç†å‡½æ•°ï¼Œæ ¹æ®ä¸åŒçš„æ•°æ®ç±»å‹å’Œä¿ç•™ç­–ç•¥è¿›è¡Œæ¸…ç†ï¼š

```mermaid
classDiagram
class cleanup_old_data {
+days : int
+cutoff_date : datetime
+deleted_count : int
+cleaned_collections : list
+cleanup_old_data(days) Dict[str, Any]
}
class cleanup_analysis_results {
+days : int
+cutoff_date : datetime
+deleted_count : int
+cleaned_collections : list
+cleanup_analysis_results(days) Dict[str, Any]
}
class cleanup_operation_logs {
+days : int
+cutoff_date : datetime
+deleted_count : int
+cleaned_collections : list
+cleanup_operation_logs(days) Dict[str, Any]
}
cleanup_old_data --> cleanup_analysis_results : "ç»§æ‰¿"
cleanup_old_data --> cleanup_operation_logs : "ç»§æ‰¿"
```

### æ¸…ç†èŒƒå›´

- **åˆ†æä»»åŠ¡**ï¼šæ¸…ç†æŒ‡å®šå¤©æ•°å‰å·²å®Œæˆæˆ–å¤±è´¥çš„ä»»åŠ¡
- **ç”¨æˆ·ä¼šè¯**ï¼šæ¸…ç†è¿‡æœŸçš„ç”¨æˆ·ä¼šè¯
- **ç™»å½•å°è¯•**ï¼šæ¸…ç†å†å²ç™»å½•å°è¯•è®°å½•
- **æ“ä½œæ—¥å¿—**ï¼šæ¸…ç†æ—§çš„æ“ä½œæ—¥å¿—

**è‡ªåŠ¨æ¸…ç†é…ç½®ï¼š**
- å»ºè®®è®¾ç½®å®šæœŸæ¸…ç†ä»»åŠ¡ï¼ˆå¦‚æ¯å¤©å‡Œæ™¨æ‰§è¡Œï¼‰
- æ ¹æ®ç£ç›˜ç©ºé—´å’Œæ€§èƒ½éœ€æ±‚è°ƒæ•´ä¿ç•™å¤©æ•°
- é‡è¦æ•°æ®åº”å…ˆå¤‡ä»½å†æ¸…ç†

**Section sources**
- [cleanup.py](file://app/services/database/cleanup.py#L12-L99)

## æ•°æ®åº“åˆå§‹åŒ–

æ•°æ®åº“åˆå§‹åŒ–æµç¨‹é€šè¿‡ `init_database.py` è„šæœ¬åˆ›å»ºå¿…è¦çš„é›†åˆå’Œç´¢å¼•ï¼Œå¹¶åˆå§‹åŒ–ç¼“å­˜ç»“æ„ã€‚

### åˆå§‹åŒ–æµç¨‹

```mermaid
flowchart TD
Start([å¼€å§‹åˆå§‹åŒ–]) --> TestConnection["æµ‹è¯•æ•°æ®åº“è¿æ¥"]
TestConnection --> |è¿æ¥å¤±è´¥| ExitError["æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯"]
TestConnection --> |è¿æ¥æ­£å¸¸| InitMongo["åˆå§‹åŒ–MongoDB"]
InitMongo --> CreateCollections["åˆ›å»ºé›†åˆ"]
CreateCollections --> CreateIndexes["åˆ›å»ºç´¢å¼•"]
CreateCollections --> InsertConfig["æ’å…¥åˆå§‹é…ç½®"]
InitMongo --> InitRedis["åˆå§‹åŒ–Redis"]
InitRedis --> FlushDB["æ¸…ç†ç°æœ‰ç¼“å­˜"]
InitRedis --> SetConfig["è®¾ç½®ç¼“å­˜é…ç½®"]
InitRedis --> TestCache["æµ‹è¯•ç¼“å­˜åŠŸèƒ½"]
TestCache --> |æµ‹è¯•å¤±è´¥| ExitError
TestCache --> |æµ‹è¯•æˆåŠŸ| ShowResult["æ˜¾ç¤ºåˆå§‹åŒ–ç»“æœ"]
ShowResult --> End([åˆå§‹åŒ–å®Œæˆ])
```

### åˆå§‹åŒ–å†…å®¹

**MongoDB é›†åˆä¸ç´¢å¼•ï¼š**
- **è‚¡ç¥¨æ•°æ®é›†åˆ** (`stock_data`)
  - å¤åˆå”¯ä¸€ç´¢å¼•ï¼š`(symbol, market_type)`
  - åˆ›å»ºæ—¶é—´ç´¢å¼•ï¼š`created_at` (é™åº)
  - æ›´æ–°æ—¶é—´ç´¢å¼•ï¼š`updated_at` (é™åº)
- **åˆ†æç»“æœé›†åˆ** (`analysis_results`)
  - å¤åˆç´¢å¼•ï¼š`(symbol, analysis_type)`
  - åˆ›å»ºæ—¶é—´ç´¢å¼•ï¼š`created_at` (é™åº)
  - ç¬¦å·+æ—¶é—´å¤åˆç´¢å¼•ï¼š`(symbol, created_at)` (é™åº)
- **ç”¨æˆ·ä¼šè¯é›†åˆ** (`user_sessions`)
  - å”¯ä¸€ç´¢å¼•ï¼š`session_id`
  - æ´»è·ƒæ—¶é—´ç´¢å¼•ï¼š`last_activity` (é™åº)
- **é…ç½®é›†åˆ** (`configurations`)
  - å¤åˆå”¯ä¸€ç´¢å¼•ï¼š`(config_type, config_name)`
  - æ›´æ–°æ—¶é—´ç´¢å¼•ï¼š`updated_at` (é™åº)

**Redis ç¼“å­˜åˆå§‹åŒ–ï¼š**
- æ¸…ç†ç°æœ‰ç¼“å­˜
- è®¾ç½®ç¼“å­˜ TTL é…ç½®
- åˆå§‹åŒ–ç¼“å­˜ç»Ÿè®¡
- æµ‹è¯•ç¼“å­˜è¯»å†™åŠŸèƒ½

**Section sources**
- [init_database.py](file://scripts/setup/init_database.py#L27-L303)

## æ•°æ®åº“å¥åº·æ£€æŸ¥

æ•°æ®åº“å¥åº·æ£€æŸ¥æ–¹æ³•ç”¨äºç›‘æ§æ•°æ®åº“çš„è¿æ¥çŠ¶æ€ã€å­˜å‚¨ç©ºé—´å’Œæ€§èƒ½æŒ‡æ ‡ã€‚

### å¥åº·æ£€æŸ¥æ¥å£

ç³»ç»Ÿæä¾›äº†å¤šä¸ªå¥åº·æ£€æŸ¥å‡½æ•°ï¼Œå¯ä»¥åˆ†åˆ«æ£€æŸ¥ MongoDB å’Œ Redis çš„çŠ¶æ€ï¼š

```mermaid
graph TB
subgraph "å¥åº·æ£€æŸ¥"
GetDBStatus["get_database_status()"]
GetMongoStatus["get_mongodb_status()"]
GetRedisStatus["get_redis_status()"]
TestConnections["test_connections()"]
end
GetDBStatus --> GetMongoStatus
GetDBStatus --> GetRedisStatus
TestConnections --> GetMongoStatus
TestConnections --> GetRedisStatus
```

### ç›‘æ§æŒ‡æ ‡

**MongoDB ç›‘æ§æŒ‡æ ‡ï¼š**
- è¿æ¥çŠ¶æ€
- æœåŠ¡å™¨ç‰ˆæœ¬
- è¿è¡Œæ—¶é—´
- è¿æ¥æ•°
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- å“åº”æ—¶é—´

**Redis ç›‘æ§æŒ‡æ ‡ï¼š**
- è¿æ¥çŠ¶æ€
- æœåŠ¡å™¨ç‰ˆæœ¬
- è¿è¡Œæ—¶é—´
- å·²ç”¨å†…å­˜
- è¿æ¥å®¢æˆ·ç«¯æ•°
- æ€»å‘½ä»¤å¤„ç†æ•°
- å“åº”æ—¶é—´

**ç›‘æ§å»ºè®®ï¼š**
- è®¾ç½®å®šæœŸå¥åº·æ£€æŸ¥ï¼ˆå¦‚æ¯5åˆ†é’Ÿä¸€æ¬¡ï¼‰
- å½“è¿æ¥å¤±è´¥æ—¶å‘é€å‘Šè­¦
- ç›‘æ§å“åº”æ—¶é—´ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦
- è®°å½•å¥åº·æ£€æŸ¥å†å²ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

**Section sources**
- [status_checks.py](file://app/services/database/status_checks.py#L13-L100)

## ç´¢å¼•ä¼˜åŒ–ä¸æŸ¥è¯¢æ€§èƒ½è°ƒä¼˜

ç´¢å¼•ä¼˜åŒ–æ˜¯æå‡æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½çš„å…³é”®ã€‚ç³»ç»Ÿæä¾›äº†ç´¢å¼•ä¼˜åŒ–æŒ‡å—å’Œè‡ªåŠ¨åŒ–è„šæœ¬ã€‚

### ç´¢å¼•è®¾è®¡åŸåˆ™

éµå¾ª **ESR åŸåˆ™**ï¼š
- **E (Equality)**: ç­‰å€¼æŸ¥è¯¢å­—æ®µæ”¾åœ¨æœ€å‰é¢
- **S (Sort)**: æ’åºå­—æ®µæ”¾åœ¨ä¸­é—´
- **R (Range)**: èŒƒå›´æŸ¥è¯¢å­—æ®µæ”¾åœ¨æœ€å

### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰**
```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source env/bin/activate  # Linux/Mac
# æˆ–
.\env\Scripts\activate   # Windows

# è¿è¡Œä¼˜åŒ–è„šæœ¬
python scripts/maintenance/optimize_mongodb_indexes.py
```

**æ–¹æ¡ˆäºŒï¼šæ‰‹åŠ¨åˆ›å»ºç´¢å¼•**
```javascript
// 1. æ…¢æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•
db.stock_daily_quotes.createIndex(
  {
    "symbol": 1,
    "data_source": 1,
    "trade_date": 1,
    "period": 1
  },
  {
    name: "symbol_source_date_period_idx",
    background: true
  }
)

// 2. æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•ï¼ˆæŒ‰è‚¡ç¥¨ä»£ç +å‘¨æœŸæŸ¥è¯¢ï¼‰
db.stock_daily_quotes.createIndex(
  {
    "symbol": 1,
    "period": 1,
    "trade_date": -1
  },
  {
    name: "symbol_period_date_idx",
    background: true
  }
)
```

### æ€§èƒ½æµ‹è¯•

ä½¿ç”¨ `explain("executionStats")` å‘½ä»¤æµ‹è¯•æŸ¥è¯¢æ€§èƒ½ï¼š

```javascript
db.stock_daily_quotes.find({
  "symbol": "688188",
  "trade_date": "2024-12-10",
  "data_source": "tushare",
  "period": "daily"
}).explain("executionStats")
```

**å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼š**
- **executionTimeMillis**: æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- **totalDocsExamined**: æ‰«æçš„æ–‡æ¡£æ•°
- **totalKeysExamined**: æ‰«æçš„ç´¢å¼•é”®æ•°
- **stage**: æŸ¥è¯¢é˜¶æ®µï¼ˆIXSCAN è¡¨ç¤ºä½¿ç”¨ç´¢å¼•ï¼ŒCOLLSCAN è¡¨ç¤ºå…¨è¡¨æ‰«æï¼‰

**ä¼˜åŒ–å‰åå¯¹æ¯”ï¼š**
- ä¼˜åŒ–å‰ï¼š287msï¼ˆå…¨è¡¨æ‰«æï¼‰
- ä¼˜åŒ–åï¼š2msï¼ˆç´¢å¼•æ‰«æï¼‰
- æ€§èƒ½æå‡ï¼š143å€

**ç´¢å¼•ç»´æŠ¤å»ºè®®ï¼š**
1. å®šæœŸç›‘æ§æ…¢æŸ¥è¯¢æ—¥å¿—
2. æ¯æœˆè¿è¡Œä¸€æ¬¡ç´¢å¼•ä¼˜åŒ–è„šæœ¬
3. ç›‘æ§ç´¢å¼•å¤§å°ï¼Œé¿å…è¿‡åº¦ç´¢å¼•
4. åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•ï¼ŒèŠ‚çœèµ„æº
5. æ ¹æ®å®é™…æŸ¥è¯¢æ¨¡å¼è°ƒæ•´ç´¢å¼•

**Section sources**
- [optimize_mongodb_indexes.py](file://scripts/maintenance/optimize_mongodb_indexes.py#L227-L251)
- [mongodb_index_optimization.md](file://docs/maintenance/mongodb_index_optimization.md#L1-L348)

## å®é™…æ“ä½œç¤ºä¾‹

### å¤‡ä»½æ“ä½œç¤ºä¾‹

**åˆ›å»ºå…¨é‡å¤‡ä»½ï¼š**
```bash
# ä½¿ç”¨APIåˆ›å»ºå¤‡ä»½
curl -X POST http://localhost:8000/api/database/backups \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{"name": "daily_backup"}'
```

**é¢„æœŸè¾“å‡ºï¼š**
```json
{
  "id": "673a1b2c3d4e5f6a7b8c9d0e",
  "name": "daily_backup",
  "filename": "backup_daily_backup_20251113_143000",
  "file_path": "/path/to/backups/backup_daily_backup_20251113_143000",
  "size": 10485760,
  "collections": ["stock_data", "analysis_results", "user_sessions", "configurations"],
  "created_at": "2025-11-13T14:30:00Z",
  "backup_type": "mongodump"
}
```

### æ¢å¤æ“ä½œç¤ºä¾‹

**æ‰§è¡Œæ¢å¤è„šæœ¬ï¼š**
```powershell
# äº¤äº’å¼é€‰æ‹©å¤‡ä»½æ¢å¤
.\scripts\restore_volumes.ps1

# æŒ‡å®šå¤‡ä»½è·¯å¾„æ¢å¤
.\scripts\restore_volumes.ps1 -BackupPath "backups/20250117_143000"
```

**é¢„æœŸè¾“å‡ºï¼š**
```
======================================================================
âš ï¸  è­¦å‘Šï¼šæ¢å¤æ•°æ®å·å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼
======================================================================

ğŸ“ å¤‡ä»½è·¯å¾„: C:\project\backups\20250117_143000

ğŸ“ å¤‡ä»½ä¿¡æ¯:
   - æ—¶é—´: 2025-01-17 14:30:00
   - ä¸»æœº: DESKTOP-ABC123

ç¡®è®¤æ¢å¤ï¼Ÿ(yes/no) yes

ğŸ”„ å¼€å§‹æ¢å¤æ•°æ®å·...

ğŸ›‘ åœæ­¢ç›¸å…³å®¹å™¨...
   åœæ­¢å®¹å™¨: tradingagents-mongodb
   åœæ­¢å®¹å™¨: tradingagents-redis

ğŸ“¦ æ¢å¤ MongoDB æ•°æ® (tradingagents_mongodb_data)...
   ğŸ—‘ï¸  åˆ é™¤ç°æœ‰æ•°æ®å·...
   ğŸ“ åˆ›å»ºæ–°æ•°æ®å·...
   ğŸ”„ æ¢å¤æ•°æ®...
   âœ… æ¢å¤æˆåŠŸ

ğŸ“¦ æ¢å¤ Redis æ•°æ® (tradingagents_redis_data)...
   ğŸ—‘ï¸  åˆ é™¤ç°æœ‰æ•°æ®å·...
   ğŸ“ åˆ›å»ºæ–°æ•°æ®å·...
   ğŸ”„ æ¢å¤æ•°æ®...
   âœ… æ¢å¤æˆåŠŸ

ğŸš€ é‡å¯å®¹å™¨...
   å¯åŠ¨å®¹å™¨: tradingagents-mongodb
   å¯åŠ¨å®¹å™¨: tradingagents-redis

======================================================================
âœ… æ¢å¤å®Œæˆï¼
======================================================================

ğŸ’¡ æç¤º:
   - è¯·æ£€æŸ¥å®¹å™¨æ—¥å¿—ç¡®è®¤æœåŠ¡æ­£å¸¸è¿è¡Œ
   - ä½¿ç”¨ 'docker logs <container_name>' æŸ¥çœ‹æ—¥å¿—
```

### æ¸…ç†æ“ä½œç¤ºä¾‹

**æ¸…ç†30å¤©å‰çš„æ•°æ®ï¼š**
```bash
# ä½¿ç”¨APIæ¸…ç†æ•°æ®
curl -X POST http://localhost:8000/api/database/cleanup \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{"days": 30}'
```

**é¢„æœŸè¾“å‡ºï¼š**
```json
{
  "success": true,
  "message": "æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† 150 æ¡è®°å½•",
  "data": {
    "deleted_count": 150,
    "cleaned_collections": [
      "analysis_tasks: 100",
      "user_sessions: 30",
      "login_attempts: 20"
    ],
    "cutoff_date": "2025-10-14T00:00:00Z"
  }
}
```

### å¥åº·æ£€æŸ¥ç¤ºä¾‹

**æ£€æŸ¥æ•°æ®åº“çŠ¶æ€ï¼š**
```bash
# è·å–æ•°æ®åº“çŠ¶æ€
curl -X GET http://localhost:8000/api/health/database \
  -H "Authorization: Bearer your_token"
```

**é¢„æœŸè¾“å‡ºï¼š**
```json
{
  "mongodb": {
    "connected": true,
    "host": "localhost",
    "port": 27017,
    "database": "tradingagents",
    "version": "6.0.12",
    "uptime": 3600,
    "connections": {
      "current": 10,
      "available": 50000
    },
    "memory": {
      "bits": 64,
      "resident": 1024,
      "virtual": 2048
    },
    "connected_at": "2025-11-13T14:30:00Z"
  },
  "redis": {
    "connected": true,
    "host": "localhost",
    "port": 6379,
    "database": 0,
    "version": "7.0.12",
    "uptime": 3600,
    "memory_used": 52428800,
    "memory_peak": 67108864,
    "connected_clients": 5,
    "total_commands": 10000
  }
}
```

**Section sources**
- [database.py](file://app/routers/database.py#L238-L277)
- [backup_volumes.ps1](file://scripts/backup_volumes.ps1#L1-L140)