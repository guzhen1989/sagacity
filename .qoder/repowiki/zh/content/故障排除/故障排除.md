# 故障排除

<cite>
**本文档引用的文件**
- [main.py](file://app/main.py)
- [startup_validator.py](file://app/core/startup_validator.py)
- [logging.toml](file://config/logging.toml)
- [logging_docker.toml](file://config/logging_docker.toml)
- [error_handler.py](file://app/middleware/error_handler.py)
- [rate_limiter.py](file://app/core/rate_limiter.py)
- [docker-troubleshooting.md](file://docs/troubleshooting/docker-troubleshooting.md)
- [troubleshooting-mongodb-docker.md](file://docs/troubleshooting-mongodb-docker.md)
- [log_analyzer.py](file://scripts/log_analyzer.py)
- [view_logs.py](file://scripts/view_logs.py)
- [diagnose_system.py](file://scripts/diagnose_system.py)
- [diagnose_historical_data_sync.py](file://scripts/diagnose_historical_data_sync.py)
- [diagnose_env_vars.py](file://scripts/diagnose_env_vars.py)
- [SyncControl.vue](file://frontend/src/components/Sync/SyncControl.vue)
</cite>

## 目录
1. [启动失败](#启动失败)
2. [API错误](#api错误)
3. [数据同步问题](#数据同步问题)
4. [性能瓶颈](#性能瓶颈)
5. [调试工具使用指南](#调试工具使用指南)
6. [预防性维护建议](#预防性维护建议)

## 启动失败

当sagacity平台无法正常启动时，通常由配置缺失、环境问题或依赖服务故障引起。以下是系统性的诊断和解决方案。

### 诊断步骤

1.  **检查必需配置**：平台启动前会通过`app/core/startup_validator.py`验证必需的环境变量。如果缺少`MONGODB_HOST`、`MONGODB_PORT`、`REDIS_HOST`、`REDIS_PORT`或`JWT_SECRET`等关键配置，启动将失败。
    -   **症状**：日志中出现`❌ 缺少必需配置: MONGODB_HOST`等错误信息。
    -   **根本原因**：`.env`文件缺失或配置项未正确设置。
    -   **解决方案**：检查并确保`.env`文件存在，且所有必需配置项均已正确填写。

2.  **验证配置值格式**：即使配置项存在，其值也必须符合要求。例如，端口号必须是1-65535之间的数字，`JWT_SECRET`长度必须大于等于16个字符。
    -   **症状**：日志中出现`❌ 配置格式错误: MONGODB_PORT`。
    -   **根本原因**：在`.env`文件中输入了无效的值。
    -   **解决方案**：修正`.env`文件中的配置值，确保其符合格式要求。

3.  **检查依赖服务**：平台依赖MongoDB和Redis服务。如果这些服务未运行或网络不通，平台将无法连接。
    -   **症状**：日志中出现`❌ MongoDB: MongoDB连接失败`或`❌ Redis: Redis连接失败`。
    -   **根本原因**：Docker容器未启动、端口被占用或网络配置错误。
    -   **解决方案**：
        -   使用`docker-compose ps`检查容器状态。
        -   使用`docker-compose logs mongodb`和`docker-compose logs redis`查看具体错误日志。
        -   参考`docs/troubleshooting/docker-troubleshooting.md`文档排查Docker相关问题。

4.  **检查安全警告**：使用默认的`JWT_SECRET`（如`your-super-secret-jwt-key-change-in-production`）虽然不会阻止启动，但存在安全风险。
    -   **症状**：日志中出现`⚠️ JWT_SECRET 使用默认值，生产环境请务必修改！`。
    -   **根本原因**：未修改默认的安全密钥。
    -   **解决方案**：在`.env`文件中为`JWT_SECRET`设置一个强密码。

**Section sources**
- [startup_validator.py](file://app/core/startup_validator.py#L48-L88)
- [startup_validator.py](file://app/core/startup_validator.py#L215-L227)

## API错误

API错误通常表现为HTTP 4xx或5xx状态码，可通过日志和请求ID进行追踪。

### 诊断步骤

1.  **启用详细日志**：通过修改`config/logging.toml`文件，将`[logging]`部分的`level`设置为`DEBUG`，并确保`[logging.handlers.console]`和`[logging.handlers.file]`的`level`也为`DEBUG`，以获取更详细的日志信息。
    -   **症状**：需要深入了解API调用的内部流程和错误细节。
    -   **根本原因**：默认日志级别可能不足以诊断复杂问题。
    -   **解决方案**：调整日志配置文件后重启服务。

2.  **使用请求ID追踪**：平台通过`app/middleware/request_id.py`为每个请求生成唯一的`X-Request-ID`和`X-Trace-ID`。在日志中搜索此ID，可以完整追踪一个请求的生命周期。
    -   **症状**：需要关联前端请求与后端日志。
    -   **根本原因**：缺乏请求级别的追踪机制。
    -   **解决方案**：在API响应头中获取`X-Request-ID`，然后在`webapi.log`中搜索该ID，查看完整的请求处理流程。

3.  **分析错误类型**：使用`scripts/log_analyzer.py`脚本分析日志，可以自动分类错误。
    -   **症状**：需要快速了解错误的分布和模式。
    -   **根本原因**：手动分析大量日志效率低下。
    -   **解决方案**：运行`python scripts/log_analyzer.py logs/webapi.log`，脚本会生成报告，统计API错误、网络错误、数据库错误等的数量和最近发生的错误。

4.  **检查全局异常处理**：`app/middleware/error_handler.py`中的`ErrorHandlerMiddleware`负责捕获未处理的异常，并返回标准化的JSON错误响应。
    -   **症状**：遇到`500 Internal Server Error`。
    -   **根本原因**：代码中存在未被捕获的异常。
    -   **解决方案**：检查日志中`exc_info=True`的详细堆栈跟踪，定位并修复代码中的bug。

**Section sources**
- [logging.toml](file://config/logging.toml#L6)
- [request_id.py](file://app/middleware/request_id.py)
- [log_analyzer.py](file://scripts/log_analyzer.py)
- [error_handler.py](file://app/middleware/error_handler.py)

## 数据同步问题

数据同步问题主要表现为历史数据缺失、股票覆盖率低或同步任务卡住。

### 诊断步骤

1.  **运行诊断脚本**：使用`scripts/diagnose_historical_data_sync.py`脚本可以全面检查数据同步状态。
    -   **症状**：发现历史数据不完整或缺少周线/月线数据。
    -   **根本原因**：初始全量同步未完成或配置错误。
    -   **解决方案**：
        -   运行`python scripts/diagnose_historical_data_sync.py`。
        -   脚本会输出数据总量、按数据源和周期的统计、日期范围和股票覆盖率。
        -   根据脚本的建议，手动触发全量同步：`python cli/sync_data.py --historical --all-history`。

2.  **检查数据源配置**：确保至少一个数据源（Tushare, AKShare, BaoStock）已启用。
    -   **症状**：没有任何历史数据。
    -   **根本原因**：所有数据源的`*_UNIFIED_ENABLED`环境变量均设置为`false`。
    -   **解决方案**：在`.env`文件中将`TUSHARE_UNIFIED_ENABLED=true`或`AKSHARE_UNIFIED_ENABLED=true`。

3.  **检查同步状态**：前端组件`SyncControl.vue`通过轮询API来监控同步状态。
    -   **症状**：同步进度长时间停留在某个阶段。
    -   **根本原因**：同步任务可能因网络问题或速率限制而暂停。
    -   **解决方案**：
        -   检查`logs/worker.log`，寻找与同步相关的错误。
        -   尝试在前端点击“重新开始”按钮，或通过API`POST /api/multi-period-sync/start-incremental`手动重启同步。

4.  **清空同步缓存**：在某些情况下，损坏的缓存可能导致同步失败。
    -   **症状**：同步任务反复失败，且错误信息不明确。
    -   **根本原因**：Redis或MongoDB中的缓存数据损坏。
    -   **解决方案**：在前端同步控制面板中点击“清空缓存”按钮，然后重新启动同步任务。

**Section sources**
- [diagnose_historical_data_sync.py](file://scripts/diagnose_historical_data_sync.py)
- [SyncControl.vue](file://frontend/src/components/Sync/SyncControl.vue#L302-L329)

## 性能瓶颈

性能问题通常表现为API响应缓慢、分析任务耗时过长或系统资源占用过高。

### 诊断步骤

1.  **分析慢操作**：使用`scripts/log_analyzer.py`脚本的性能分析功能。
    -   **症状**：用户反馈操作卡顿。
    -   **根本原因**：某些数据库查询或API调用耗时过长。
    -   **解决方案**：运行`python scripts/log_analyzer.py logs/webapi.log`，脚本会列出所有耗时超过5秒的操作，帮助定位性能瓶颈。

2.  **检查速率限制**：`app/core/rate_limiter.py`中的`RateLimiter`类用于控制对数据源API的调用频率，避免被限流。
    -   **症状**：数据同步速度远低于预期，但无错误日志。
    -   **根本原因**：速率限制器在后台等待，以遵守API的调用频率限制。
    -   **解决方案**：检查日志中是否有`⏳ ... 达到速率限制，等待 ...秒`的信息。这属于正常行为，无需干预，系统会自动恢复。

3.  **监控系统资源**：使用`scripts/diagnose_system.py`脚本检查系统环境。
    -   **症状**：系统整体响应缓慢。
    -   **根本原因**：磁盘空间不足、内存不足或CPU过载。
    -   **解决方案**：运行`python scripts/diagnose_system.py`，该脚本会检查Python版本、虚拟环境、磁盘空间、网络连接等，并给出优化建议。

4.  **检查并发性能**：平台使用异步和多线程技术处理并发请求。
    -   **症状**：在高并发下系统崩溃或响应时间急剧增加。
    -   **根本原因**：线程池配置不当或数据库连接池耗尽。
    -   **解决方案**：检查`app/core/database.py`中的数据库连接池配置，并根据服务器资源进行调整。

**Section sources**
- [log_analyzer.py](file://scripts/log_analyzer.py#L85-L145)
- [rate_limiter.py](file://app/core/rate_limiter.py)
- [diagnose_system.py](file://scripts/diagnose_system.py)

## 调试工具使用指南

平台提供了一系列调试脚本，帮助用户快速诊断和解决问题。

### 启用详细日志

1.  编辑`config/logging.toml`文件。
2.  将`[logging]`下的`level`设置为`DEBUG`。
3.  确保`[logging.handlers.file]`和`[logging.handlers.console]`的`level`也为`DEBUG`。
4.  重启sagacity服务，日志将包含更详细的信息。

### 使用诊断脚本

-   **`scripts/diagnose_system.py`**：检查Python环境、依赖包、API密钥配置和系统资源。
    -   用法：`python scripts/diagnose_system.py`
-   **`scripts/diagnose_historical_data_sync.py`**：分析MongoDB中历史数据的完整性和同步状态。
    -   用法：`python scripts/diagnose_historical_data_sync.py`
-   **`scripts/diagnose_env_vars.py`**：在Docker容器内诊断环境变量的读取问题。
    -   用法：`docker exec -it <container_name> python scripts/diagnose_env_vars.py`

### 使用日志分析工具

-   **`scripts/log_analyzer.py`**：分析日志文件，生成性能、错误和使用情况的报告。
    -   用法：`python scripts/log_analyzer.py logs/webapi.log`
-   **`scripts/view_logs.py`**：一个交互式工具，用于查看、搜索和实时跟踪日志文件。
    -   用法：`python scripts/view_logs.py`，然后根据提示选择操作。

**Section sources**
- [logging.toml](file://config/logging.toml)
- [diagnose_system.py](file://scripts/diagnose_system.py)
- [diagnose_historical_data_sync.py](file://scripts/diagnose_historical_data_sync.py)
- [diagnose_env_vars.py](file://scripts/diagnose_env_vars.py)
- [log_analyzer.py](file://scripts/log_analyzer.py)
- [view_logs.py](file://scripts/view_logs.py)

## 预防性维护建议

为了确保sagacity平台的长期稳定运行，请遵循以下预防性维护建议。

1.  **定期备份数据**：定期备份MongoDB数据卷，以防止数据丢失。可以使用`docker exec`命令结合`mongodump`工具进行备份。
2.  **监控磁盘空间**：定期清理日志文件和Docker的无用镜像、容器，避免磁盘空间耗尽。使用`docker system prune -f`命令进行清理。
3.  **更新配置**：定期检查`.env.example`文件，确保生产环境的`.env`文件包含了最新的配置项和安全建议。
4.  **审查日志**：定期使用`scripts/log_analyzer.py`分析日志，及时发现潜在的性能问题或错误趋势。
5.  **保持环境更新**：关注项目更新，及时升级到新版本，以获取最新的功能、性能优化和安全修复。