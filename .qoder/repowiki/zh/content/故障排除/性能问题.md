# æ€§èƒ½é—®é¢˜

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**   
- [rate_limiter.py](file://app/core/rate_limiter.py)
- [rate_limit.py](file://app/middleware/rate_limit.py)
- [redis_client.py](file://app/core/redis_client.py)
- [memory_state_manager.py](file://app/services/memory_state_manager.py)
- [queue_service.py](file://app/services/queue_service.py)
- [keys.py](file://app/services/queue/keys.py)
- [database.py](file://app/core/database.py)
- [config.py](file://app/core/config.py)
- [health.py](file://app/routers/health.py)
- [queue.py](file://app/routers/queue.py)
- [test_performance_comparison.py](file://tests/test_performance_comparison.py)
- [concurrent-safety-summary.md](file://docs/troubleshooting/concurrent-safety-summary.md)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)
2. [ç³»ç»Ÿæ€§èƒ½ç›‘æ§](#ç³»ç»Ÿæ€§èƒ½ç›‘æ§)
3. [é™æµæœºåˆ¶é…ç½®ä¸è°ƒä¼˜](#é™æµæœºåˆ¶é…ç½®ä¸è°ƒä¼˜)
4. [æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–](#æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–)
5. [ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ç­–ç•¥](#ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ç­–ç•¥)
6. [å¹¶å‘å¤„ç†ç“¶é¢ˆåˆ†æ](#å¹¶å‘å¤„ç†ç“¶é¢ˆåˆ†æ)
7. [æ€§èƒ½åŸºå‡†æµ‹è¯•æ–¹æ³•](#æ€§èƒ½åŸºå‡†æµ‹è¯•æ–¹æ³•)
8. [ç»“è®º](#ç»“è®º)

## å¼•è¨€

æœ¬æ–‡æ¡£æ—¨åœ¨è§£å†³ç³»ç»Ÿå“åº”æ…¢ã€èµ„æºå ç”¨é«˜ã€ä»»åŠ¡å †ç§¯ç­‰æ€§èƒ½é—®é¢˜ã€‚é€šè¿‡åˆ†æç³»ç»Ÿçš„é™æµæœºåˆ¶ã€æ•°æ®åº“æŸ¥è¯¢ã€ä»»åŠ¡é˜Ÿåˆ—å’Œå¹¶å‘å¤„ç†ï¼Œæä¾›å…¨é¢çš„ä¼˜åŒ–ä¸æ’æŸ¥æŒ‡å—ã€‚æ–‡æ¡£å°†æŒ‡å¯¼ç”¨æˆ·å¦‚ä½•ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ï¼Œå¦‚CPUã€å†…å­˜ã€Redisé˜Ÿåˆ—é•¿åº¦ï¼Œå¹¶è¯¦ç»†è¯´æ˜é™æµæœºåˆ¶çš„é…ç½®ä¸è°ƒä¼˜ï¼Œé¿å…å› è¿‡åº¦è¯·æ±‚å¯¼è‡´æœåŠ¡é™çº§ã€‚æ­¤å¤–ï¼Œæ–‡æ¡£è¿˜å°†æä¾›æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å»ºè®®ï¼Œå¦‚ç´¢å¼•ä½¿ç”¨ã€æ‰¹é‡æ“ä½œï¼Œä»¥åŠä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ç­–ç•¥ï¼Œå¦‚ä¼˜å…ˆçº§è®¾ç½®ã€å¤±è´¥é‡è¯•æœºåˆ¶ã€‚æœ€åï¼Œæ–‡æ¡£å°†ç»™å‡ºæ€§èƒ½åŸºå‡†æµ‹è¯•çš„æ–¹æ³•å’Œé¢„æœŸæŒ‡æ ‡ï¼Œå¸®åŠ©ç”¨æˆ·è¯„ä¼°ç³»ç»Ÿçš„æ€§èƒ½è¡¨ç°ã€‚

**Section sources**
- [rate_limiter.py](file://app/core/rate_limiter.py#L1-L229)
- [rate_limit.py](file://app/middleware/rate_limit.py#L1-L177)

## ç³»ç»Ÿæ€§èƒ½ç›‘æ§

ä¸ºäº†æœ‰æ•ˆç›‘æ§ç³»ç»Ÿçš„æ€§èƒ½ï¼Œéœ€è¦å…³æ³¨ä»¥ä¸‹å‡ ä¸ªå…³é”®æŒ‡æ ‡ï¼š

- **CPUä½¿ç”¨ç‡**ï¼šç›‘æ§CPUä½¿ç”¨ç‡å¯ä»¥å¸®åŠ©è¯†åˆ«ç³»ç»Ÿæ˜¯å¦å¤„äºé«˜è´Ÿè½½çŠ¶æ€ã€‚é«˜CPUä½¿ç”¨ç‡å¯èƒ½å¯¼è‡´ç³»ç»Ÿå“åº”å˜æ…¢ã€‚
- **å†…å­˜ä½¿ç”¨ç‡**ï¼šç›‘æ§å†…å­˜ä½¿ç”¨ç‡å¯ä»¥é˜²æ­¢å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºé—®é¢˜ã€‚é«˜å†…å­˜ä½¿ç”¨ç‡å¯èƒ½å¯¼è‡´ç³»ç»Ÿé¢‘ç¹è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå½±å“æ€§èƒ½ã€‚
- **Redisé˜Ÿåˆ—é•¿åº¦**ï¼šRedisé˜Ÿåˆ—é•¿åº¦æ˜¯è¡¡é‡ä»»åŠ¡å¤„ç†èƒ½åŠ›çš„é‡è¦æŒ‡æ ‡ã€‚è¿‡é•¿çš„é˜Ÿåˆ—å¯èƒ½å¯¼è‡´ä»»åŠ¡å †ç§¯ï¼Œå½±å“ç³»ç»Ÿå“åº”é€Ÿåº¦ã€‚

### ç›‘æ§å·¥å…·å’Œæ–¹æ³•

- **æ—¥å¿—ç›‘æ§**ï¼šé€šè¿‡æ—¥å¿—è®°å½•ç³»ç»Ÿçš„å…³é”®æ“ä½œå’Œæ€§èƒ½æŒ‡æ ‡ï¼Œå¦‚è¯·æ±‚å¤„ç†æ—¶é—´ã€æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ç­‰ã€‚æ—¥å¿—å¯ä»¥å¸®åŠ©å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆã€‚
- **å¥åº·æ£€æŸ¥æ¥å£**ï¼šç³»ç»Ÿæä¾›äº†å¥åº·æ£€æŸ¥æ¥å£ `/health`ï¼Œå¯ä»¥å®šæœŸè°ƒç”¨ä»¥æ£€æŸ¥ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ã€‚è¯¥æ¥å£è¿”å›ç³»ç»Ÿçš„ç‰ˆæœ¬å·ã€æ—¶é—´æˆ³å’ŒçŠ¶æ€ä¿¡æ¯ã€‚
- **æ€§èƒ½ç›‘æ§è„šæœ¬**ï¼šä½¿ç”¨æ€§èƒ½ç›‘æ§è„šæœ¬ `test_performance_comparison.py` å¯ä»¥å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½å·®å¼‚ï¼Œå¸®åŠ©è¯„ä¼°ä¼˜åŒ–æ•ˆæœã€‚

```mermaid
graph TD
A[ç³»ç»Ÿæ€§èƒ½ç›‘æ§] --> B[CPUä½¿ç”¨ç‡]
A --> C[å†…å­˜ä½¿ç”¨ç‡]
A --> D[Redisé˜Ÿåˆ—é•¿åº¦]
B --> E[æ—¥å¿—ç›‘æ§]
C --> E
D --> E
E --> F[å¥åº·æ£€æŸ¥æ¥å£]
F --> G[/health]
F --> H[/healthz]
F --> I[/readyz]
```

**Diagram sources **
- [health.py](file://app/routers/health.py#L1-L41)
- [test_performance_comparison.py](file://tests/test_performance_comparison.py#L1-L218)

**Section sources**
- [health.py](file://app/routers/health.py#L1-L41)
- [test_performance_comparison.py](file://tests/test_performance_comparison.py#L1-L218)

## é™æµæœºåˆ¶é…ç½®ä¸è°ƒä¼˜

é™æµæœºåˆ¶æ˜¯é˜²æ­¢ç³»ç»Ÿå› è¿‡åº¦è¯·æ±‚è€Œé™çº§çš„é‡è¦æ‰‹æ®µã€‚ç³»ç»Ÿé€šè¿‡é€Ÿç‡é™åˆ¶å™¨å’Œä¸­é—´ä»¶å®ç°äº†å¤šå±‚æ¬¡çš„é™æµç­–ç•¥ã€‚

### é€Ÿç‡é™åˆ¶å™¨

ç³»ç»Ÿä½¿ç”¨ `RateLimiter` ç±»å®ç°æ»‘åŠ¨çª—å£ç®—æ³•ï¼Œç²¾ç¡®æ§åˆ¶APIè°ƒç”¨é¢‘ç‡ã€‚`RateLimiter` ç±»çš„ä¸»è¦å‚æ•°åŒ…æ‹¬ï¼š

- `max_calls`ï¼šæ—¶é—´çª—å£å†…æœ€å¤§è°ƒç”¨æ¬¡æ•°ã€‚
- `time_window`ï¼šæ—¶é—´çª—å£å¤§å°ï¼ˆç§’ï¼‰ã€‚
- `name`ï¼šé™åˆ¶å™¨åç§°ï¼ˆç”¨äºæ—¥å¿—ï¼‰ã€‚

```python
class RateLimiter:
    def __init__(self, max_calls: int, time_window: float, name: str = "RateLimiter"):
        self.max_calls = max_calls
        self.time_window = time_window
        self.name = name
        self.calls = deque()  # å­˜å‚¨è°ƒç”¨æ—¶é—´æˆ³
        self.lock = asyncio.Lock()  # ç¡®ä¿çº¿ç¨‹å®‰å…¨
```

### ä¸“ç”¨é€Ÿç‡é™åˆ¶å™¨

ç³»ç»Ÿä¸ºä¸åŒçš„æ•°æ®æºæä¾›äº†ä¸“ç”¨çš„é€Ÿç‡é™åˆ¶å™¨ï¼Œå¦‚ `TushareRateLimiter`ã€`AKShareRateLimiter` å’Œ `BaoStockRateLimiter`ã€‚è¿™äº›é™åˆ¶å™¨æ ¹æ®æ•°æ®æºçš„ç‰¹æ€§é…ç½®äº†ä¸åŒçš„é™æµç­–ç•¥ã€‚

```python
class TushareRateLimiter(RateLimiter):
    TIER_LIMITS = {
        "free": {"max_calls": 100, "time_window": 60},
        "basic": {"max_calls": 200, "time_window": 60},
        "standard": {"max_calls": 400, "time_window": 60},
        "premium": {"max_calls": 600, "time_window": 60},
        "vip": {"max_calls": 800, "time_window": 60},
    }
```

### é™æµä¸­é—´ä»¶

ç³»ç»Ÿé€šè¿‡ `RateLimitMiddleware` ä¸­é—´ä»¶å®ç°ç”¨æˆ·çº§å’Œç«¯ç‚¹çº§çš„é€Ÿç‡é™åˆ¶ã€‚ä¸­é—´ä»¶é…ç½®äº†ä¸åŒç«¯ç‚¹çš„é€Ÿç‡é™åˆ¶ï¼Œå¦‚å•è‚¡åˆ†æã€æ‰¹é‡åˆ†æã€è‚¡ç¥¨ç­›é€‰ç­‰ã€‚

```python
class RateLimitMiddleware(BaseHTTPMiddleware):
    def __init__(self, app, default_rate_limit: int = 100):
        super().__init__(app)
        self.default_rate_limit = default_rate_limit
        self.endpoint_limits = {
            "/api/analysis/single": 10,
            "/api/analysis/batch": 5,
            "/api/screening/filter": 20,
            "/api/auth/login": 5,
            "/api/auth/register": 3,
        }
```

### é…ç½®ä¸è°ƒä¼˜

- **è°ƒæ•´é™æµå‚æ•°**ï¼šæ ¹æ®ç³»ç»Ÿçš„å®é™…è´Ÿè½½å’Œæ•°æ®æºçš„é™åˆ¶ï¼Œè°ƒæ•´ `max_calls` å’Œ `time_window` å‚æ•°ã€‚
- **ç›‘æ§é™æµæ•ˆæœ**ï¼šé€šè¿‡æ—¥å¿—å’Œç›‘æ§å·¥å…·ç›‘æ§é™æµæ•ˆæœï¼Œç¡®ä¿é™æµç­–ç•¥ä¸ä¼šå½±å“æ­£å¸¸ä¸šåŠ¡ã€‚
- **åŠ¨æ€è°ƒæ•´**ï¼šåœ¨é«˜è´Ÿè½½æƒ…å†µä¸‹ï¼Œå¯ä»¥åŠ¨æ€è°ƒæ•´é™æµå‚æ•°ï¼Œä»¥å¹³è¡¡ç³»ç»Ÿæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚

```mermaid
classDiagram
class RateLimiter {
+int max_calls
+float time_window
+str name
+deque calls
+asyncio.Lock lock
+__init__(max_calls, time_window, name)
+acquire()
+get_stats()
+reset_stats()
}
class TushareRateLimiter {
+dict TIER_LIMITS
+__init__(tier, safety_margin)
}
class AKShareRateLimiter {
+__init__(max_calls, time_window)
}
class BaoStockRateLimiter {
+__init__(max_calls, time_window)
}
class RateLimitMiddleware {
+int default_rate_limit
+dict endpoint_limits
+__init__(app, default_rate_limit)
+dispatch(request, call_next)
+check_rate_limit(user_id, endpoint)
}
RateLimiter <|-- TushareRateLimiter
RateLimiter <|-- AKShareRateLimiter
RateLimiter <|-- BaoStockRateLimiter
RateLimitMiddleware --> RateLimiter : "uses"
```

**Diagram sources **
- [rate_limiter.py](file://app/core/rate_limiter.py#L1-L229)
- [rate_limit.py](file://app/middleware/rate_limit.py#L1-L177)

**Section sources**
- [rate_limiter.py](file://app/core/rate_limiter.py#L1-L229)
- [rate_limit.py](file://app/middleware/rate_limit.py#L1-L177)

## æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

æ•°æ®åº“æŸ¥è¯¢æ˜¯ç³»ç»Ÿæ€§èƒ½çš„å…³é”®ç¯èŠ‚ã€‚ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢å¯ä»¥æ˜¾è‘—æé«˜ç³»ç»Ÿçš„å“åº”é€Ÿåº¦å’Œå¤„ç†èƒ½åŠ›ã€‚

### ç´¢å¼•ä¼˜åŒ–

- **åˆ›å»ºç´¢å¼•**ï¼šä¸ºå¸¸ç”¨çš„æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œå¦‚è‚¡ç¥¨ä»£ç ã€äº¤æ˜“æ—¥æœŸç­‰ã€‚ç´¢å¼•å¯ä»¥æ˜¾è‘—æé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚
- **å¤åˆç´¢å¼•**ï¼šå¯¹äºå¤šå­—æ®µæŸ¥è¯¢ï¼Œåˆ›å»ºå¤åˆç´¢å¼•å¯ä»¥è¿›ä¸€æ­¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚
- **ç´¢å¼•ç»´æŠ¤**ï¼šå®šæœŸæ£€æŸ¥å’Œç»´æŠ¤ç´¢å¼•ï¼Œç¡®ä¿ç´¢å¼•çš„æœ‰æ•ˆæ€§å’Œæ€§èƒ½ã€‚

```python
async def create_database_indexes(db):
    try:
        basic_info = db["stock_basic_info"]
        await basic_info.create_index([("code", 1), ("source", 1)], unique=True)
        await basic_info.create_index([("industry", 1)])
        await basic_info.create_index([("total_mv", -1)])
        await basic_info.create_index([("pe", 1)])
        await basic_info.create_index([("pb", 1)])

        market_quotes = db["market_quotes"]
        await market_quotes.create_index([("code", 1)], unique=True)
        await market_quotes.create_index([("pct_chg", -1)])
        await market_quotes.create_index([("amount", -1)])
        await market_quotes.create_index([("updated_at", -1)])

        logger.info("âœ… æ•°æ®åº“ç´¢å¼•åˆ›å»ºå®Œæˆ")
    except Exception as e:
        logger.warning(f"âš ï¸ åˆ›å»ºç´¢å¼•å¤±è´¥: {e}")
```

### æ‰¹é‡æ“ä½œ

- **æ‰¹é‡æ’å…¥**ï¼šä½¿ç”¨æ‰¹é‡æ’å…¥æ“ä½œå¯ä»¥æ˜¾è‘—å‡å°‘æ•°æ®åº“çš„I/Oå¼€é”€ï¼Œæé«˜æ’å…¥é€Ÿåº¦ã€‚
- **æ‰¹é‡æ›´æ–°**ï¼šå¯¹äºå¤§é‡æ•°æ®çš„æ›´æ–°æ“ä½œï¼Œä½¿ç”¨æ‰¹é‡æ›´æ–°å¯ä»¥å‡å°‘äº‹åŠ¡å¼€é”€ï¼Œæé«˜æ›´æ–°æ•ˆç‡ã€‚

### æŸ¥è¯¢ä¼˜åŒ–

- **é¿å…å…¨è¡¨æ‰«æ**ï¼šå°½é‡ä½¿ç”¨ç´¢å¼•å­—æ®µè¿›è¡ŒæŸ¥è¯¢ï¼Œé¿å…å…¨è¡¨æ‰«æã€‚
- **å‡å°‘æŸ¥è¯¢å­—æ®µ**ï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“é‡ã€‚
- **ä½¿ç”¨ç¼“å­˜**ï¼šå¯¹äºé¢‘ç¹æŸ¥è¯¢çš„æ•°æ®ï¼Œä½¿ç”¨ç¼“å­˜å¯ä»¥å‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚

```mermaid
graph TD
A[æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–] --> B[ç´¢å¼•ä¼˜åŒ–]
A --> C[æ‰¹é‡æ“ä½œ]
A --> D[æŸ¥è¯¢ä¼˜åŒ–]
B --> E[åˆ›å»ºç´¢å¼•]
B --> F[å¤åˆç´¢å¼•]
B --> G[ç´¢å¼•ç»´æŠ¤]
C --> H[æ‰¹é‡æ’å…¥]
C --> I[æ‰¹é‡æ›´æ–°]
D --> J[é¿å…å…¨è¡¨æ‰«æ]
D --> K[å‡å°‘æŸ¥è¯¢å­—æ®µ]
D --> L[ä½¿ç”¨ç¼“å­˜]
```

**Diagram sources **
- [database.py](file://app/core/database.py#L1-L443)

**Section sources**
- [database.py](file://app/core/database.py#L1-L443)

## ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ç­–ç•¥

ä»»åŠ¡é˜Ÿåˆ—æ˜¯ç³»ç»Ÿå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„æ ¸å¿ƒç»„ä»¶ã€‚åˆç†çš„ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ç­–ç•¥å¯ä»¥æé«˜ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›å’Œä»»åŠ¡å¤„ç†æ•ˆç‡ã€‚

### ä»»åŠ¡é˜Ÿåˆ—ç»“æ„

- **å¾…å¤„ç†é˜Ÿåˆ—**ï¼šå­˜å‚¨å¾…å¤„ç†çš„ä»»åŠ¡ã€‚
- **å¤„ç†ä¸­é˜Ÿåˆ—**ï¼šå­˜å‚¨æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ã€‚
- **å®Œæˆé˜Ÿåˆ—**ï¼šå­˜å‚¨å·²å®Œæˆçš„ä»»åŠ¡ã€‚
- **å¤±è´¥é˜Ÿåˆ—**ï¼šå­˜å‚¨å¤„ç†å¤±è´¥çš„ä»»åŠ¡ã€‚

### å¹¶å‘æ§åˆ¶

- **ç”¨æˆ·å¹¶å‘é™åˆ¶**ï¼šæ¯ä¸ªç”¨æˆ·åœ¨åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€å®šæ•°é‡çš„ä»»åŠ¡ï¼Œé˜²æ­¢ç”¨æˆ·è¿‡åº¦å ç”¨ç³»ç»Ÿèµ„æºã€‚
- **å…¨å±€å¹¶å‘é™åˆ¶**ï¼šç³»ç»Ÿåœ¨åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€å®šæ•°é‡çš„ä»»åŠ¡ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚

```python
class QueueService:
    def __init__(self, redis: Redis):
        self.r = redis
        self.user_concurrent_limit = DEFAULT_USER_CONCURRENT_LIMIT
        self.global_concurrent_limit = GLOBAL_CONCURRENT_LIMIT
        self.visibility_timeout = VISIBILITY_TIMEOUT_SECONDS
```

### ä¼˜å…ˆçº§è®¾ç½®

- **ä»»åŠ¡ä¼˜å…ˆçº§**ï¼šä¸ºä¸åŒç±»å‹çš„ä»»åŠ¡è®¾ç½®ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œç¡®ä¿é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¼˜å…ˆå¤„ç†ã€‚
- **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½å’Œä»»åŠ¡ç±»å‹åŠ¨æ€è°ƒæ•´ä»»åŠ¡ä¼˜å…ˆçº§ã€‚

### å¤±è´¥é‡è¯•æœºåˆ¶

- **é‡è¯•æ¬¡æ•°**ï¼šä¸ºæ¯ä¸ªä»»åŠ¡è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé˜²æ­¢æ— é™é‡è¯•å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½ã€‚
- **é‡è¯•é—´éš”**ï¼šè®¾ç½®åˆç†çš„é‡è¯•é—´éš”ï¼Œé¿å…é¢‘ç¹é‡è¯•å¯¹ç³»ç»Ÿé€ æˆå‹åŠ›ã€‚

```python
async def cleanup_expired_tasks(self):
    try:
        timeout_keys = await self.r.keys(VISIBILITY_TIMEOUT_PREFIX + "*")
        current_time = int(time.time())
        expired_tasks = []

        for timeout_key in timeout_keys:
            timeout_data = await self.r.hgetall(timeout_key)
            if timeout_data:
                timeout_at = int(timeout_data.get("timeout_at", 0))
                if current_time > timeout_at:
                    task_id = timeout_data.get("task_id")
                    if task_id:
                        expired_tasks.append(task_id)

        for task_id in expired_tasks:
            await self._handle_expired_task(task_id)

        if expired_tasks:
            logger.warning(f"å¤„ç†äº† {len(expired_tasks)} ä¸ªè¿‡æœŸä»»åŠ¡")
    except Exception as e:
        logger.error(f"æ¸…ç†è¿‡æœŸä»»åŠ¡å¤±è´¥: {e}")
```

```mermaid
classDiagram
class QueueService {
+Redis r
+int user_concurrent_limit
+int global_concurrent_limit
+int visibility_timeout
+__init__(redis)
+enqueue_task(user_id, symbol, params, batch_id)
+dequeue_task(worker_id)
+ack_task(task_id, success)
+create_batch(user_id, symbols, params)
+get_task(task_id)
+get_batch(batch_id)
+stats()
+_check_user_concurrent_limit(user_id)
+_check_global_concurrent_limit()
+_mark_task_processing(task_id, user_id, worker_id)
+_unmark_task_processing(task_id, user_id)
+_set_visibility_timeout(task_id, worker_id)
+_clear_visibility_timeout(task_id)
+get_user_queue_status(user_id)
+cleanup_expired_tasks()
+_handle_expired_task(task_id)
+cancel_task(task_id)
}
class RedisKeys {
+str READY_LIST
+str TASK_PREFIX
+str BATCH_PREFIX
+str SET_PROCESSING
+str SET_COMPLETED
+str SET_FAILED
+str BATCH_TASKS_PREFIX
+str USER_PROCESSING_PREFIX
+str GLOBAL_CONCURRENT_KEY
+str VISIBILITY_TIMEOUT_PREFIX
+int DEFAULT_USER_CONCURRENT_LIMIT
+int GLOBAL_CONCURRENT_LIMIT
+int VISIBILITY_TIMEOUT_SECONDS
}
QueueService --> RedisKeys : "uses"
```

**Diagram sources **
- [queue_service.py](file://app/services/queue_service.py#L1-L364)
- [keys.py](file://app/services/queue/keys.py#L1-L23)

**Section sources**
- [queue_service.py](file://app/services/queue_service.py#L1-L364)
- [keys.py](file://app/services/queue/keys.py#L1-L23)

## å¹¶å‘å¤„ç†ç“¶é¢ˆåˆ†æ

å¹¶å‘å¤„ç†æ˜¯ç³»ç»Ÿæ€§èƒ½çš„å…³é”®å› ç´ ã€‚åˆ†æå¹¶å‘å¤„ç†ç“¶é¢ˆå¯ä»¥å¸®åŠ©ä¼˜åŒ–ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚

### çº¿ç¨‹å®‰å…¨

- **çº¿ç¨‹é”**ï¼šä½¿ç”¨çº¿ç¨‹é”ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚ä¾‹å¦‚ï¼Œ`MemoryStateManager` ç±»ä½¿ç”¨ `threading.Lock` ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚
- **é¿å…å…±äº«çŠ¶æ€**ï¼šå°½é‡é¿å…åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å…±äº«å¯å˜çŠ¶æ€ï¼Œé˜²æ­¢æ•°æ®æ··æ·†ã€‚

```python
class MemoryStateManager:
    def __init__(self):
        self._tasks: Dict[str, TaskState] = {}
        self._lock = threading.Lock()
        self._websocket_manager = None
```

### å¼‚æ­¥å¤„ç†

- **å¼‚æ­¥I/O**ï¼šä½¿ç”¨å¼‚æ­¥I/Oæ“ä½œå¯ä»¥æé«˜ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ `asyncio` å’Œ `aiohttp` è¿›è¡Œå¼‚æ­¥HTTPè¯·æ±‚ã€‚
- **äº‹ä»¶å¾ªç¯**ï¼šç¡®ä¿æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„äº‹ä»¶å¾ªç¯ï¼Œé¿å…äº‹ä»¶å¾ªç¯å†²çªã€‚

```python
try:
    loop = asyncio.get_event_loop()
    if loop.is_closed():
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
except RuntimeError:
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
```

### èµ„æºç®¡ç†

- **è¿æ¥æ± **ï¼šä½¿ç”¨è¿æ¥æ± ç®¡ç†æ•°æ®åº“å’ŒRedisè¿æ¥ï¼Œå‡å°‘è¿æ¥å¼€é”€ã€‚
- **å†…å­˜ç®¡ç†**ï¼šåˆç†ç®¡ç†å†…å­˜ä½¿ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºã€‚

```python
async def init_redis():
    global redis_pool, redis_client

    try:
        redis_pool = redis.ConnectionPool.from_url(
            settings.REDIS_URL,
            max_connections=settings.REDIS_MAX_CONNECTIONS,
            retry_on_timeout=settings.REDIS_RETRY_ON_TIMEOUT,
            decode_responses=True,
            socket_keepalive=True,
            socket_keepalive_options={
                1: 60,
                2: 10,
                3: 3,
            },
            health_check_interval=30,
        )

        redis_client = redis.Redis(connection_pool=redis_pool)
        await redis_client.ping()
        logger.info(f"âœ… Redisè¿æ¥æˆåŠŸå»ºç«‹ (max_connections={settings.REDIS_MAX_CONNECTIONS})")
    except Exception as e:
        logger.error(f"âŒ Redisè¿æ¥å¤±è´¥: {e}")
        raise
```

```mermaid
graph TD
A[å¹¶å‘å¤„ç†ç“¶é¢ˆåˆ†æ] --> B[çº¿ç¨‹å®‰å…¨]
A --> C[å¼‚æ­¥å¤„ç†]
A --> D[èµ„æºç®¡ç†]
B --> E[çº¿ç¨‹é”]
B --> F[é¿å…å…±äº«çŠ¶æ€]
C --> G[å¼‚æ­¥I/O]
C --> H[äº‹ä»¶å¾ªç¯]
D --> I[è¿æ¥æ± ]
D --> J[å†…å­˜ç®¡ç†]
```

**Diagram sources **
- [memory_state_manager.py](file://app/services/memory_state_manager.py#L1-L421)
- [redis_client.py](file://app/core/redis_client.py#L1-L203)

**Section sources**
- [memory_state_manager.py](file://app/services/memory_state_manager.py#L1-L421)
- [redis_client.py](file://app/core/redis_client.py#L1-L203)

## æ€§èƒ½åŸºå‡†æµ‹è¯•æ–¹æ³•

æ€§èƒ½åŸºå‡†æµ‹è¯•æ˜¯è¯„ä¼°ç³»ç»Ÿæ€§èƒ½çš„é‡è¦æ‰‹æ®µã€‚é€šè¿‡åŸºå‡†æµ‹è¯•å¯ä»¥éªŒè¯ä¼˜åŒ–æ•ˆæœï¼Œç¡®ä¿ç³»ç»Ÿåœ¨é«˜è´Ÿè½½ä¸‹çš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚

### æµ‹è¯•å·¥å…·

- **pytest**ï¼šä½¿ç”¨ `pytest` æ¡†æ¶ç¼–å†™å’Œè¿è¡Œæ€§èƒ½æµ‹è¯•ã€‚
- **æ€§èƒ½ç›‘æ§è„šæœ¬**ï¼šä½¿ç”¨æ€§èƒ½ç›‘æ§è„šæœ¬ `test_performance_comparison.py` å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½å·®å¼‚ã€‚

### æµ‹è¯•ç”¨ä¾‹

- **åŸºç¡€æµ‹è¯•**ï¼šæµ‹è¯•ç³»ç»Ÿåœ¨æ­£å¸¸è´Ÿè½½ä¸‹çš„æ€§èƒ½è¡¨ç°ã€‚
- **å‹åŠ›æµ‹è¯•**ï¼šæµ‹è¯•ç³»ç»Ÿåœ¨é«˜è´Ÿè½½ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼Œå¦‚é«˜å¹¶å‘è¯·æ±‚ã€å¤§é‡æ•°æ®å¤„ç†ç­‰ã€‚
- **ç¨³å®šæ€§æµ‹è¯•**ï¼šæµ‹è¯•ç³»ç»Ÿåœ¨é•¿æ—¶é—´è¿è¡Œä¸‹çš„ç¨³å®šæ€§å’Œæ€§èƒ½è¡¨ç°ã€‚

### æµ‹è¯•æŒ‡æ ‡

- **å“åº”æ—¶é—´**ï¼šæµ‹é‡ç³»ç»Ÿå¤„ç†è¯·æ±‚çš„å¹³å‡å“åº”æ—¶é—´ã€‚
- **ååé‡**ï¼šæµ‹é‡ç³»ç»Ÿåœ¨å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚
- **èµ„æºä½¿ç”¨ç‡**ï¼šç›‘æ§CPUã€å†…å­˜ã€ç½‘ç»œç­‰èµ„æºçš„ä½¿ç”¨ç‡ã€‚

### æµ‹è¯•ç»“æœåˆ†æ

- **æ€§èƒ½å¯¹æ¯”**ï¼šå¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½æŒ‡æ ‡ï¼Œè¯„ä¼°ä¼˜åŒ–æ•ˆæœã€‚
- **ç“¶é¢ˆè¯†åˆ«**ï¼šé€šè¿‡æµ‹è¯•ç»“æœè¯†åˆ«ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚

```python
def compare_performance():
    print("=" * 80)
    print("ğŸ“Š åŸºæœ¬é¢åˆ†ææ•°æ®è·å–ç­–ç•¥æ€§èƒ½å¯¹æ¯”æµ‹è¯•")
    print("=" * 80)

    old_results = simulate_old_strategy()
    new_result = test_new_strategy()

    print("\n" + "=" * 80)
    print("ğŸ“ˆ æ€§èƒ½å¯¹æ¯”åˆ†æ")
    print("=" * 80)

    if new_result['success']:
        print(f"\nğŸš€ ä¼˜åŒ–åç­–ç•¥æ€§èƒ½:")
        print(f"   - æ•°æ®é•¿åº¦: {new_result['data_length']:,} å­—ç¬¦")
        print(f"   - å¤„ç†æ—¶é—´: {new_result['processing_time']:.2f}ç§’")
        print(f"   - è¯·æ±‚å¤©æ•°: {new_result['days_requested']}å¤©")

        print(f"\nğŸ“Š ä¸ä¼˜åŒ–å‰å„çº§åˆ«å¯¹æ¯”:")

        successful_old = {k: v for k, v in old_results.items() if v['success']}

        if successful_old:
            old_data_lengths = [v['data_length'] for v in successful_old.values()]
            avg_old_length = sum(old_data_lengths) / len(old_data_lengths)
            max_old_length = max(old_data_lengths)
            min_old_length = min(old_data_lengths)

            print(f"\nğŸ“ æ•°æ®ä¼ è¾“é‡å¯¹æ¯”:")
            print(f"   - ä¼˜åŒ–å‰å¹³å‡: {avg_old_length:,.0f} å­—ç¬¦")
            print(f"   - ä¼˜åŒ–å‰èŒƒå›´: {min_old_length:,} - {max_old_length:,} å­—ç¬¦")
            print(f"   - ä¼˜åŒ–å: {new_result['data_length']:,} å­—ç¬¦")
            print(f"   - æ•°æ®å‡å°‘: {(avg_old_length - new_result['data_length'])/avg_old_length*100:.1f}%")

            old_times = [v['processing_time'] for v in successful_old.values()]
            avg_old_time = sum(old_times) / len(old_times)

            print(f"\nâ±ï¸ å¤„ç†æ—¶é—´å¯¹æ¯”:")
            print(f"   - ä¼˜åŒ–å‰å¹³å‡: {avg_old_time:.2f}ç§’")
            print(f"   - ä¼˜åŒ–å: {new_result['processing_time']:.2f}ç§’")
            print(f"   - æ—¶é—´èŠ‚çœ: {(avg_old_time - new_result['processing_time'])/avg_old_time*100:.1f}%")

            print(f"\nğŸ“‹ è¯¦ç»†å¯¹æ¯”è¡¨:")
            print(f"{'ç­–ç•¥':<25} | {'å¤©æ•°':<4} | {'æ•°æ®é‡(å­—ç¬¦)':<12} | {'æ—¶é—´(ç§’)':<8} | {'çŠ¶æ€'}")
            print("-" * 70)

            for depth, result in old_results.items():
                status = "âœ…" if result['success'] else "âŒ"
                data_len = f"{result['data_length']:,}" if result['success'] else "N/A"
                proc_time = f"{result['processing_time']:.2f}" if result['success'] else "N/A"
                print(f"{result['description']:<25} | {result['days_requested']:<4} | {data_len:<12} | {proc_time:<8} | {status}")

            print("-" * 70)
            data_len = f"{new_result['data_length']:,}"
            proc_time = f"{new_result['processing_time']:.2f}"
            print(f"{'ä¼˜åŒ–åç­–ç•¥':<25} | {new_result['days_requested']:<4} | {data_len:<12} | {proc_time:<8} | âœ…")

            print(f"\nğŸ’¡ ä¼˜åŒ–æ•ˆæœæ€»ç»“:")
            print(f"   âœ… æ•°æ®ä¼ è¾“é‡å¹³å‡å‡å°‘ {(avg_old_length - new_result['data_length'])/avg_old_length*100:.1f}%")
            print(f"   âœ… å¤„ç†æ—¶é—´å¹³å‡èŠ‚çœ {(avg_old_time - new_result['processing_time'])/avg_old_time*100:.1f}%")
            print(f"   âœ… ä¿æŒåŸºæœ¬é¢åˆ†ææ‰€éœ€çš„æ ¸å¿ƒä¿¡æ¯å®Œæ•´æ€§")
            print(f"   âœ… æé«˜äº†æ•°æ®è·å–çš„é’ˆå¯¹æ€§å’Œæ•ˆç‡")
            print(f"   âœ… å‡å°‘äº†ä¸å¿…è¦çš„å†å²ä»·æ ¼æ•°æ®ä¼ è¾“")
    else:
        print(f"âŒ ä¼˜åŒ–åç­–ç•¥æµ‹è¯•å¤±è´¥: {new_result.get('error', 'æœªçŸ¥é”™è¯¯')}")

    print(f"\nğŸ‰ æ€§èƒ½å¯¹æ¯”æµ‹è¯•å®Œæˆï¼")
```

```mermaid
graph TD
A[æ€§èƒ½åŸºå‡†æµ‹è¯•æ–¹æ³•] --> B[æµ‹è¯•å·¥å…·]
A --> C[æµ‹è¯•ç”¨ä¾‹]
A --> D[æµ‹è¯•æŒ‡æ ‡]
A --> E[æµ‹è¯•ç»“æœåˆ†æ]
B --> F[pytest]
B --> G[æ€§èƒ½ç›‘æ§è„šæœ¬]
C --> H[åŸºç¡€æµ‹è¯•]
C --> I[å‹åŠ›æµ‹è¯•]
C --> J[ç¨³å®šæ€§æµ‹è¯•]
D --> K[å“åº”æ—¶é—´]
D --> L[ååé‡]
D --> M[èµ„æºä½¿ç”¨ç‡]
E --> N[æ€§èƒ½å¯¹æ¯”]
E --> O[ç“¶é¢ˆè¯†åˆ«]
```

**Diagram sources **
- [test_performance_comparison.py](file://tests/test_performance_comparison.py#L1-L218)

**Section sources**
- [test_performance_comparison.py](file://tests/test_performance_comparison.py#L1-L218)

## ç»“è®º

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†ç³»ç»Ÿæ€§èƒ½é—®é¢˜çš„ä¼˜åŒ–ä¸æ’æŸ¥æ–¹æ³•ã€‚é€šè¿‡ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ã€é…ç½®å’Œè°ƒä¼˜é™æµæœºåˆ¶ã€ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ã€ç®¡ç†ä»»åŠ¡é˜Ÿåˆ—å’Œåˆ†æå¹¶å‘å¤„ç†ç“¶é¢ˆï¼Œå¯ä»¥æ˜¾è‘—æé«˜ç³»ç»Ÿçš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚æ€§èƒ½åŸºå‡†æµ‹è¯•æ–¹æ³•ä¸ºè¯„ä¼°ä¼˜åŒ–æ•ˆæœæä¾›äº†ç§‘å­¦ä¾æ®ã€‚å¸Œæœ›æœ¬æ–‡æ¡£èƒ½å¸®åŠ©ç”¨æˆ·æœ‰æ•ˆè§£å†³ç³»ç»Ÿæ€§èƒ½é—®é¢˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚