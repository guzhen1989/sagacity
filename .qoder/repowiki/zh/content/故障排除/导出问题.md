# 导出问题

<cite>
**本文档引用文件**   
- [export-issues.md](file://docs/troubleshooting/export-issues.md)
- [pdf_word_export_issues.md](file://docs/troubleshooting/pdf_word_export_issues.md)
- [report_exporter.py](file://app/utils/report_exporter.py)
- [reports.py](file://app/routers/reports.py)
- [Dockerfile.backend](file://Dockerfile.backend)
- [docker-compose.yml](file://docker-compose.yml)
- [test_conversion.py](file://tests/test_conversion.py)
- [install_pandoc.py](file://scripts/install_pandoc.py)
- [install_pdf_tools.py](file://scripts/install_pdf_tools.py)
- [test_docker_export.sh](file://scripts/test_docker_export.sh)
</cite>

## 目录
1. [问题概述](#问题概述)
2. [依赖安装与环境配置](#依赖安装与环境配置)
3. [环境完整性验证](#环境完整性验证)
4. [错误日志分析](#错误日志分析)
5. [备用导出方案与格式兼容性](#备用导出方案与格式兼容性)
6. [附录](#附录)

## 问题概述

本指南旨在解决TradingAgents-CN系统中PDF/Word报告导出功能的常见问题，包括导出失败、格式错乱、缺少依赖等。系统支持多种导出格式，包括Markdown、JSON、Word（DOCX）和PDF。

导出功能的核心实现位于`app/utils/report_exporter.py`文件中，通过`ReportExporter`类提供统一的导出接口。该类依赖于多个第三方库和系统工具，包括pandoc、pdfkit、wkhtmltopdf等。导出功能通过`app/routers/reports.py`中的API路由暴露给前端，用户可以通过下载接口获取不同格式的报告。

常见问题包括：
- **Pandoc未安装**：导致Word和PDF导出功能不可用
- **字体缺失**：导致PDF中中文显示为方块或乱码
- **Docker环境中缺少图形库**：导致PDF生成失败
- **YAML解析错误**：由于Markdown内容中的特殊字符导致
- **中文竖排显示**：Pandoc在处理中文内容时可能错误地应用竖排样式

**Section sources**
- [export-issues.md](file://docs/troubleshooting/export-issues.md#L1-L337)
- [pdf_word_export_issues.md](file://docs/troubleshooting/pdf_word_export_issues.md#L1-L246)
- [report_exporter.py](file://app/utils/report_exporter.py#L1-L669)

## 依赖安装与环境配置

### Windows环境

在Windows环境下，需要安装以下依赖：

1. **Pandoc**：
   ```bash
   # 使用Chocolatey安装
   choco install pandoc
   
   # 或使用winget安装
   winget install JohnMacFarlane.Pandoc
   ```

2. **PDF工具**：
   ```bash
   # 使用Chocolatey安装wkhtmltopdf
   choco install wkhtmltopdf
   
   # 或使用winget安装
   winget install wkhtmltopdf.wkhtmltopdf
   ```

3. **Python依赖**：
   ```bash
   pip install pypandoc markdown pdfkit
   ```

### Linux环境

在Linux环境下，使用系统包管理器安装依赖：

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y pandoc wkhtmltopdf fonts-noto-cjk
pip install pypandoc markdown pdfkit

# CentOS/RHEL
sudo yum install -y pandoc wkhtmltopdf google-noto-cjk-fonts
pip install pypandoc markdown pdfkit
```

### Docker环境

Docker环境已经预配置了所有必需的依赖。`Dockerfile.backend`文件中包含了完整的依赖安装步骤：

```dockerfile
# 安装系统依赖
RUN apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    fontconfig \
    fonts-noto-cjk \
    wget \
    xvfb && \
    # 下载并安装pandoc
    wget -q https://github.com/jgm/pandoc/releases/download/3.8.2.1/pandoc-3.8.2.1-1-${PANDOC_ARCH}.deb && \
    dpkg -i pandoc-3.8.2.1-1-${PANDOC_ARCH}.deb && \
    rm pandoc-3.8.2.1-1-${PANDOC_ARCH}.deb && \
    # 下载并安装wkhtmltopdf
    wget -q https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6.1-3/wkhtmltox_0.12.6.1-3.bookworm_${WKHTMLTOPDF_ARCH}.deb && \
    apt-get install -y --no-install-recommends ./wkhtmltox_0.12.6.1-3.bookworm_${WKHTMLTOPDF_ARCH}.deb && \
    rm wkhtmltox_0.12.6.1-3.bookworm_${WKHTMLTOPDF_ARCH}.deb && \
    # 更新字体缓存
    fc-cache -fv
```

Docker Compose配置文件`docker-compose.yml`中定义了后端服务的完整配置，包括端口映射、卷挂载和环境变量。

**Section sources**
- [Dockerfile.backend](file://Dockerfile.backend#L1-L89)
- [docker-compose.yml](file://docker-compose.yml#L1-L209)
- [install_pandoc.py](file://scripts/install_pandoc.py#L1-L202)
- [install_pdf_tools.py](file://scripts/install_pdf_tools.py#L1-L251)

## 环境完整性验证

### 依赖检查

使用以下命令验证环境完整性：

```bash
# 检查Python包
pip list | grep -E "(pandoc|docx|pypandoc|pdfkit)"

# 检查系统工具
which pandoc
which wkhtmltopdf

# 检查中文字体
fc-list :lang=zh
```

### 基础转换测试

运行测试脚本验证基础转换功能：

```bash
# 基础转换测试
python test_conversion.py

# 实际数据转换测试
python test_real_conversion.py

# 现有报告转换测试
python test_existing_reports.py
```

### Docker环境测试

使用`scripts/test_docker_export.sh`脚本测试Docker环境中的导出功能：

```bash
# 运行Docker导出测试
./scripts/test_docker_export.sh
```

该脚本会检查容器状态、pandoc安装、wkhtmltopdf安装、中文字体和Python依赖，并提供详细的测试总结。

### API端点测试

通过API端点测试导出功能：

```bash
# 测试Word导出
curl -X GET "http://localhost:8000/api/reports/{report_id}/download?format=docx" -o report.docx

# 测试PDF导出
curl -X GET "http://localhost:8000/api/reports/{report_id}/download?format=pdf" -o report.pdf

# 测试Markdown导出
curl -X GET "http://localhost:8000/api/reports/{report_id}/download?format=markdown" -o report.md
```

**Section sources**
- [test_conversion.py](file://tests/test_conversion.py#L1-L252)
- [test_docker_export.sh](file://scripts/test_docker_export.sh#L1-L133)
- [report_exporter.py](file://app/utils/report_exporter.py#L1-L669)

## 错误日志分析

### 日志收集

遇到问题时，请收集以下信息：

```bash
# 收集错误日志
docker logs TradingAgents-web --tail 100 > error.log

# 收集系统信息
docker exec TradingAgents-web python --version
docker exec TradingAgents-web pandoc --version
docker --version
docker-compose --version

# 收集测试结果
docker exec TradingAgents-web python test_conversion.py > test_result.log 2>&1
```

### 常见错误及解决方案

#### Pandoc未安装

**错误信息**：
```
Pandoc不可用，无法生成Word文档。请安装pandoc或使用Markdown格式导出。
```

**解决方案**：
- 安装pandoc：`pip install pypandoc`
- 或使用系统包管理器安装

#### PDF引擎缺失

**错误信息**：
```
PDF生成失败，最后错误: wkhtmltopdf not found
```

**解决方案**：
- 安装wkhtmltopdf：`sudo apt-get install wkhtmltopdf`（Linux）
- 或使用Chocolatey：`choco install wkhtmltopdf`（Windows）

#### 中文显示问题

**错误现象**：
- PDF中中文字符显示为空白或方块
- 布局错乱

**解决方案**：
- 确保安装了中文字体：`sudo apt-get install fonts-noto-cjk`
- 重新构建Docker镜像

#### YAML解析错误

**错误信息**：
```
Pandoc died with exitcode "64" during conversion: YAML parse exception
```

**解决方案**：
- 使用`--from=markdown-yaml_metadata_block`参数禁用YAML解析
- 清理Markdown内容中的特殊字符

### 诊断工具

使用以下命令进行系统诊断：

```bash
# 查看容器状态
docker-compose ps

# 查看日志
docker logs TradingAgents-web --tail 50

# 检查磁盘空间
docker exec TradingAgents-web df -h

# 验证依赖
docker exec TradingAgents-web pip list | grep -E "(pandoc|docx|pypandoc)"
docker exec TradingAgents-web which pandoc
docker exec TradingAgents-web which wkhtmltopdf
```

**Section sources**
- [export-issues.md](file://docs/troubleshooting/export-issues.md#L1-L337)
- [pdf_word_export_issues.md](file://docs/troubleshooting/pdf_word_export_issues.md#L1-L246)
- [report_exporter.py](file://app/utils/report_exporter.py#L1-L669)

## 备用导出方案与格式兼容性

### 备用导出方案

当主要导出方案失败时，可以使用以下备用方案：

1. **Markdown导出**：无需额外依赖，始终可用
2. **JSON导出**：包含完整数据，可用于后续处理
3. **多引擎PDF生成**：系统会自动尝试多个PDF引擎

```python
# PDF引擎优先级
pdf_engines = [
    ('wkhtmltopdf', 'HTML转PDF引擎，推荐安装'),
    ('weasyprint', '现代HTML转PDF引擎'),
    (None, '使用pandoc默认引擎')
]
```

### 格式兼容性建议

#### Word文档（DOCX）

- 使用pandoc转换，支持丰富的格式
- 后处理修复文本方向问题
- 推荐用于需要编辑的场景

#### PDF文档

- 支持多种引擎，优先使用wkhtmltopdf
- 内置CSS样式控制表格分页和文本方向
- 推荐用于分发和打印

#### Markdown文档

- 纯文本格式，兼容性最好
- 可在任何文本编辑器中查看
- 推荐用于快速查看和版本控制

#### JSON文档

- 包含完整数据结构
- 可用于程序化处理
- 推荐用于数据交换和API集成

### 性能优化

1. **内存不足**：
   ```yaml
   # docker-compose.yml
   services:
     web:
       deploy:
         resources:
           limits:
             memory: 2G
   ```

2. **磁盘空间**：
   ```bash
   # 清理临时文件
   docker exec TradingAgents-web find /tmp -name "*.docx" -delete
   docker exec TradingAgents-web find /tmp -name "*.pdf" -delete
   ```

**Section sources**
- [export-issues.md](file://docs/troubleshooting/export-issues.md#L1-L337)
- [pdf_word_export_issues.md](file://docs/troubleshooting/pdf_word_export_issues.md#L1-L246)
- [report_exporter.py](file://app/utils/report_exporter.py#L1-L669)

## 附录

### 常见解决方案总结

| 问题类型 | 快速解决方案 | 详细方案 |
|---------|------------|---------|
| YAML解析错误 | 重启Web服务 | 检查代码修复 |
| PDF引擎缺失 | 使用Docker环境 | 手动安装引擎 |
| 中文显示问题 | 使用Docker环境 | 安装中文字体 |
| 文件损坏 | 重新生成 | 重建Docker镜像 |
| 内存不足 | 重启容器 | 增加内存限制 |
| 网络超时 | 检查网络 | 增加超时设置 |

### 预防措施

1. **定期更新**：
   ```bash
   git pull origin develop
   docker-compose pull
   ```

2. **监控资源**：
   ```bash
   docker stats TradingAgents-web
   ```

3. **备份配置**：
   ```bash
   cp .env .env.backup
   ```

### 环境重置

如果问题持续存在，可以尝试完全重置环境：

```bash
# 1. 停止所有服务
docker-compose down

# 2. 清理Docker资源
docker system prune -f

# 3. 重新构建镜像
docker build -t tradingagents-cn:latest . --no-cache

# 4. 重新启动服务
docker-compose up -d

# 5. 验证功能
docker exec TradingAgents-web python test_conversion.py
```